<!DOCTYPE html>
<html lang="tr" dir="ltr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Sipari≈ülerim ‚Ä¢ √úreten Eller</title>
  <link rel="icon" href="/assets/icons/favicon.png" />
  <style>
    :root{
      --bg1:#0b1220; --bg2:#0a0f1c; --ink:#e5e7eb; --muted:#9ca3af; --accent:#22d3ee;
      --brd:#1f2937; --card:#0e172a; --card2:#0b1326; --ok:#10b981; --warn:#f59e0b; --err:#ef4444; --info:#3b82f6;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:radial-gradient(1200px 600px at 20% -10%,#10213f22,transparent),linear-gradient(180deg,var(--bg1),var(--bg2));color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,'Noto Sans',sans-serif;max-width:100%;overflow-x:hidden}
    a{color:inherit;text-decoration:none}

    .wrap{max-width:1280px;margin:0 auto;padding:1rem 1rem 6rem}
    .top{display:flex;align-items:center;gap:.75rem;flex-wrap:wrap}
    .logo{display:flex;align-items:center;gap:.5rem;font-weight:900;letter-spacing:.2px}
    .logo img{width:32px;height:32px}
    .spacer{flex:1}
    .btn{display:inline-flex;align-items:center;gap:.4rem;padding:.55rem .9rem;border:1px solid var(--brd);border-radius:12px;background:#0b1220;color:var(--ink);font-weight:800;cursor:pointer}
    .btn.ghost{background:transparent}
    .btn.primary{background:linear-gradient(90deg,var(--info),#8b5cf6);border-color:transparent}
    .btn.danger{background:linear-gradient(180deg,#ef4444,#7a1b1b);border-color:#7a1b1b}
    select.lang{background:#0b1220;border:1px solid var(--brd);color:#e5e7eb;border-radius:10px;padding:.45rem .65rem}

    .head{display:flex;align-items:center;justify-content:space-between;margin:1rem 0 .6rem;gap:.6rem;flex-wrap:wrap}
    .mini{color:var(--muted)}

    .grid{display:grid;gap:.85rem;grid-template-columns:repeat(1,minmax(0,1fr))}
    @media(min-width:920px){.grid{grid-template-columns:repeat(2,1fr)}}
    @media(min-width:1280px){.grid{grid-template-columns:repeat(3,1fr)}}

    .card{border:1px solid var(--brd);border-radius:16px;background:linear-gradient(145deg,var(--card),var(--card2));overflow:hidden}
    .pad{padding:.85rem}
    .row{display:flex;gap:.5rem;align-items:center;flex-wrap:wrap}
    .kv{display:flex;gap:.5rem;align-items:center}
    .kv label{width:120px;color:var(--muted)}
    .kv strong{font-weight:800}
    .title{font-weight:900}
    .badge{display:inline-flex;align-items:center;gap:.35rem;padding:.22rem .55rem;border-radius:999px;border:1px solid var(--brd);font-size:.78rem}
    .unseen{border:1px solid var(--info); box-shadow:0 0 0 1px #1f4cff22}

    .orderHead{display:grid;grid-template-columns:28px 88px 1fr auto;gap:.75rem;align-items:center}
    .chk{width:18px;height:18px}
    .img{width:88px;height:88px;border-radius:10px;background:#0b1220;border:1px solid var(--brd);background-size:cover;background-position:center}

    .toast{position:fixed;left:50%;bottom:72px;transform:translateX(-50%);background:#0b1220;border:1px solid var(--brd);padding:.5rem .75rem;border-radius:10px;font-weight:800;z-index:1300;display:none}
  </style>
  <script type="module" src="./firebase-init.js"></script>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="logo">
        <img src="./√ºreteneller.png" alt="logo" />
        <span id="brandTxt">√úreten Eller</span>
      </div>
      <div class="spacer"></div>
      <select id="langSel" class="lang" aria-label="Dil">
        <option value="tr">T√ºrk√ße</option>
        <option value="en">English</option>
        <option value="ar">ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</option>
        <option value="de">Deutsch</option>
      </select>
      <button id="homeBtn" class="btn ghost">Ana Sayfa</button>
    </div>

    <section class="head" aria-labelledby="pTitle">
      <h2 id="pTitle">Sipari≈ülerim</h2>
      <div class="row" style="gap:.5rem">
        <button id="btnBulkDelete" class="btn danger">üóëÔ∏è Se√ßili Sipari≈üleri Sil</button>
      </div>
      <div class="row mini"><span id="countText">G√∂r√ºlmemi≈ü 0</span></div>
    </section>

    <section style="margin-top:.6rem">
      <div id="list" class="grid"></div>
    </section>

    <audio id="ding" src="./notify.wav" preload="auto"></audio>
    <div id="toast" class="toast" role="status"></div>
  </div>

  <script>
  // ========= I18N =========
  const I18N={
    tr:{title:'Sipari≈ülerim ‚Ä¢ √úreten Eller',brand:'√úreten Eller',home:'Ana Sayfa',orders:'Sipari≈ülerim',bulk:'üóëÔ∏è Se√ßili Sipari≈üleri Sil',
        none:'Kayƒ±t yok.', total:'Toplam', unseen:'G√∂r√ºlmemi≈ü', detail:'Detay', reply:'Cevap Yaz',
        order:'Sipari≈ü', listing:'ƒ∞lan', buyer:'Alƒ±cƒ±', note:'M√º≈üteri Notu',
        new:'Yeni', paid:'√ñdendi', shipped:'Kargoda', done:'Tamamlandƒ±', canceled:'ƒ∞ptal',
        deleted:'Silindi', deleted_ok:'Se√ßili sipari≈üler silindi', login_needed:'L√ºtfen giri≈ü yapƒ±n.'},
    en:{title:'My Orders ‚Ä¢ Ureten Eller',brand:'Ureten Eller',home:'Home',orders:'My Orders',bulk:'üóëÔ∏è Delete Selected',
        none:'No records.', total:'Total', unseen:'Unseen', detail:'Details', reply:'Reply',
        order:'Order', listing:'Listing', buyer:'Buyer', note:'Customer Note',
        new:'New', paid:'Paid', shipped:'Shipped', done:'Completed', canceled:'Canceled',
        deleted:'Deleted', deleted_ok:'Selected orders deleted', login_needed:'Please sign in.'},
    de:{title:'Bestellungen ‚Ä¢ Ureten Eller',brand:'Ureten Eller',home:'Startseite',orders:'Bestellungen',bulk:'üóëÔ∏è Ausgew√§hlte l√∂schen',
        none:'Keine Eintr√§ge.', total:'Gesamt', unseen:'Ungelesen', detail:'Details', reply:'Antworten',
        order:'Bestellung', listing:'Anzeige', buyer:'K√§ufer', note:'Kundennotiz',
        new:'Neu', paid:'Bezahlt', shipped:'Versendet', done:'Abgeschlossen', canceled:'Storniert',
        deleted:'Gel√∂scht', deleted_ok:'Ausgew√§hlte Bestellungen gel√∂scht', login_needed:'Bitte anmelden.'},
    ar:{title:'ÿ∑ŸÑÿ®ÿßÿ™Ÿä ‚Ä¢ Ureten Eller',brand:'Ureten Eller',home:'ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©',orders:'ÿ∑ŸÑÿ®ÿßÿ™Ÿä',bulk:'üóëÔ∏è ÿ≠ÿ∞ŸÅ ÿßŸÑŸÖÿ≠ÿØÿØ',
        none:'ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ≥ÿ¨ŸÑÿßÿ™.', total:'ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä', unseen:'ÿ∫Ÿäÿ± ŸÖŸÇÿ±Ÿàÿ°', detail:'ÿ™ŸÅÿßÿµŸäŸÑ', reply:'ÿ±ÿØ',
        order:'ÿ∑ŸÑÿ®', listing:'ÿ•ÿπŸÑÿßŸÜ', buyer:'ÿßŸÑŸÖÿ¥ÿ™ÿ±Ÿä', note:'ŸÖŸÑÿßÿ≠ÿ∏ÿ© ÿßŸÑÿπŸÖŸäŸÑ',
        new:'ÿ¨ÿØŸäÿØ', paid:'ŸÖÿØŸÅŸàÿπ', shipped:'ÿ™ŸÖ ÿßŸÑÿ¥ÿ≠ŸÜ', done:'ŸÖŸÉÿ™ŸÖŸÑ', canceled:'ŸÖŸÑÿ∫Ÿä',
        deleted:'ŸÖÿ≠ÿ∞ŸàŸÅ', deleted_ok:'ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿßŸÑÿ∑ŸÑÿ®ÿßÿ™ ÿßŸÑŸÖÿ≠ÿØÿØÿ©', login_needed:'Ÿäÿ±ÿ¨Ÿâ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ.'}
  };
  const LANG_KEY='ue_lang_v1';
  function getLang(){ try{ return localStorage.getItem(LANG_KEY)||'tr'; }catch{return 'tr'} }
  function setLang(l){ try{ localStorage.setItem(LANG_KEY,l);}catch{} applyI18n(); }
  function t(k){ const d=I18N[getLang()]||I18N.tr; return d[k]??k; }
  function applyI18n(){
    document.title=t('title');
    document.getElementById('brandTxt').textContent=t('brand');
    document.getElementById('homeBtn').textContent=t('home');
    document.getElementById('pTitle').textContent=t('orders');
    document.getElementById('btnBulkDelete').textContent=t('bulk');
    renderFromBag(__bag); // metinler g√ºncellensin
  }

  // ========= Helpers =========
  const $=(s)=>document.querySelector(s);
  function toast(msg){ const t=$('#toast'); t.textContent=msg; t.style.display='block'; clearTimeout(window.__t); window.__t=setTimeout(()=>{t.style.display='none'},1600); }
  function fmtTL(v){ try{ return new Intl.NumberFormat(getLang()==='tr'?'tr-TR':'en-US',{style:'currency',currency:'TRY',maximumFractionDigits:0}).format(v||0);}catch{ return (v||0)+' TL'; } }
  function fmtDate(x){ try{ if(x?.toMillis) return new Date(x.toMillis()).toLocaleString(getLang()==='tr'?'tr-TR':undefined); const d=new Date(x); if(!isNaN(d)) return d.toLocaleString(getLang()==='tr'?'tr-TR':undefined); }catch{} return '‚Äî'; }
  function digits(x){ return String(x||'').replace(/\D/g,''); }
  function playDing(){ const a=$('#ding'); if(a){ a.currentTime=0; a.play().catch(()=>{}); } }

  // ========= Nav / Lang =========
  $('#homeBtn').onclick=()=>{ location.href='/home.html'; };
  const langSel=$('#langSel'); langSel.value=getLang(); langSel.onchange=(e)=>setLang(e.target.value);

  // ========= Firestore utils / caches =========
  const ensure=()=> new Promise(r=>{ if(window.__fb?.db && window.__fb?.auth){ r(); } else { document.addEventListener('fb-ready',r,{once:true}); }});
  const userCache=new Map(), listingCache=new Map();

  async function getUser(uid){
    if(!uid) return null; if(userCache.has(uid)) return userCache.get(uid);
    try{
      const { getDoc, doc } = await import('https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js');
      const snap = await getDoc(doc(window.__fb.db,'users',uid));
      const data = snap.exists()? (snap.data()||{}) : null; userCache.set(uid,data); return data;
    }catch{return null}
  }
  async function getListing(listingId){
    if(!listingId) return null; if(listingCache.has(listingId)) return listingCache.get(listingId);
    try{
      const { getDoc, doc } = await import('https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js');
      const snap = await getDoc(doc(window.__fb.db,'listings',listingId));
      const data = snap.exists()? (snap.data()||{}) : null; listingCache.set(listingId,data); return data;
    }catch{return null}
  }
  async function findUserBy(field, value){
    try{
      if(!value) return null;
      const { collection, query, where, limit, getDocs } =
        await import('https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js');
      const q = query(collection(window.__fb.db,'users'), where(field,'==', value), limit(1));
      const ss = await getDocs(q);
      if (ss.empty) return null;
      const docSnap = ss.docs[0];
      return { __id: docSnap.id, ...(docSnap.data()||{}) };
    }catch{ return null; }
  }
  async function resolvePeer(order){
    let uid = order.buyerId || '';
    let user = uid ? await getUser(uid) : null;
    if(!uid){
      const phoneDigits = digits(order.buyerPhone||'');
      user = (await findUserBy('phone', phoneDigits)) || (await findUserBy('email', (order.buyerEmail||'').toLowerCase()));
      uid = user?.__id || '';
    }
    return { uid, user };
  }

  // ========= Render helpers =========
  function statusBadge(s){
    const key = (s||'').toLowerCase();
    const map = { new:t('new'), paid:t('paid'), shipped:t('shipped'), done:t('done'), canceled:t('canceled') };
    const label = map[key] || key || '‚Äî';
    return `<span class="badge">${label}</span>`;
  }
  function cardOrderHTML(id, o, peer, peerUid, listing){
    const title = o.listingTitle || listing?.title || (t('order')+' #'+id);
    const price = (o.price!=null) ? `<div class="mini">${fmtTL(o.price)}</div>` : '';
    const peerName = (peer?.name || peer?.displayName || o.buyerName || '‚Äî').trim();
    const customerNote = (o.note||o.buyerNote||o.orderNote||o.message||'').toString().trim();
    const listingLine = `${(o.listingTitle || listing?.title || '‚Äî')}${o.listingId ? ` (#${o.listingId})` : ''}`;
    const imgSrc = listing?.thumb || listing?.image || '/assets/img/avatar-default.png';
    const chatUrl  = peerUid ? `/docs/mesajlar.html?peer=${encodeURIComponent(peerUid)}&name=${encodeURIComponent(peerName)}&order=${encodeURIComponent(id)}` : '';
    const unseenCls = (o.sellerSeen===false || o.sellerSeen===0 || o.sellerSeen==='no') ? ' unseen' : '';

    return `<div class="card pad${unseenCls}" data-id="${id}">
      <div class="orderHead">
        <input type="checkbox" class="chk" data-id="${id}" />
        <div class="img" style="background-image:url('${imgSrc}')"></div>
        <div>
          <div class="title">${title}</div>
          <div class="mini">${id} ‚Ä¢ ${fmtDate(o.createdAt)}</div>
          ${price}
        </div>
        <div>${statusBadge(o.status)}</div>
      </div>
      <div class="kv" style="margin-top:.45rem"><label>${t('listing')}</label><strong>${listingLine}</strong></div>
      <div class="kv"><label>${t('buyer')}</label><strong>${peerName}</strong></div>
      ${customerNote ? `<div class="kv"><label>${t('note')}</label><strong style="white-space:pre-wrap">${customerNote.replace(/</g,'&lt;').replace(/>/g,'&gt;')}</strong></div>` : ''}
      <div class="row" style="margin-top:.55rem;gap:.5rem">
        <a class="btn" href="/docs/orders.html?id=${id}">${t('detail')}</a>
        ${chatUrl? `<a class="btn primary" href="${chatUrl}">${t('reply')}</a>`:''}
      </div>
    </div>`;
  }

  // ========= State & listener =========
  let stopUnsub=null;
  let firstLoad=true;
  let __bag=new Map(); // id -> row obj

  async function startListener(){
    if(stopUnsub){ stopUnsub(); stopUnsub=null; }
    await ensure();

    const { collection, query, where, limit, onSnapshot } =
      await import('https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js');

    const db = window.__fb.db; const me = window.__fb.auth.currentUser;
    if(!me){ $('#list').innerHTML='<div class="mini">'+t('login_needed')+'</div>'; return; }

    // SADELE≈ûTƒ∞Rƒ∞LDƒ∞: Sadece sellerId == benim UID‚Äôim
    const qBase = query(collection(db,'orders'), where('sellerId','==', me.uid), limit(500));

    stopUnsub = onSnapshot(qBase, async (ss)=>{
      const rows=[];
      let unseen=0;
      for (const d of ss.docs){
        const data=d.data()||{};
        // Silinmi≈üleri client-side ELE
        if((data.status||'').toLowerCase()==='deleted') continue;

        if(data.sellerSeen===false || data.sellerSeen===0 || data.sellerSeen==='no') unseen++;

        const rp = await resolvePeer(data);
        const listing = data.listingId ? await getListing(data.listingId) : null;
        rows.push({ id:d.id, data, peer:rp.user, peerUid:rp.uid, listing, isUnseen: (data.sellerSeen===false || data.sellerSeen===0 || data.sellerSeen==='no') });
      }

      // store unseen badge for profile
      try{ localStorage.setItem('ue_unseen_seller_orders', String(unseen)); }catch{}

      // tarihe g√∂re sƒ±rala (desc)
      rows.sort((a,b)=>{
        const ta = a.data?.createdAt?.toMillis ? a.data.createdAt.toMillis() : (new Date(a.data?.createdAt||0)).getTime();
        const tb = b.data?.createdAt?.toMillis ? b.data.createdAt.toMillis() : (new Date(b.data?.createdAt||0)).getTime();
        return (tb||0) - (ta||0);
      });

      // render
      __bag = new Map(rows.map(r=>[r.id,r]));
      renderFromBag(__bag, unseen);

      // yeni kayƒ±t sesi (ilk y√ºklemede √ßalma)
      if(!firstLoad && ss.docChanges().some(ch=>ch.type==='added')) playDing();
      firstLoad=false;
    }, (err)=>{
      console.error('orders onSnapshot', err);
      $('#list').innerHTML = '<div class="mini">Kayƒ±t okunamadƒ± (izin veya aƒü).</div>';
    });
  }

  function renderFromBag(bagMap, unseenCount){
    const rows = [...bagMap.values()];
    const unseen = unseenCount!=null ? unseenCount : rows.reduce((acc,r)=> acc + (r.isUnseen?1:0), 0);

    const html = rows.map(({id,data,peer,peerUid,listing}) => cardOrderHTML(id,data,peer,peerUid,listing));
    $('#list').innerHTML = html.length ? html.join('') : `<div class="mini">${t('none')}</div>`;
    $('#countText').textContent = html.length ? `${t('total')} ${html.length} ‚Ä¢ ${t('unseen')} ${unseen}` : `${t('unseen')} ${unseen}`;
  }

  // ========= Bulk delete (status:"deleted") =========
  async function bulkDelete(){
    const ids=[...document.querySelectorAll('.chk:checked')].map(i=>i.getAttribute('data-id')).filter(Boolean);
    if(ids.length===0) return;
    try{
      const { doc, updateDoc, serverTimestamp } =
        await import('https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js');
      await ensure();
      const db=window.__fb.db;

      for(const id of ids){
        await updateDoc(doc(db,'orders',id), { status:'deleted', updatedAt: serverTimestamp() });
        __bag.delete(id); // anƒ±nda listeden d√º≈ü√ºr
      }
      renderFromBag(__bag);
      toast(t('deleted_ok'));
    }catch(e){
      console.warn('bulkDelete', e);
      toast('Hata');
    }
  }
  $('#btnBulkDelete').onclick=bulkDelete;

  // ========= Boot =========
  (async()=>{
    applyI18n();
    await ensure();
    const {auth,onAuthStateChanged} = window.__fb;
    onAuthStateChanged(auth, async (u)=>{
      if(!u){ $('#list').innerHTML='<div class="mini">'+t('login_needed')+'</div>'; return; }
      await startListener();
    });
  })();
  </script>
</body>
</html>
