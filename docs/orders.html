<!DOCTYPE html>
<html lang="tr" dir="ltr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title data-i18n="title">Sipari≈ülerim ‚Ä¢ √úreten Eller</title>
  <link rel="icon" href="/assets/icons/favicon.png" />
  <style>
    :root{
      --bg1:#0b1220; --bg2:#0a0f1c; --ink:#e5e7eb; --muted:#9ca3af; --accent:#22d3ee;
      --brd:#1f2937; --card:#0e172a; --card2:#0b1326;
      --ok:#10b981; --warn:#f59e0b; --err:#ef4444; --info:#3b82f6;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:radial-gradient(1200px 600px at 20% -10%,#10213f22,transparent),linear-gradient(180deg,var(--bg1),var(--bg2));color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,'Noto Sans',sans-serif;max-width:100%;overflow-x:hidden}
    a{color:inherit;text-decoration:none}

    .wrap{max-width:1280px;margin:0 auto;padding:1rem 1rem 6rem}
    .top{display:flex;align-items:center;gap:.75rem;flex-wrap:wrap}
    .logo{display:flex;align-items:center;gap:.5rem;font-weight:900;letter-spacing:.2px}
    .logo img{width:32px;height:32px}
    .spacer{flex:1}

    .btn{display:inline-flex;align-items:center;gap:.4rem;padding:.55rem .9rem;border:1px solid var(--brd);border-radius:12px;background:#0b1220;color:var(--ink);font-weight:800;cursor:pointer}
    .btn.ghost{background:transparent}
    .btn.primary{background:linear-gradient(90deg,var(--info),#8b5cf6);border-color:transparent}
    .btn.danger{background:linear-gradient(180deg,#ef4444,#7a1b1b);border-color:#7a1b1b}

    .head{display:grid;grid-template-columns:1fr auto;gap:.75rem;align-items:center;margin:1rem 0 .6rem}
    .filters{display:flex;gap:.5rem;flex-wrap:wrap;align-items:center}
    .input{padding:.55rem .65rem;border:1px solid var(--brd);border-radius:12px;background:#0b1220;color:var(--ink);font:inherit}
    select.input{padding-right:2rem}

    .grid{display:grid;gap:.85rem;grid-template-columns:repeat(1,minmax(0,1fr))}
    @media(min-width:920px){.grid{grid-template-columns:repeat(2,1fr)}}
    @media(min-width:1280px){.grid{grid-template-columns:repeat(3,1fr)}}

    .card{border:1px solid var(--brd);border-radius:16px;background:linear-gradient(145deg,var(--card),var(--card2));overflow:hidden;position:relative}
    .pad{padding:.85rem}
    .row{display:flex;gap:.5rem;align-items:center;flex-wrap:wrap}
    .kv{display:flex;gap:.5rem;align-items:center}
    .kv label{width:120px;color:var(--muted)}
    .kv strong{font-weight:800}
    .title{font-weight:900}
    .mini{color:var(--muted)}
    .badge{display:inline-flex;align-items:center;gap:.35rem;padding:.22rem .55rem;border-radius:999px;border:1px solid var(--brd);font-size:.78rem}
    .unseen{border:1px solid var(--info); box-shadow:0 0 0 1px #1f4cff22}

    .orderHead{display:grid;grid-template-columns:32px 88px 1fr auto;gap:.75rem;align-items:center}
    .img{width:88px;height:88px;border-radius:10px;background:#0b1220;border:1px solid var(--brd);background-size:cover;background-position:center}
    .selBox{display:flex;align-items:center;justify-content:center}
    .selBox input{width:18px;height:18px}

    .toast{position:fixed;left:50%;bottom:72px;transform:translateX(-50%);background:#0b1220;border:1px solid var(--brd);padding:.5rem .75rem;border-radius:10px;font-weight:800;z-index:1300;display:none}
  </style>
  <!-- docs/ altƒ±nda √ßalƒ±≈ütƒ±ƒüƒ± i√ßin baƒüƒ±l yol -->
  <script type="module" src="./firebase-init.js"></script>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="logo">
        <img src="./√ºreteneller.png" alt="logo" />
        <span>√úreten Eller</span>
      </div>
      <div class="spacer"></div>
      <button id="homeBtn" class="btn ghost">Ana Sayfa</button>
    </div>

    <section class="head" aria-labelledby="pTitle">
      <div class="filters">
        <h2 id="pTitle" style="margin:0" data-i18n="title_short">Sipari≈ülerim</h2>
        <div class="mini" id="countText"></div>
      </div>
      <div class="filters">
        <input id="searchInput" class="input" placeholder="ƒ∞lan adƒ± / ID ara‚Ä¶" data-i18n-ph="search_ph" />
        <select id="statusSel" class="input" aria-label="Duruma g√∂re">
          <option value="" data-i18n="status_all">Durum (hepsi)</option>
          <option value="new" data-i18n="status_new">Yeni</option>
          <option value="paid" data-i18n="status_paid">√ñdendi</option>
          <option value="shipped" data-i18n="status_shipped">Kargoda</option>
          <option value="done" data-i18n="status_done">Tamamlandƒ±</option>
          <option value="canceled" data-i18n="status_canceled">ƒ∞ptal</option>
        </select>

        <label class="input" style="display:flex;gap:.5rem;align-items:center;cursor:pointer">
          <input id="selAll" type="checkbox" /> <span data-i18n="select_all">T√ºm√ºn√º Se√ß</span>
        </label>
        <button id="btnBulkDelete" class="btn danger" type="button">üóëÔ∏è <span data-i18n="bulk_delete">Se√ßili Sipari≈üleri Sil</span></button>
      </div>
    </section>

    <section style="margin-top:.6rem">
      <div id="list" class="grid"></div>
    </section>

    <audio id="ding" src="./notify.wav" preload="auto"></audio>
    <div id="toast" class="toast" role="status"></div>
  </div>

  <script>
  /* ================== I18N (TR/EN/DE/AR) ================== */
  const I18N={
    tr:{title:'Sipari≈ülerim ‚Ä¢ √úreten Eller',title_short:'Sipari≈ülerim',search_ph:'ƒ∞lan adƒ± / ID ara‚Ä¶',
        status_all:'Durum (hepsi)',status_new:'Yeni',status_paid:'√ñdendi',status_shipped:'Kargoda',status_done:'Tamamlandƒ±',status_canceled:'ƒ∞ptal',
        card_listing:'ƒ∞lan',card_buyer:'Alƒ±cƒ±',card_note:'M√º≈üteri Notu',btn_detail:'Detay',btn_reply:'Cevap Yaz',
        bulk_delete:'Se√ßili Sipari≈üleri Sil',select_all:'T√ºm√ºn√º Se√ß',
        confirm_delete_many:'Se√ßili sipari≈üler "deleted" olarak i≈üaretlensin mi?',none:'Kayƒ±t yok.',
        toast_ok:'‚úì',toast_err:'Hata',login_needed:'L√ºtfen giri≈ü yapƒ±n.',
        counter_total:'Toplam',counter_unseen:'G√∂r√ºlmemi≈ü',counter_new:'Yeni',home:'Ana Sayfa'},
    en:{title:'My Orders ‚Ä¢ Ureten Eller',title_short:'My Orders',search_ph:'Search listing / ID‚Ä¶',
        status_all:'Status (all)',status_new:'New',status_paid:'Paid',status_shipped:'Shipped',status_done:'Done',status_canceled:'Canceled',
        card_listing:'Listing',card_buyer:'Buyer',card_note:'Customer Note',btn_detail:'Detail',btn_reply:'Reply',
        bulk_delete:'Delete Selected Orders',select_all:'Select All',
        confirm_delete_many:'Mark selected orders as "deleted"?',none:'No records.',
        toast_ok:'‚úì',toast_err:'Error',login_needed:'Please sign in.',
        counter_total:'Total',counter_unseen:'Unseen',counter_new:'New',home:'Home'},
    de:{title:'Bestellungen ‚Ä¢ Ureten Eller',title_short:'Bestellungen',search_ph:'Anzeige / ID suchen‚Ä¶',
        status_all:'Status (alle)',status_new:'Neu',status_paid:'Bezahlt',status_shipped:'Versandt',status_done:'Erledigt',status_canceled:'Storniert',
        card_listing:'Anzeige',card_buyer:'K√§ufer',card_note:'Kundennotiz',btn_detail:'Details',btn_reply:'Antworten',
        bulk_delete:'Ausgew√§hlte Bestellungen l√∂schen',select_all:'Alle ausw√§hlen',
        confirm_delete_many:'Ausgew√§hlte Bestellungen als ‚Äûdeleted‚Äú markieren?',none:'Keine Eintr√§ge.',
        toast_ok:'‚úì',toast_err:'Fehler',login_needed:'Bitte anmelden.',
        counter_total:'Summe',counter_unseen:'Ungelesen',counter_new:'Neu',home:'Startseite'},
    ar:{title:'ÿ∑ŸÑÿ®ÿßÿ™Ÿä ‚Ä¢ Ureten Eller',title_short:'ÿ∑ŸÑÿ®ÿßÿ™Ÿä',search_ph:'ÿßÿ®ÿ≠ÿ´ ŸÅŸä ÿßŸÑÿ•ÿπŸÑÿßŸÜ / ÿßŸÑŸÖÿπÿ±ŸëŸÅ‚Ä¶',
        status_all:'ÿßŸÑÿ≠ÿßŸÑÿ© (ÿßŸÑŸÉŸÑ)',status_new:'ÿ¨ÿØŸäÿØ',status_paid:'ŸÖÿØŸÅŸàÿπ',status_shipped:'ŸÇŸäÿØ ÿßŸÑÿ¥ÿ≠ŸÜ',status_done:'ŸÖŸÉÿ™ŸÖŸÑ',status_canceled:'ŸÖŸÑÿ∫Ÿä',
        card_listing:'ÿßŸÑÿ•ÿπŸÑÿßŸÜ',card_buyer:'ÿßŸÑŸÖÿ¥ÿ™ÿ±Ÿä',card_note:'ŸÖŸÑÿßÿ≠ÿ∏ÿ© ÿßŸÑÿπŸÖŸäŸÑ',btn_detail:'ÿ™ŸÅÿßÿµŸäŸÑ',btn_reply:'ÿ±ÿØ',
        bulk_delete:'ÿ≠ÿ∞ŸÅ ÿßŸÑÿ∑ŸÑÿ®ÿßÿ™ ÿßŸÑŸÖÿ≠ÿØÿØÿ©',select_all:'ÿ™ÿ≠ÿØŸäÿØ ÿßŸÑŸÉŸÑ',
        confirm_delete_many:'Ÿàÿ∂ÿπ ÿπŸÑÿßŸÖÿ© "deleted" ÿπŸÑŸâ ÿßŸÑÿ∑ŸÑÿ®ÿßÿ™ ÿßŸÑŸÖÿ≠ÿØÿØÿ©ÿü',none:'ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ≥ÿ¨ŸÑÿßÿ™.',
        toast_ok:'‚úì',toast_err:'ÿÆÿ∑ÿ£',login_needed:'Ÿäÿ±ÿ¨Ÿâ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ.',
        counter_total:'ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä',counter_unseen:'ÿ∫Ÿäÿ± ŸÖŸÇÿ±Ÿàÿ°',counter_new:'ÿ¨ÿØŸäÿØ',home:'ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©'}
  };
  const LANG_KEY='ue_lang_v1';
  function pickLang(){ try{ const s=localStorage.getItem(LANG_KEY); if(s&&I18N[s]) return s; const n=(navigator.language||'tr').slice(0,2); return I18N[n]?n:'tr'; }catch{return 'tr'} }
  function t(k){ const d=I18N[pickLang()]||I18N.tr; return d[k]||k; }
  function applyI18n(){
    document.title=t('title');
    document.querySelectorAll('[data-i18n]').forEach(n=>{ const k=n.getAttribute('data-i18n'); if(I18N[pickLang()][k]) n.textContent=t(k); });
    const phEl=document.querySelector('[data-i18n-ph="search_ph"]'); if(phEl) phEl.placeholder=t('search_ph');
    document.getElementById('homeBtn').textContent = t('home');
  }

  /* ================== Helpers ================== */
  const $ = (s)=>document.querySelector(s);
  function toast(msg){ const tEl=$('#toast'); if(!tEl) return; tEl.textContent=msg; tEl.style.display='block'; clearTimeout(window.__t); window.__t=setTimeout(()=>{tEl.style.display='none'},1800); }
  function fmtTL(v){ try{ return new Intl.NumberFormat(pickLang()==='tr'?'tr-TR':undefined,{style:'currency',currency:'TRY',maximumFractionDigits:0}).format(v||0);}catch{ return (v||0)+' TL'; } }
  function fmtDate(x){ try{ if(x?.toMillis) return new Date(x.toMillis()).toLocaleString(pickLang()==='tr'?'tr-TR':undefined); const d=new Date(x); if(!isNaN(d)) return d.toLocaleString(pickLang()==='tr'?'tr-TR':undefined); }catch{} return '‚Äî'; }
  function digits(x){ return String(x||'').replace(/\D/g,''); }
  function playDing(){ const a=$('#ding'); if(a){ a.currentTime=0; a.play().catch(()=>{}); } }

  // Nav
  $('#homeBtn').onclick=()=>{ location.href='/home.html'; };

  // Firebase ready
  const ensure=()=> new Promise(r=>{ if(window.__fb?.db && window.__fb?.auth){ r(); } else { document.addEventListener('fb-ready',r,{once:true}); }});

  // State
  let stopUnsub=null;
  let firstLoad=true; // ilk snapshotta ses √ßalma
  const userCache=new Map();
  const listingCache=new Map();
  let selection=new Set(); // se√ßilen order id'leri

  /* ================== Caches ================== */
  async function getUser(uid){
    if(!uid) return null; if(userCache.has(uid)) return userCache.get(uid);
    try{
      const { getDoc, doc } = await import('https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js');
      const snap = await getDoc(doc(window.__fb.db,'users',uid));
      const data = snap.exists()? (snap.data()||{}) : null; userCache.set(uid,data); return data;
    }catch{return null}
  }

  async function getListing(listingId){
    if(!listingId) return null; if(listingCache.has(listingId)) return listingCache.get(listingId);
    try{
      const { getDoc, doc } = await import('https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js');
      const snap = await getDoc(doc(window.__fb.db,'listings',listingId));
      const data = snap.exists()? (snap.data()||{}) : null; listingCache.set(listingId,data); return data;
    }catch{return null}
  }

  // users koleksiyonunda tekil kullanƒ±cƒ± arama (buyerId bo≈ü ise tel/email ile bul)
  async function findUserBy(field, value){
    try{
      if(!value) return null;
      const { collection, query, where, limit, getDocs } =
        await import('https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js');
      const q = query(collection(window.__fb.db,'users'), where(field,'==', value), limit(1));
      const ss = await getDocs(q);
      if (ss.empty) return null;
      const docSnap = ss.docs[0];
      return { __id: docSnap.id, ...(docSnap.data()||{}) };
    }catch(e){ console.warn('findUserBy',e); return null; }
  }

  // Satƒ±cƒ± g√∂r√ºn√ºm√ºnde: alƒ±cƒ±yƒ± √ß√∂z (UID + profil)
  async function resolvePeer(order){
    let uid = order.buyerId || '';
    let user = uid ? await getUser(uid) : null;
    if(!uid){
      const phoneDigits = digits(order.buyerPhone||'');
      user = (await findUserBy('phone', phoneDigits)) || (await findUserBy('email', (order.buyerEmail||'').toLowerCase()));
      uid = user?.__id || '';
    }
    return { uid, user };
  }

  /* ================== UI render ================== */
  function statusBadge(s){
    const map={
      new:t('status_new'), paid:t('status_paid'), shipped:t('status_shipped'),
      done:t('status_done'), canceled:t('status_canceled')
    };
    const label=map[s]||s||'‚Äî';
    return `<span class="badge">${label}</span>`;
  }

  function cardOrderHTML(id, o, peer, peerUid, listing){
    const title = o.listingTitle || listing?.title || o.listingId || 'Sipari≈ü';
    const price = (o.price!=null) ? `<div class="mini">${fmtTL(o.price)}</div>` : '';

    const peerName = (peer?.name || peer?.displayName || o.buyerName || '‚Äî').toString().trim();
    const customerNote = (o.note||o.buyerNote||o.orderNote||o.message||'').toString().trim();

    const listingLine = `${(o.listingTitle || listing?.title || '‚Äî')}${o.listingId ? ` (#${o.listingId})` : ''}`;
    const imgSrc = listing?.thumb || listing?.image || listing?.coverUrl || '/assets/img/avatar-default.png';

    const chatUrl  = peerUid
      ? `/docs/mesajlar.html?peer=${encodeURIComponent(peerUid)}&name=${encodeURIComponent(peerName)}&order=${encodeURIComponent(id)}`
      : '';

    const unseenCls = (o.sellerSeen===false || o.sellerSeen===0 || o.sellerSeen==='no') ? ' unseen' : '';
    const checked = selection.has(id) ? 'checked' : '';

    return `<div class="card pad${unseenCls}" data-id="${id}">
      <div class="orderHead">
        <div class="selBox"><input type="checkbox" data-act="sel" ${checked} aria-label="select ${id}" /></div>
        <div class="img" style="background-image:url('${String(imgSrc).replace(/"/g,'')}')"></div>
        <div>
          <div class="title">${title}</div>
          <div class="mini">${id} ‚Ä¢ ${fmtDate(o.createdAt)}</div>
          ${price}
        </div>
        <div>${statusBadge(o.status)}</div>
      </div>
      <div class="kv" style="margin-top:.45rem"><label>${t('card_listing')}</label><strong>${listingLine}</strong></div>
      <div class="kv"><label>${t('card_buyer')}</label><strong>${peerName}</strong></div>
      ${customerNote ? `<div class="kv"><label>${t('card_note')}</label><strong style="white-space:pre-wrap">${customerNote.replace(/</g,'&lt;').replace(/>/g,'&gt;')}</strong></div>` : ''}
      <div class="row" style="margin-top:.55rem;gap:.5rem">
        <a class="btn" href="/docs/orders.html?id=${id}">${t('btn_detail')}</a>
        ${chatUrl? `<a class="btn primary" href="${chatUrl}">${t('btn_reply')}</a>`:''}
      </div>
    </div>`;
  }

  function renderEmpty(){ $('#list').innerHTML = `<div class="mini">${t('none')}</div>`; $('#countText').textContent=''; }

  /* ================== Live listener ================== */
  async function startListener(){
    if(stopUnsub){ stopUnsub(); stopUnsub=null; }
    await ensure();
    const { collection, query, where, limit, onSnapshot } = await import('https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js');
    const db = window.__fb.db; const me = window.__fb.auth.currentUser;
    if(!me){ $('#list').innerHTML=`<div class="mini">${t('login_needed')}</div>`; return; }

    // Yalnƒ±zca SATICI sipari≈üleri
    const baseQ = query(collection(db,'orders'), where('sellerId','==', me.uid), limit(300));

    stopUnsub = onSnapshot(baseQ, async (ss)=>{
      const term = ($('#searchInput').value||'').toLowerCase().trim();
      const statusFilter = $('#statusSel').value||'';

      const rowsRaw = ss.docs
        .map(d=>({id:d.id,data:d.data()||{}}))
        .filter(x => x.data && x.data.status !== 'deleted'); // silinenler g√∂r√ºnmez

      // ‚Äúyeni‚Äù sayƒ±sƒ± + ‚Äúg√∂r√ºlmemi≈ü‚Äù sayƒ±sƒ±
      const unseen = rowsRaw.reduce((n,x)=> n + ((x.data.sellerSeen===false||x.data.sellerSeen===0||x.data.sellerSeen==='no')?1:0), 0);
      const newCount = rowsRaw.reduce((n,x)=> n + (x.data.status==='new'?1:0), 0);

      // profilde rozet i√ßin localStorage
      try{
        localStorage.setItem('ue_unseen_seller_orders', String(unseen));
        // kullanƒ±cƒ± profili eski anahtarƒ± okuyorsa diye ‚Äúpending‚Äùe de yazalƒ±m
        localStorage.setItem('ue_orders_pending_count', String(newCount));
        localStorage.setItem('ue_orders_new_count', String(newCount));
      }catch{}

      // zenginle≈ütir + sƒ±rala
      const rows = await Promise.all(rowsRaw.map(async x=>{
        const peer = await resolvePeer(x.data);
        const listing = x.data.listingId ? await getListing(x.data.listingId) : null;
        return { id:x.id, data:x.data, peer:peer.user, peerUid:peer.uid, listing };
      }));
      rows.sort((a,b)=>{
        const ta = a.data?.createdAt?.toMillis ? a.data.createdAt.toMillis() : (new Date(a.data?.createdAt||0)).getTime();
        const tb = b.data?.createdAt?.toMillis ? b.data.createdAt.toMillis() : (new Date(b.data?.createdAt||0)).getTime();
        return (tb||0) - (ta||0);
      });

      // filtre
      const items=[];
      rows.forEach(({id,data,peer,peerUid,listing})=>{
        if(term){
          const hay = `${id} ${(data.listingTitle||'')} ${(data.listingId||'')}`.toLowerCase();
          if(!hay.includes(term)) return;
        }
        if(statusFilter && data.status!==statusFilter) return;
        items.push(cardOrderHTML(id,data,peer,peerUid,listing));
      });

      $('#list').innerHTML = items.length ? items.join('') : `<div class="mini">${t('none')}</div>`;
      $('#countText').textContent = items.length
        ? `${t('counter_total')} ${items.length} ‚Ä¢ ${t('counter_unseen')} ${unseen} ‚Ä¢ ${t('counter_new')} ${newCount}`
        : `${t('counter_unseen')} ${unseen}`;

      // Kart i√ßi checkbox eventleri
      document.querySelectorAll('[data-act="sel"]').forEach(cb=>{
        cb.addEventListener('change', (e)=>{
          const card = e.target.closest('.card'); const id = card?.dataset?.id;
          if(!id) return;
          if(e.target.checked){ selection.add(id); } else { selection.delete(id); }
          updateSelAllState();
        });
      });

      // yeni kayƒ±t sesi (ilk y√ºklemede √ßalma yok)
      const hadAdded = ss.docChanges().some(ch=>ch.type==='added' && (ch.doc.data()?.status!=='deleted'));
      if(!firstLoad && hadAdded) playDing();
      firstLoad=false;

      // Select All mevcut filtreye g√∂re √ßalƒ±≈üƒ±r
      document.getElementById('selAll').onclick = (e)=>{
        const checks = Array.from(document.querySelectorAll('[data-act="sel"]'));
        if(e.target.checked){
          checks.forEach(x=>{ x.checked=true; const id=x.closest('.card')?.dataset?.id; if(id) selection.add(id); });
        }else{
          checks.forEach(x=>{ x.checked=false; const id=x.closest('.card')?.dataset?.id; if(id) selection.delete(id); });
        }
      };
      updateSelAllState();
    }, (err)=>{
      console.error(err);
      $('#list').innerHTML = `<div class="mini">${t('none')}</div>`;
    });
  }

  function updateSelAllState(){
    const checks = Array.from(document.querySelectorAll('[data-act="sel"]'));
    const selAll = document.getElementById('selAll');
    const total = checks.length;
    const selCount = checks.filter(x=>x.checked).length;
    selAll.indeterminate = selCount>0 && selCount<total;
    selAll.checked = selCount>0 && selCount===total;
  }

  /* ================== Bulk delete (status:"deleted") ================== */
  async function bulkDelete(){
    if(selection.size===0) return;
    if(!confirm(t('confirm_delete_many'))) return;
    try{
      const { doc, updateDoc, serverTimestamp, writeBatch } =
        await import('https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js');
      const db=window.__fb.db;
      // batch ile hƒ±zlƒ±
      const batch = writeBatch(db);
      selection.forEach(id=>{
        const ref = doc(db,'orders',id);
        batch.update(ref,{ status:'deleted', updatedAt:serverTimestamp(), sellerSeen:true });
      });
      await batch.commit();
      selection.clear();
      document.getElementById('selAll').checked=false;
      updateSelAllState();
      toast(t('toast_ok'));
    }catch(e){ console.warn(e); toast(t('toast_err')); }
  }

  /* ================== UI handlers & Boot ================== */
  document.getElementById('btnBulkDelete').onclick = bulkDelete;
  document.getElementById('statusSel').onchange=()=>startListener();
  document.getElementById('searchInput').addEventListener('input',()=>startListener());

  (async()=>{
    applyI18n();
    await ensure();
    // giri≈ü kontrol√º ve ba≈ülat
    const { onAuthStateChanged } = window.__fb;
    onAuthStateChanged(window.__fb.auth, (u)=>{
      if(!u){ location.href='/docs/index.html'; return; }
      startListener();
    });
  })();
  </script>
</body>
</html>
