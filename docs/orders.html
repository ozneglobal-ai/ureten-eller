<!DOCTYPE html>
<html lang="tr" dir="ltr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Siparişler • Üreten Eller</title>
  <link rel="icon" href="/assets/icons/favicon.png" />
  <style>
    :root{ --bg1:#0b1220; --bg2:#0a0f1c; --ink:#e5e7eb; --muted:#9ca3af; --accent:#22d3ee; --brd:#1f2937; --card:#0e172a; --card2:#0b1326; }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:linear-gradient(180deg,var(--bg1),var(--bg2));color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,'Noto Sans',sans-serif}
    a{color:inherit;text-decoration:none}
    .wrap{max-width:960px;margin:0 auto;padding:1rem 1rem 4rem}
    .top{display:flex;align-items:center;gap:.75rem;flex-wrap:wrap}
    .logo{display:flex;align-items:center;gap:.5rem;font-weight:900}
    .logo img{width:32px;height:32px}
    .spacer{flex:1}
    .btn{display:inline-flex;align-items:center;gap:.4rem;padding:.6rem .9rem;border:1px solid var(--brd);border-radius:12px;background:#0b1220;color:var(--ink);font-weight:800;cursor:pointer}
    .btn.primary{background:linear-gradient(180deg,#10b981,#128473);border-color:#0e766e}
    .btn.warn{background:linear-gradient(180deg,#f59e0b,#7a5408);border-color:#7a5408}
    .btn.ghost{background:transparent}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    .card{border:1px solid var(--brd);border-radius:16px;background:linear-gradient(145deg,var(--card),var(--card2));padding:1rem}
    .list{display:grid;grid-template-columns:1fr;gap:.75rem;margin-top:.75rem}
    @media(min-width:720px){ .list{grid-template-columns:1fr 1fr} }
    .row{display:flex;gap:.6rem;align-items:center;flex-wrap:wrap}
    .kv{display:flex;gap:.5rem;align-items:center;margin:.25rem 0}
    .kv label{width:130px;color:var(--muted)}
    .kv strong{font-weight:800}
    .mini{color:var(--muted)}
    .badge{display:inline-flex;align-items:center;gap:.35rem;padding:.22rem .55rem;border-radius:999px;border:1px solid var(--brd);font-size:.78rem}
    .badge.yellow{background:#241a05;border-color:#7a5408;color:#ffe2a3}
    .badge.green{background:#052315;border-color:#0e766e;color:#9ff6dd}
    .badge.red{background:#2a0b0b;border-color:#7a1b1b;color:#ffb4b4}
    .badge.gray{background:#0a162c;border-color:#334155;color:#cbd5e1}
    .toast{position:fixed;left:50%;bottom:80px;transform:translateX(-50%);background:#0b1220;border:1px solid var(--brd);padding:.5rem .75rem;border-radius:10px;font-weight:800;z-index:1200;display:none}
  </style>
  <!-- Bu dosya /docs/orders.html altında çalışacak; firebase-init.js aynı dizinde -->
  <script type="module" src="./firebase-init.js"></script>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="logo">
        <img src="./üreteneller.png" alt="logo" />
        <span>Üreten Eller</span>
      </div>
      <div class="spacer"></div>
      <button id="btnHome" class="btn ghost" type="button">← Ana sayfa</button>
    </div>

    <h2 id="title">Siparişler</h2>
    <div id="statusBox" class="row" style="margin:.4rem 0"></div>

    <div id="ordersList" class="list"></div>
  </div>

  <div id="toast" class="toast" role="status"></div>

  <script>
    // ==== UTILS ====
    const $=(s)=>document.querySelector(s);
    function toast(msg){ const el=$('#toast'); el.textContent=msg; el.style.display='block'; clearTimeout(window.__to); window.__to=setTimeout(()=>el.style.display='none',1600); }
    const fmtTRY=(v)=>{ try{return new Intl.NumberFormat('tr-TR',{style:'currency',currency:'TRY',maximumFractionDigits:0}).format(v||0);}catch{return v+' TL';} };
    const fmtDate=(x)=>{ try{ if(!x) return '—'; if(x.toDate) return x.toDate().toLocaleString('tr-TR'); if(x.toMillis) return new Date(x.toMillis()).toLocaleString('tr-TR'); const d=new Date(x); return isNaN(d)? '—' : d.toLocaleString('tr-TR'); }catch{return '—';} };

    const inDocs = location.pathname.startsWith('/docs/');
    const base = inDocs ? '/docs' : '';
    $('#btnHome').onclick = ()=>{ location.href = base + '/index.html'; };

    (function wait(){ if(!window.__fb){ return setTimeout(wait,40);} boot(); })();

    async function boot(){
      const {auth,onAuthStateChanged}=window.__fb;
      onAuthStateChanged(auth, async (u)=>{
        if(!u){ location.href = base + '/index.html'; return; }
        try{
          await loadOrders(u.uid);
        }catch(e){ console.error(e); toast('Siparişler yüklenemedi'); }
      });
    }

    async function loadOrders(uid){
      const { collection, getDocs, query, where, orderBy, limit } = await import('https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js');
      const col = collection(window.__fb.db,'orders');

      // Hem alıcı hem satıcı olduğun siparişler; iki sorguyu birleştir
      const qBuyer  = query(col, where('buyerId','==',uid),  orderBy('createdAt','desc'), limit(100));
      const qSeller = query(col, where('sellerId','==',uid), orderBy('createdAt','desc'), limit(100));

      const [sBuyer, sSeller] = await Promise.all([getDocs(qBuyer), getDocs(qSeller)]);

      const map = new Map();
      for (const s of [sBuyer, sSeller]){
        s.forEach(doc=>{ const d=doc.data()||{}; map.set(doc.id,{ id:doc.id, ...d }); });
      }

      const arr = [...map.values()].sort((a,b)=>{
        const ta = a.createdAt?.toMillis ? a.createdAt.toMillis() : (a.createdAt? +new Date(a.createdAt):0);
        const tb = b.createdAt?.toMillis ? b.createdAt.toMillis() : (b.createdAt? +new Date(b.createdAt):0);
        return tb - ta;
      });

      renderOrders(arr, uid);
    }

    function statusBadge(s){
      const text = s==='pending' ? 'Bekliyor' : s==='approved' ? 'Onaylı' : s==='rejected' ? 'Reddedildi' : 'Tamamlandı';
      const cls  = s==='pending' ? 'yellow'   : s==='approved' ? 'green'   : s==='rejected' ? 'red'        : 'gray';
      return `<span class="badge ${cls}">${text}</span>`;
    }

    function renderOrders(list, uid){
      const box = $('#ordersList');
      box.innerHTML = '';
      if(!list.length){
        $('#statusBox').innerHTML = '<span class="mini">Sipariş yok.</span>';
        return;
      }

      const base = location.pathname.startsWith('/docs/') ? '/docs' : '';

      for(const o of list){
        const isSeller = o.sellerId===uid; const isBuyer = o.buyerId===uid;
        const role = isSeller ? 'Satıcı' : isBuyer ? 'Alıcı' : '';
        const card = document.createElement('div');
        card.className='card';
        card.innerHTML = `
          <div class="row" style="justify-content:space-between;align-items:flex-start">
            <div>
              <div class="row" style="gap:.5rem">${statusBadge(o.status||'pending')} <span class="mini">${role}</span></div>
              <div class="kv"><label>İlan</label><strong>${(o.listingTitle||'İlan')}${o.listingId?` (#${String(o.listingId).slice(-6)})`:''}</strong></div>
              <div class="kv"><label>Adet • Tutar</label><strong>${(o.qty||1)} • ${fmtTRY(o.total||0)}</strong></div>
              <div class="kv"><label>Karşı Taraf</label><strong>${ isSeller ? (o.buyerName||'—') : (o.sellerId||'—') }</strong></div>
              <div class="kv"><label>Tarih</label><strong>${fmtDate(o.createdAt)}</strong></div>
            </div>
            <div class="row" style="gap:.5rem">
              <a class="btn" href="${base}/order.html?id=${o.id}">Detay</a>
            </div>
          </div>
        `;
        box.appendChild(card);
      }
    }
  </script>
</body>
</html>
