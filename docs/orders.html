<!DOCTYPE html>
<html lang="tr" dir="ltr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Sipariş • Üreten Eller</title>
  <link rel="icon" href="/assets/icons/favicon.png" />
  <style>
    :root{ --bg1:#0b1220; --bg2:#0a0f1c; --ink:#e5e7eb; --muted:#9ca3af; --accent:#22d3ee; --brd:#1f2937; --card:#0e172a; --card2:#0b1326; }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:linear-gradient(180deg,var(--bg1),var(--bg2));color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,'Noto Sans',sans-serif}
    a{color:inherit;text-decoration:none}
    .wrap{max-width:960px;margin:0 auto;padding:1rem 1rem 4rem}
    .top{display:flex;align-items:center;gap:.75rem;flex-wrap:wrap}
    .logo{display:flex;align-items:center;gap:.5rem;font-weight:900}
    .logo img{width:32px;height:32px}
    .spacer{flex:1}
    .btn{display:inline-flex;align-items:center;gap:.4rem;padding:.6rem .9rem;border:1px solid var(--brd);border-radius:12px;background:#0b1220;color:var(--ink);font-weight:800;cursor:pointer}
    .btn.primary{background:linear-gradient(180deg,#10b981,#128473);border-color:#0e766e}
    .btn.warn{background:linear-gradient(180deg,#f59e0b,#7a5408);border-color:#7a5408}
    .btn.ghost{background:transparent}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    .card{border:1px solid var(--brd);border-radius:16px;background:linear-gradient(145deg,var(--card),var(--card2));padding:1rem}
    .row{display:flex;gap:.6rem;align-items:center;flex-wrap:wrap}
    .kv{display:flex;gap:.5rem;align-items:center;margin:.25rem 0}
    .kv label{width:160px;color:var(--muted)}
    .kv strong{font-weight:800}
    .mini{color:var(--muted)}
    .badge{display:inline-flex;align-items:center;gap:.35rem;padding:.22rem .55rem;border-radius:999px;border:1px solid var(--brd);font-size:.78rem}
    .badge.yellow{background:#241a05;border-color:#7a5408;color:#ffe2a3}
    .badge.green{background:#052315;border-color:#0e766e;color:#9ff6dd}
    .badge.red{background:#2a0b0b;border-color:#7a1b1b;color:#ffb4b4}
    .badge.gray{background:#0a162c;border-color:#334155;color:#cbd5e1}
    .toast{position:fixed;left:50%;bottom:80px;transform:translateX(-50%);background:#0b1220;border:1px solid var(--brd);padding:.5rem .75rem;border-radius:10px;font-weight:800;z-index:1200;display:none}
    input,textarea{width:100%;background:#0a0f1c;border:1px solid var(--brd);border-radius:10px;padding:.55rem .6rem;color:#fff;font:inherit}
  </style>
  <!-- docs/ altında olduğumuz için bağıl yol -->
  <script type="module" src="./firebase-init.js"></script>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="logo">
        <img src="./üreteneller.png" alt="logo" />
        <span>Üreten Eller</span>
      </div>
      <div class="spacer"></div>
      <button id="btnBack" class="btn ghost" type="button">← Siparişler</button>
    </div>

    <h2 id="pageTitle">Sipariş</h2>
    <div id="statusBox" class="row" style="margin:.4rem 0"></div>

    <!-- === LISTING MODU: Sipariş oluşturma formu === -->
    <section id="createBox" class="card" hidden>
      <div class="kv"><label>İlan</label><strong id="cListing">—</strong></div>
      <div class="kv"><label>Satıcı</label><strong id="cSeller">—</strong></div>
      <div class="kv"><label>Birim Fiyat</label><strong id="cPrice">—</strong></div>
      <div class="kv"><label>Adet</label><input id="qtyInput" type="number" value="1" min="1" step="1" style="max-width:140px"/></div>
      <div class="kv"><label>Not (ops.)</label><textarea id="noteInput" rows="3" placeholder="İstediğiniz detaylar"></textarea></div>
      <div class="row" style="justify-content:flex-end;margin-top:.6rem">
        <button id="orderBtn" class="btn primary" type="button">Sipariş Ver</button>
      </div>
    </section>

    <!-- === ORDER MODU: Sipariş detay === -->
    <section id="detailBox" class="card" hidden>
      <div class="kv"><label>İlan</label><strong id="oListing">—</strong></div>
      <div class="kv"><label>Adet • Tutar</label><strong id="oQtyTotal">—</strong></div>
      <div class="kv"><label>Alıcı</label><strong id="oBuyer">—</strong></div>
      <div class="kv"><label>Satıcı</label><strong id="oSeller">—</strong></div>
      <div class="kv"><label>Not</label><strong id="oNote">—</strong></div>
      <div class="kv"><label>Tarih</label><strong id="oCreated">—</strong></div>
      <div id="oActions" class="row" style="justify-content:flex-end;margin-top:.6rem"></div>
    </section>

    <section id="chatBox" class="card" hidden style="margin-top:.8rem">
      <div class="row" style="justify-content:space-between;width:100%">
        <div class="mini">Alıcı ↔ Satıcı Anlık Mesajlaşma</div>
        <div class="row" style="gap:.5rem">
          <button id="btnGoThread" class="btn" type="button">Mesajları Aç</button>
          <button id="btnSendMsg" class="btn primary" type="button">Gönder</button>
        </div>
      </div>
      <div style="margin-top:.6rem">
        <textarea id="msgInput" rows="3" placeholder="Mesaj yazın…"></textarea>
      </div>
    </section>

    <div id="helperBox" class="card" hidden>
      <div class="mini">
        Bu sayfayı iki şekilde açabilirsiniz:
        <ul>
          <li><strong>Sipariş oluşturma:</strong> <code>/docs/order.html?listing=&lt;ILAN_ID&gt;</code></li>
          <li><strong>Sipariş detayı:</strong> <code>/docs/order.html?id=&lt;ORDER_ID&gt;</code></li>
        </ul>
      </div>
    </div>
  </div>

  <div id="toast" class="toast" role="status"></div>

  <script>
    // ==== UTILS ====
    const $=(s)=>document.querySelector(s);
    function toast(msg){ const el=$('#toast'); el.textContent=msg; el.style.display='block'; clearTimeout(window.__to); window.__to=setTimeout(()=>el.style.display='none',1600); }
    const fmtTRY=(v)=>{ try{return new Intl.NumberFormat('tr-TR',{style:'currency',currency:'TRY',maximumFractionDigits:0}).format(v||0);}catch{return v+' TL';} };
    const fmtDate=(x)=>{ try{ if(!x) return '—'; if(x.toDate) return x.toDate().toLocaleString('tr-TR'); if(x.toMillis) return new Date(x.toMillis()).toLocaleString('tr-TR'); const d=new Date(x); return isNaN(d)? '—' : d.toLocaleString('tr-TR'); }catch{return '—';} };

    $('#btnBack').onclick=()=>{ location.href='/docs/orders.html'; };

    const params=new URLSearchParams(location.search);
    const ORDER_ID   = params.get('id') || '';
    const LISTING_ID = params.get('listing') || '';

    (function wait(){ if(!window.__fb){ return setTimeout(wait,40);} boot(); })();

    async function boot(){
      const {auth,onAuthStateChanged}=window.__fb;
      onAuthStateChanged(auth, async (u)=>{
        if(!u){ location.href='./index.html'; return; }

        if (LISTING_ID) {
          // === LISTING MODU
          $('#pageTitle').textContent='Sipariş Oluştur';
          $('#createBox').hidden=false;
          await loadListingForCreate(LISTING_ID, u);
        } else if (ORDER_ID) {
          // === ORDER MODU
          $('#pageTitle').textContent='Sipariş Detayı';
          $('#detailBox').hidden=false;
          $('#chatBox').hidden=false;
          try{
            const order = await loadOrder(ORDER_ID);
            bindActions(order, u.uid);
          }catch(e){
            console.warn(e);
            showHelper('Sipariş bulunamadı veya yetkiniz yok.');
          }
        } else {
          // Parametre yok
          showHelper('Sipariş ID veya İlan ID verilmedi.');
        }
      });
    }

    function showHelper(msg){
      $('#statusBox').innerHTML = `<span class="badge red">${msg}</span>`;
      $('#helperBox').hidden = false;
    }

    // === LISTING -> CREATE ===
    async function loadListingForCreate(listingId, u){
      const { doc, getDoc } = await import('https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js');
      try{
        const ref = doc(window.__fb.db,'listings',listingId);
        const snap=await getDoc(ref);
        if(!snap.exists()){ showHelper('İlan bulunamadı.'); return; }
        const L=snap.data()||{};
        const sellerId = L.sellerId || L.uid || L.userId || L.ownerUid || L.ownerId || L.createdBy || null;
        if(!sellerId){ showHelper('Satıcı bilgisi eksik.'); return; }

        $('#cListing').textContent = (L.title||L.name||'İlan') + ` (#${listingId.slice(-6)})`;
        $('#cSeller').textContent  = sellerId;
        $('#cPrice').textContent   = fmtTRY(L.price||0);

        $('#orderBtn').onclick = ()=> createOrderForListing(listingId, sellerId, L);
      }catch(e){
        console.warn('loadListingForCreate',e);
        showHelper('İlan yüklenemedi.');
      }
    }

    async function createOrderForListing(listingId, sellerId, L){
      try{
        const fb=window.__fb;
        if(!fb?.auth?.currentUser){ toast('Giriş yapın'); return; }
        const uid=fb.auth.currentUser.uid;

        const { doc, getDoc, collection, addDoc, serverTimestamp } =
          await import('https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js');

        // Alıcı profili
        const buyerSnap = await getDoc(doc(fb.db,'users',uid));
        const U = buyerSnap.exists() ? (buyerSnap.data()||{}) : {};

        const qty  = Math.max(1, parseInt($('#qtyInput').value||'1',10));
        const note = ($('#noteInput').value||'').toString().slice(0,500);
        const price= Number(L.price||0);
        const total= Math.max(0, Math.round(price*qty));

        const payload={
          buyerId: uid,                      // RULES gereği şart
          sellerId: sellerId,                // Satıcı paneli sellerId ile dinliyor
          listingId: listingId,
          listingTitle: L.title || L.name || 'İlan',
          listingPrice: price||0,
          buyerName: U.name || fb.auth.currentUser.displayName || '',
          buyerCity: U.city || U.district || '',
          buyerPhone: U.phone || '',
          qty, total, note,
          status:'pending',
          createdAt: serverTimestamp()
        };

        const ordersCol = collection(fb.db,'orders');
        const newRef    = await addDoc(ordersCol, payload);

        // Basit bildirim
        try{
          const notifCol = collection(fb.db,'notifications');
          await addDoc(notifCol,{ to:sellerId, type:'order_new', orderId:newRef.id, text:(U.name||'Bir alıcı')+' yeni sipariş verdi', createdAt: serverTimestamp() });
        }catch{}

        // Detaya yönlendir
        location.href = '/docs/order.html?id='+newRef.id;
      }catch(e){
        console.error('createOrderForListing',e);
        toast('Sipariş oluşturulamadı');
      }
    }

    // === ORDER -> DETAIL ===
    async function loadOrder(id){
      const {doc,getDoc} = await import('https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js');
      const ref=doc(window.__fb.db,'orders',id);
      const snap=await getDoc(ref);
      if(!snap.exists()) throw new Error('no-order');
      const o={ id: snap.id, ...snap.data() };
      paintOrder(o);
      return o;
    }

    function paintOrder(o){
      $('#oListing').textContent = (o.listingTitle||'İlan') + (o.listingId ? ` (#${String(o.listingId).slice(-6)})` : '');
      $('#oQtyTotal').textContent= (o.qty||1)+' • '+fmtTRY(o.total||0);
      $('#oBuyer').textContent   = (o.buyerName||'—') + (o.buyerCity?` • ${o.buyerCity}`:'');
      $('#oSeller').textContent  = o.sellerId||'—';
      $('#oNote').textContent    = o.note||'—';
      $('#oCreated').textContent = fmtDate(o.createdAt);

      const s=(o.status||'pending');
      const box=$('#statusBox'); box.innerHTML='';
      const badge=document.createElement('span'); badge.className='badge '+
        (s==='pending'?'yellow': s==='approved'?'green': s==='rejected'?'red':'gray');
      badge.textContent = s==='pending'?'Bekliyor': s==='approved'?'Onaylı': s==='rejected'?'Reddedildi':'Tamamlandı';
      box.appendChild(badge);
    }

    function bindActions(o, currentUid){
      const acts=$('#oActions'); acts.innerHTML='';
      const isSeller=(currentUid===o.sellerId), isBuyer=(currentUid===o.buyerId);

      if(!(isSeller||isBuyer)){
        const span=document.createElement('span'); span.className='mini'; span.textContent='Bu siparişe erişim yetkiniz yok.';
        acts.append(span);
      }

      if(isSeller && o.status==='pending'){
        const ok=document.createElement('button'); ok.className='btn primary'; ok.textContent='Onayla';
        const no=document.createElement('button'); no.className='btn warn'; no.textContent='İptal';
        ok.onclick=()=>approveOrder(o).catch(e=>{console.warn(e);toast('Hata');});
        no.onclick=()=>updateOrder(o.id,{status:'rejected'}).then(()=>{toast('✓');location.reload();}).catch(()=>toast('Hata'));
        acts.append(ok,no);
      }

      // Chat kutusunu görünür kıl
      $('#chatBox').hidden=false;

      $('#btnGoThread').onclick=()=>{
        const q=new URLSearchParams({ thread:o.threadId||'', order:o.id });
        location.href='/docs/mesajlar.html?'+q.toString();
      };
      $('#btnSendMsg').onclick=()=>sendMessageForOrder(o,currentUid);
    }

    async function updateOrder(id,data){
      const {doc,updateDoc,serverTimestamp}=await import('https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js');
      await updateDoc(doc(window.__fb.db,'orders',id),{...data,updatedAt:serverTimestamp()});
    }

    async function approveOrder(o){
      const {collection,addDoc,doc,updateDoc,serverTimestamp,setDoc}=
        await import('https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js');
      let threadId=o.threadId;
      if(!threadId){
        const thRef=await addDoc(collection(window.__fb.db,'messages'),{
          createdAt:serverTimestamp(),
          participants:[o.sellerId,o.buyerId],
          lastText:'Sipariş onaylandı',
          lastAt:serverTimestamp(),
          orderId:o.id
        });
        threadId=thRef.id;
        await addDoc(collection(window.__fb.db,'messages',threadId,'items'),{createdAt:serverTimestamp(),from:o.sellerId,text:'Sipariş onaylandı',sys:true});
      }
      await updateDoc(doc(window.__fb.db,'orders',o.id),{status:'approved',threadId,updatedAt:serverTimestamp()});
      toast('✓ Onaylandı'); location.reload();
    }

    async function sendMessageForOrder(o,currentUid){
      try{
        const text=($('#msgInput').value||'').trim(); if(!text){ toast('Mesaj boş olamaz'); return; }
        const {collection,addDoc,doc,setDoc,serverTimestamp}=await import('https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js');
        let threadId=o.threadId;
        if(!threadId){
          const thRef=await addDoc(collection(window.__fb.db,'messages'),{
            createdAt:serverTimestamp(),participants:[o.sellerId,o.buyerId],lastText:text.slice(0,120),lastAt:serverTimestamp(),orderId:o.id
          });
          threadId=thRef.id; await setDoc(doc(window.__fb.db,'orders',o.id),{threadId},{merge:true}); o.threadId=threadId;
        }else{
          await setDoc(doc(window.__fb.db,'messages',threadId),{lastText:text.slice(0,120),lastAt:serverTimestamp()},{merge:true});
        }
        await addDoc(collection(window.__fb.db,'messages',threadId,'items'),{createdAt:serverTimestamp(),from:currentUid,text});
        $('#msgInput').value=''; toast('Gönderildi');
      }catch(e){ console.warn('sendMessageForOrder',e); toast('Mesaj gönderilemedi'); }
    }
  </script>
</body>
</html>
