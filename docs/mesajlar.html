<!DOCTYPE html>
<html lang="tr" dir="ltr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mesajlar • Üreten Eller</title>
  <link rel="icon" href="./assets/icons/favicon.png" />
  <style>
    :root{
      --bg1:#0b1220; --bg2:#0a0f1c; --ink:#e5e7eb; --muted:#9ca3af; --accent:#22d3ee;
      --ok:#10b981; --warn:#f59e0b; --err:#ef4444; --brd:#1f2937; --card:#0e172a; --card2:#0b1326
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:linear-gradient(180deg,var(--bg1),var(--bg2));color:var(--ink);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,'Noto Sans',sans-serif;height:100%}
    a{color:inherit;text-decoration:none}
    .app{display:grid;grid-template-columns:320px 1fr;gap:0;height:100vh}

    /* Sidebar */
    .side{border-right:1px solid var(--brd);background:linear-gradient(145deg,var(--card),var(--card2));display:flex;flex-direction:column}
    .sideHead{padding:10px;border-bottom:1px solid var(--brd);display:flex;align-items:center;gap:8px}
    .logo{display:flex;align-items:center;gap:8px;font-weight:900}
    .logo img{width:28px;height:28px}
    .me{margin-left:auto;font-size:12px;color:var(--muted)}
    .search{padding:8px}
    .search input{width:100%;border:1px solid var(--brd);border-radius:10px;background:#0b1326;color:var(--ink);padding:8px 10px}
    .threads{overflow:auto;gap:0}
    .th{display:grid;grid-template-columns:48px 1fr auto;gap:8px;padding:10px;border-bottom:1px solid var(--brd);cursor:pointer;align-items:center}
    .th:hover{background:#0b132633}
    .ava{width:44px;height:44px;border-radius:999px;background:#111827 center/cover no-repeat;border:1px solid var(--brd)}
    .thTitle{font-weight:800}
    .thSub{font-size:12px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:240px}
    .thTime{font-size:12px;color:var(--muted);justify-self:end}
    .empty{padding:12px;color:var(--muted);font-size:14px}

    /* Chat */
    .chat{display:grid;grid-template-rows:auto 1fr auto;min-width:0}
    .chatHead{border-bottom:1px solid var(--brd);padding:10px;display:flex;align-items:center;gap:10px}
    .chatHead .ava{width:36px;height:36px}
    .peerName{font-weight:900}
    .chatActions{margin-left:auto;display:flex;gap:8px}
    .btn{border:1px solid var(--brd);background:#0b1326;color:var(--ink);padding:8px 12px;border-radius:10px;cursor:pointer}
    .btn.warn{background:linear-gradient(180deg,#f59e0b,#7a5408);border-color:#7a5408}
    .btn.danger{background:linear-gradient(180deg,#ef4444,#7a1b1b);border-color:#7a1b1b}
    .btn.ghost{background:transparent}
    .log{padding:12px;overflow:auto}
    .msg{max-width:70%;margin:6px 0;padding:8px 10px;border-radius:12px;background:#0b1326;border:1px solid var(--brd);white-space:pre-wrap}
    .mine{margin-left:auto;background:#072430;border-color:#0e766e}
    .meta{font-size:11px;color:var(--muted);margin-top:2px}
    .composer{display:grid;grid-template-columns:1fr auto;gap:8px;border-top:1px solid var(--brd);padding:10px}
    .composer textarea{background:#0b1326;color:var(--ink);border:1px solid var(--brd);border-radius:12px;padding:10px;min-height:46px;max-height:160px;resize:vertical}
    .composer .btn{font-weight:800;background:var(--accent);color:#03222a;border:none}
    .pill{display:inline-flex;align-items:center;gap:.35rem;padding:.25rem .6rem;border:1px solid var(--brd);border-radius:999px;color:var(--muted);font-size:12px}

    .toast{position:fixed;left:50%;bottom:60px;transform:translateX(-50%);background:#0b1220;border:1px solid var(--brd);padding:.5rem .75rem;border-radius:10px;font-weight:800;z-index:1600;display:none}
    @media (max-width:900px){ .app{grid-template-columns:1fr} .side{display:none} .chat{height:100vh} }
  </style>
  <script type="module" src="./firebase-init.js"></script>
</head>
<body>
  <div class="app">
    <!-- SIDEBAR -->
    <aside class="side">
      <div class="sideHead">
        <div class="logo"><img src="./üreteneller.png" alt="logo"/><span>Mesajlar</span></div>
        <div id="meInfo" class="me">—</div>
      </div>
      <div class="search"><input id="search" placeholder="Kişi/konu ara…" /></div>
      <div id="threads" class="threads">
        <div class="empty">Konuşma yok. Satıcılardan birine mesaj gönderin.</div>
      </div>
    </aside>

    <!-- CHAT -->
    <main class="chat">
      <div class="chatHead">
        <div id="peerAva" class="ava" aria-label="Karşı taraf"></div>
        <div>
          <div id="peerName" class="peerName">Kişi seçin</div>
          <div id="peerMeta" class="pill">—</div>
        </div>
        <div class="chatActions">
          <button id="btnBackMobile" class="btn ghost" style="display:none">← Liste</button>
          <button id="btnDelete" class="btn danger" disabled>Konuşmayı Sil</button>
        </div>
      </div>

      <div id="log" class="log" aria-live="polite"></div>

      <div class="composer">
        <textarea id="msgInput" placeholder="Mesajınızı yazın…" disabled></textarea>
        <button id="sendBtn" class="btn" disabled>Gönder</button>
      </div>
    </main>
  </div>

  <div id="toast" class="toast" role="status"></div>

  <script>
  // ====== UTIL ======
  const $ = (s) => document.querySelector(s);
  const qs = (k) => new URLSearchParams(location.search).get(k) || '';
  function toast(msg){ const el=$('#toast'); if(!el) return; el.textContent=msg; el.style.display='block'; clearTimeout(window.__to); window.__to=setTimeout(()=>el.style.display='none',1600); }
  function fmtDate(ts){ try{ const d=ts?.toDate ? ts.toDate() : (ts? new Date(ts):null); return d? d.toLocaleString('tr-TR'): '—'; }catch{return '—';} }
  const bell = new Audio('./notify.wav');

  // Küfür/hakaret basit filtre (UI tarafı)
  const BAN = ['salak','aptal','gerizekalı','orospu','oç','sikerim','siktir','amk','aq','piç','yarrak','yavşak','şerefsiz','kahpe','fuck','shit'];

  function badText(t){ const x=(t||'').toLowerCase(); return BAN.some(w=>x.includes(w)); }

  // ====== STATE ======
  let __me = null;
  let __threadsUnsub = null;
  let __itemsUnsub = null;
  let __currentThreadId = null;
  let __peerCache = new Map(); // uid -> {name, avatar}

  function ensureFirebaseReady(){
    if(!window.__fb || !window.__fb.db || !window.__fb.auth || !window.__fb.onAuthStateChanged){
      console.error('firebase-init hazır değil');
      toast('Bağlantı kurulamadı (firebase-init).');
      return false;
    }
    return true;
  }

  // ====== FIREBASE DYNAMIC IMPORTS ======
  let fns = {};
  async function api(){
    if(Object.keys(fns).length) return fns;
    const firestore = await import('https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js');
    fns = firestore;
    return fns;
  }

  // ====== USER PROFILE FETCH ======
  async function getUserBrief(uid){
    if(!uid) return {name:'Kullanıcı', avatar:''};
    if(__peerCache.has(uid)) return __peerCache.get(uid);
    try{
      const {doc, getDoc} = await api();
      const snap = await getDoc(doc(window.__fb.db,'users',uid));
      let name='Kullanıcı', avatar='';
      if(snap.exists()){
        const u=snap.data()||{};
        const first=(u.name||u.firstName||'').trim();
        const last =(u.surname||u.lastName||'').trim();
        name = [first,last].filter(Boolean).join(' ') || u.displayName || 'Kullanıcı';
        avatar = u.avatar || u.photoURL || '';
      }
      const val = {name, avatar};
      __peerCache.set(uid, val);
      return val;
    }catch{
      return {name:'Kullanıcı', avatar:''};
    }
  }

  // ====== THREAD RENDER ======
  function threadItemTemplate({id, other, lastText, lastAt}){
    const t = document.createElement('div');
    t.className='th';
    t.dataset.id=id;
    t.innerHTML = `
      <div class="ava" style="background-image:url('${other.avatar||'/assets/img/avatar-default.png'}')"></div>
      <div>
        <div class="thTitle">${other.name||'Kullanıcı'}</div>
        <div class="thSub">${(lastText||'').replace(/[<>&]/g, s=>({ '<':'&lt;','>':'&gt;','&':'&amp;' }[s]))}</div>
      </div>
      <div class="thTime">${lastAt? fmtDate(lastAt):''}</div>
    `;
    return t;
  }

  function clearUnsub(){
    if(__itemsUnsub){ __itemsUnsub(); __itemsUnsub=null; }
  }

  // ====== OPEN THREAD ======
  async function openThread(threadId, otherUid){
    clearUnsub();
    __currentThreadId = threadId;

    // UI enable
    $('#msgInput').disabled = false; $('#sendBtn').disabled=false; $('#btnDelete').disabled=false;

    // peer info
    const other = await getUserBrief(otherUid);
    $('#peerName').textContent = other.name||'Kullanıcı';
    $('#peerAva').style.backgroundImage = `url('${other.avatar||'/assets/img/avatar-default.png'}')`;
    $('#peerMeta').textContent = `UID: ${otherUid}`;

    // Scroll + live listen items
    const {collection, query, orderBy, onSnapshot} = await api();
    const q = query(collection(window.__fb.db,'messages',threadId,'items'), orderBy('createdAt','asc'));

    const log = $('#log'); log.innerHTML='';
    let firstLoad = true;
    __itemsUnsub = onSnapshot(q, (snap)=>{
      let playBell = false;
      snap.docChanges().forEach(ch=>{
        if(ch.type==='added'){
          const d = ch.doc.data()||{};
          const mine = d.from === __me.uid;
          const wrap = document.createElement('div');
          wrap.className = 'msg' + (mine?' mine':'');
          wrap.innerHTML = `
            <div>${(d.text||'').replace(/[<>&]/g, s=>({ '<':'&lt;','>':'&gt;','&':'&amp;' }[s]))}</div>
            <div class="meta">${fmtDate(d.createdAt)}</div>
          `;
          log.appendChild(wrap);
          if(!mine && !firstLoad){ playBell = true; }
        }
      });
      if(playBell){ try{ bell.currentTime=0; bell.play(); }catch{} }
      firstLoad = false;
      log.scrollTop = log.scrollHeight;
    });
  }

  // ====== CREATE OR GET THREAD ======
  async function createOrGetThread(peerUid, presetName='', presetAva=''){
    const {collection, query, where, getDocs, addDoc, serverTimestamp} = await api();
    // Var mı?
    const q = query(collection(window.__fb.db,'messages'),
      where('participants','array-contains', __me.uid));
    const snap = await getDocs(q);
    let foundId = '';
    snap.forEach(ds=>{
      const d=ds.data()||{};
      if(Array.isArray(d.participants) && d.participants.length===2 && d.participants.includes(peerUid)){
        foundId = ds.id;
      }
    });
    if(foundId) return foundId;
    // Yoksa oluştur
    const now = serverTimestamp();
    const docRef = await addDoc(collection(window.__fb.db,'messages'),{
      participants:[__me.uid, peerUid],
      lastText:'',
      lastAt: now,
      lastFrom: __me.uid,
      otherName: presetName||'',
      otherAvatar: presetAva||''
    });
    return docRef.id;
  }

  // ====== SEND MESSAGE ======
  async function sendMessage(){
    const text = ($('#msgInput')?.value||'').trim();
    if(!text){ return; }
    if(badText(text)){ toast('Uygunsuz ifade tespit edildi.'); return; }
    if(!__currentThreadId){ toast('Konuşma seçin.'); return; }

    const {collection, addDoc, serverTimestamp, doc, updateDoc, getDoc} = await api();
    const now = serverTimestamp();
    const tRef = doc(window.__fb.db,'messages',__currentThreadId);

    // alıcıyı bul
    let peerUid = '';
    const tSnap = await getDoc(tRef);
    if(tSnap.exists()){
      const d=tSnap.data()||{};
      const arr=d.participants||[];
      peerUid = arr.find(x=>x!==__me.uid) || '';
    }

    await addDoc(collection(window.__fb.db,'messages',__currentThreadId,'items'),{
      text, from: __me.uid, createdAt: now
    });

    await updateDoc(tRef,{
      lastText: text, lastAt: now, lastFrom: __me.uid
    });

    // (Opsiyonel) Bildirim — kurallar izin veriyor
    try{
      const {collection, addDoc, serverTimestamp} = await api();
      await addDoc(collection(window.__fb.db,'notifications'),{
        to: peerUid, type:'message', text:`Yeni mesajınız var`, createdAt: serverTimestamp()
      });
    }catch(e){ /* sessiz */ }

    $('#msgInput').value='';
  }

  // ====== DELETE THREAD (permanent) ======
  async function deleteCurrentThread(){
    if(!__currentThreadId){ return; }
    const ok = confirm('Bu konuşmayı kalıcı olarak silmek istediğinize emin misiniz? Karşı tarafta da kaybolacaktır.');
    if(!ok) return;
    try{
      const {collection, getDocs, writeBatch, doc} = await api();
      // items
      const itemsCol = collection(window.__fb.db,'messages',__currentThreadId,'items');
      const itemsSnap = await getDocs(itemsCol);
      const batch = writeBatch(window.__fb.db);
      itemsSnap.forEach(m=> batch.delete(m.ref));
      // thread
      batch.delete(doc(window.__fb.db,'messages',__currentThreadId));
      await batch.commit();
      __currentThreadId = null;
      clearUnsub();
      $('#log').innerHTML='';
      $('#msgInput').disabled = true; $('#sendBtn').disabled=true; $('#btnDelete').disabled=true;
      $('#peerName').textContent='Kişi seçin'; $('#peerMeta').textContent='—'; $('#peerAva').style.backgroundImage='';
      toast('Konuşma silindi');
    }catch(e){
      console.error(e);
      toast('Silinemedi');
    }
  }

  // ====== LOAD THREADS (LEFT) ======
  async function listenThreads(){
    if(__threadsUnsub){ __threadsUnsub(); __threadsUnsub=null; }
    const {collection, query, where, orderBy, onSnapshot} = await api();
    let q = query(
      collection(window.__fb.db,'messages'),
      where('participants','array-contains', __me.uid),
      orderBy('lastAt','desc')
    );

    const listEl = $('#threads');
    listEl.innerHTML = '<div class="empty">Yükleniyor…</div>';

    __threadsUnsub = onSnapshot(q, async (snap)=>{
      const changes = snap.docChanges();
      if(!changes.length){
        listEl.innerHTML = '<div class="empty">Konuşma yok.</div>';
        return;
      }
      listEl.innerHTML = '';
      const rows = [];
      // Build all rows first (need peer names)
      for(const ds of snap.docs){
        const d=ds.data()||{};
        const arr = d.participants||[];
        const otherUid = arr.find(x=>x!==__me.uid) || '';
        const other = await getUserBrief(otherUid);
        rows.push({id:ds.id, otherUid, other, lastText:d.lastText||'', lastAt:d.lastAt});
      }

      // Search filter
      const qtxt = ($('#search')?.value||'').trim().toLowerCase();
      const filtered = qtxt ? rows.filter(r => (r.other.name||'').toLowerCase().includes(qtxt) || (r.lastText||'').toLowerCase().includes(qtxt)) : rows;

      filtered.forEach(r=>{
        const el = threadItemTemplate(r);
        el.onclick = ()=> openThread(r.id, r.otherUid);
        listEl.appendChild(el);
      });

      // Auto-open by URL peer
      const urlPeer = qs('peer');
      if(urlPeer){
        // find thread that matches peer, else create
        const has = rows.find(x=>x.otherUid===urlPeer);
        if(has){ openThread(has.id, urlPeer); }
        else{
          createOrGetThread(urlPeer, qs('name')? decodeURIComponent(qs('name')):'', qs('ava')||'')
            .then((id)=> openThread(id, urlPeer))
            .catch(()=> toast('Konuşma açılamadı'));
        }
        // URL’i bir kere kullan
        history.replaceState({}, document.title, location.pathname);
      }
    });
  }

  // ====== BOOT ======
  async function boot(){
    if(!ensureFirebaseReady()) return;
    $('#sendBtn').onclick = sendMessage;
    $('#btnDelete').onclick = deleteCurrentThread;
    $('#btnBackMobile').onclick = ()=>{ document.querySelector('.side').style.display='block'; };

    // auth
    await new Promise((res)=> window.__fb.onAuthStateChanged(window.__fb.auth,(u)=>{ __me=u||null; res(); }));
    if(!__me){ toast('Oturum bulunamadı. Giriş yapın.'); return; }
    $('#meInfo').textContent = __me.email || (__me.uid.slice(0,6)+'…');

    // enable composer once a thread is opened (default disabled)

    // search
    $('#search').addEventListener('input', ()=> listenThreads());

    // listen threads
    listenThreads();
  }

  (document.readyState==='loading') ? document.addEventListener('DOMContentLoaded', boot) : boot();
  </script>
</body>
</html>
