<!DOCTYPE html>
<html lang="tr" dir="ltr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mesajlar ‚Ä¢ √úreten Eller</title>
  <link rel="icon" href="./assets/icons/favicon.png" />
  <style>
    :root{ --bg1:#0b1220; --bg2:#0a0f1c; --ink:#e5e7eb; --muted:#9ca3af; --accent:#22d3ee; --ok:#10b981; --warn:#f59e0b; --err:#ef4444; --brd:#1f2937; --card:#0e172a; --card2:#0b1326 }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:linear-gradient(180deg,var(--bg1),var(--bg2));color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,'Noto Sans',sans-serif;max-width:100%;overflow:hidden}
    a{color:inherit;text-decoration:none}

    .page{height:100vh;display:grid;grid-template-columns:320px 1fr;gap:10px;padding:10px}
    .panel{border:1px solid var(--brd);border-radius:14px;background:linear-gradient(145deg,var(--card),var(--card2));overflow:hidden}

    /* Sol: thread list */
    .left{display:flex;flex-direction:column}
    .topbar{display:flex;align-items:center;gap:8px;padding:10px;border-bottom:1px solid var(--brd)}
    .logo{display:flex;align-items:center;gap:.5rem;font-weight:900}
    .logo img{width:24px;height:24px}
    .spacer{flex:1}
    .btn{display:inline-flex;align-items:center;gap:.45rem;padding:.5rem .8rem;border:1px solid var(--brd);border-radius:10px;background:#0b1220;color:var(--ink);font-weight:800;cursor:pointer;white-space:nowrap}
    .btn.ghost{background:transparent}
    .btn.accent{background:linear-gradient(180deg,#22d3ee,#0ea5b3);color:#042026;border-color:#0ea5b3}
    .btn.warn{background:linear-gradient(180deg,#f59e0b,#7a5408);border-color:#7a5408}
    .btn.primary{background:linear-gradient(180deg,#10b981,#128473);border-color:#0e766e}
    .search{padding:8px 10px;border-bottom:1px solid var(--brd)}
    .search input{width:100%;border:1px solid var(--brd);border-radius:10px;background:#0b1326;color:var(--ink);padding:10px}

    #threads{overflow:auto;flex:1}
    .empty{padding:12px;color:var(--muted);text-align:center}
    .th{display:grid;grid-template-columns:44px 1fr auto;gap:8px;padding:10px;border-bottom:1px solid var(--brd);cursor:pointer}
    .th:hover{background:rgba(255,255,255,.03)}
    .ava{width:44px;height:44px;border-radius:10px;border:1px solid var(--brd);background:#111827 center/cover no-repeat}
    .thTitle{font-weight:800}
    .thSub{color:var(--muted);font-size:.92rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:220px}
    .thTime{color:var(--muted);font-size:.8rem;min-width:80px;text-align:right}
    .row{display:flex;gap:6px;align-items:center}

    /* Saƒü: chat */
    .right{display:grid;grid-template-rows:auto 1fr auto}
    .chatTop{display:flex;align-items:center;gap:10px;padding:10px;border-bottom:1px solid var(--brd)}
    .chatTop .name{font-weight:900;cursor:pointer}
    .chatTop .mini{color:var(--muted);font-size:.9rem}
    .chatBody{overflow:auto;padding:12px;display:flex;flex-direction:column;gap:8px}
    .msg{max-width:70%;padding:10px 12px;border:1px solid var(--brd);border-radius:12px;background:#0b1326;white-space:pre-wrap}
    .me{align-self:flex-end;background:#0e2233}
    .other{align-self:flex-start}
    .chatInput{display:flex;gap:8px;padding:10px;border-top:1px solid var(--brd)}
    .chatInput input{flex:1;border:1px solid var(--brd);border-radius:10px;background:#0b1326;color:var(--ink);padding:10px}
    .chatInput button{border:1px solid var(--brd);border-radius:10px;background:var(--accent);color:#03222a;font-weight:900;padding:10px 14px;cursor:pointer}

    .muted{color:var(--muted)}
    .danger{background:linear-gradient(180deg,#ef4444,#7a1b1b);color:#fff;border:none}
    .pill{display:inline-flex;align-items:center;gap:.35rem;padding:.25rem .6rem;border:1px solid var(--brd);border-radius:999px}
    .tools{display:flex;gap:6px}
    .pill.badge{background:#0b1326}
  </style>

  <!-- Firebase init (docs altƒ±nda) -->
  <script type="module" src="./firebase-init.js"></script>
</head>
<body>
  <div class="page">
    <!-- LEFT: THREADS -->
    <div class="panel left">
      <div class="topbar">
        <div class="logo">
          <img src="./√ºreteneller.png" alt="logo" />
          <span id="brandTxt">√úreten Eller</span>
        </div>
        <div class="spacer"></div>
        <button class="btn ghost" id="btnHome" type="button">üè† <span id="homeLbl">Ana sayfa</span></button>
        <button class="btn accent" id="btnNotif" type="button">üîî <span id="notifLbl">Bildirimleri A√ß</span></button>
        <button class="btn primary" id="btnSound" type="button">üîä <span id="soundLbl">Sesi A√ß</span></button>
      </div>
      <div class="search">
        <input id="search" placeholder="Ki≈üi veya mesaj ara" />
      </div>
      <div id="threads">
        <div class="empty">Y√ºkleniyor‚Ä¶</div>
      </div>
    </div>

    <!-- RIGHT: CHAT -->
    <div class="panel right">
      <div class="chatTop">
        <div id="peerAva" class="ava"></div>
        <div style="flex:1">
          <div class="name" id="peerName" title="Profili a√ß">Ki≈üi se√ßin</div>
          <div class="mini" id="peerInfo">‚Äî</div>
        </div>
        <div class="tools">
          <span class="pill badge" id="unreadBadge" title="Okunmamƒ±≈ü mesaj">0</span>
          <button class="btn danger" id="btnHideThread" title="Bu konu≈ümayƒ± panelimden kaldƒ±r">üóë Panelimden kaldƒ±r</button>
        </div>
      </div>
      <div id="chat" class="chatBody" aria-live="polite">
        <div class="empty">Soldan bir konu≈üma se√ßin.</div>
      </div>
      <div class="chatInput">
        <input id="msgInput" placeholder="Mesaj yazƒ±n‚Ä¶" />
        <button id="btnSend">G√∂nder</button>
      </div>
    </div>
  </div>

  <audio id="ding" preload="auto" src="./notify.wav"></audio>

  <script>
    // ========= I18N =========
    const I18N = {
      tr: {
        brand:'√úreten Eller', home:'Ana sayfa', search:'Ki≈üi veya mesaj ara',
        notif_enable:'Bildirimleri A√ß', notif_granted:'Bildirimler aktif', notif_blocked:'Bildirim engelli',
        sound_on:'Sesi A√ß', sound_off:'Sesi Kapat',
        list_loading:'Y√ºkleniyor‚Ä¶', list_empty:'Konu≈üma yok.',
        pick_someone:'Ki≈üi se√ßin', write_msg:'Mesaj yazƒ±n‚Ä¶',
        new_message_title:'Yeni mesaj',
        new_message_body:(name,text)=>`${name}: ${text}`,
        you:'(siz)', unseen_label:(n)=>`Okunmamƒ±≈ü: ${n}`
      },
      en: {
        brand:'Ureten Eller', home:'Home', search:'Search people or messages',
        notif_enable:'Enable Notifications', notif_granted:'Notifications on', notif_blocked:'Notifications blocked',
        sound_on:'Turn Sound On', sound_off:'Turn Sound Off',
        list_loading:'Loading‚Ä¶', list_empty:'No conversations.',
        pick_someone:'Select a conversation', write_msg:'Type a message‚Ä¶',
        new_message_title:'New message',
        new_message_body:(name,text)=>`${name}: ${text}`,
        you:'(you)', unseen_label:(n)=>`Unseen: ${n}`
      },
      de: {
        brand:'Ureten Eller', home:'Startseite', search:'Person oder Nachricht suchen',
        notif_enable:'Benachrichtigungen aktivieren', notif_granted:'Benachrichtigungen an', notif_blocked:'Benachrichtigungen blockiert',
        sound_on:'Ton einschalten', sound_off:'Ton ausschalten',
        list_loading:'Wird geladen‚Ä¶', list_empty:'Keine Konversationen.',
        pick_someone:'Person ausw√§hlen', write_msg:'Nachricht schreiben‚Ä¶',
        new_message_title:'Neue Nachricht',
        new_message_body:(name,text)=>`${name}: ${text}`,
        you:'(du)', unseen_label:(n)=>`Ungelesen: ${n}`
      },
      ar: {
        brand:'ÿ£ŸäÿßÿØŸä ŸÖŸÜÿ™ÿ¨ÿ©', home:'ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©', search:'ÿßÿ®ÿ≠ÿ´ ÿπŸÜ ÿ¥ÿÆÿµ ÿ£Ÿà ÿ±ÿ≥ÿßŸÑÿ©',
        notif_enable:'ÿ™ŸÅÿπŸäŸÑ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™', notif_granted:'ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ŸÖŸÅÿπŸëŸÑÿ©', notif_blocked:'ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ŸÖÿ≠ÿ∏Ÿàÿ±ÿ©',
        sound_on:'ÿ™ÿ¥ÿ∫ŸäŸÑ ÿßŸÑÿµŸàÿ™', sound_off:'ÿ•ŸäŸÇÿßŸÅ ÿßŸÑÿµŸàÿ™',
        list_loading:'ÿ¨ÿßÿ±Ÿç ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ‚Ä¶', list_empty:'ŸÑÿß ŸÖÿ≠ÿßÿØÿ´ÿßÿ™.',
        pick_someone:'ÿßÿÆÿ™ÿ± ŸÖÿ≠ÿßÿØÿ´ÿ©', write_msg:'ÿßŸÉÿ™ÿ® ÿ±ÿ≥ÿßŸÑÿ©‚Ä¶',
        new_message_title:'ÿ±ÿ≥ÿßŸÑÿ© ÿ¨ÿØŸäÿØÿ©',
        new_message_body:(name,text)=>`${name}: ${text}`,
        you:'(ÿ£ŸÜÿ™)', unseen_label:(n)=>`ÿ∫Ÿäÿ± ÿßŸÑŸÖŸÇÿ±Ÿàÿ°ÿ©: ${n}`
      }
    };
    const LANG_KEY='ue_lang_v1';
    function lang(){ try{ const s=localStorage.getItem(LANG_KEY); if(s && I18N[s]) return s; const nav=(navigator.language||'tr').slice(0,2); return I18N[nav]?nav:'tr'; }catch{ return 'tr'; }}
    function t(k){ const d=I18N[lang()]||I18N.tr; return d[k]||k; }

    // ========= Utilities =========
    const $ = (s)=> document.querySelector(s);
    const qs = (k)=> new URLSearchParams(location.search).get(k)||'';
    function fmtDate(ts){
      try{ const d = ts?.toDate ? ts.toDate() : (ts? new Date(ts): null); return d? d.toLocaleString(lang()==='tr'?'tr-TR':undefined):''; }catch{ return ''; }
    }
    function escapeHtml(x){ return (x||'').replace(/[<>&]/g, s=>({ '<':'&lt;','>':'&gt;','&':'&amp;' }[s])); }
    function toast(msg){ /* minimal */ }

    // ========= Local soft-hide =========
    const LS_KEY_THREADS = (uid)=> `ue.hiddenThreads.${uid}`;
    function getHiddenThreads(uid){ try{ return new Set(JSON.parse(localStorage.getItem(LS_KEY_THREADS(uid))||'[]')); }catch{ return new Set(); } }
    function setHiddenThreads(uid,set){ try{ localStorage.setItem(LS_KEY_THREADS(uid), JSON.stringify(Array.from(set))); }catch{} }

    // ========= Global unread publish (for home.html) =========
    const UNREAD_LS_KEY = 'ue_messages_unread_count';
    const UNREAD_TEXT_LS_KEY = 'ue_messages_unread_latest_text';
    const bc = ('BroadcastChannel' in self) ? new BroadcastChannel('ue-messages') : null;
    function publishUnread(count, latestText=''){
      try{
        localStorage.setItem(UNREAD_LS_KEY, String(count));
        localStorage.setItem(UNREAD_TEXT_LS_KEY, latestText||'');
        if(bc) bc.postMessage({ type:'unread', count, latestText });
        const badge = document.getElementById('unreadBadge');
        if(badge) badge.textContent = String(count);
      }catch{}
    }

    // ========= Firebase helpers =========
    async function api(){
      const mod = await import('https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js');
      return mod;
    }

    let __me=null;
    let __threadsUnsub=null;
    let __msgsUnsub=null;
    let __curThreadId=null;
    let __curPeerUid=null;
    let __hiddenThreads = new Set();
    let __ding = null;
    let __lastSeenMap = {}; // threadId -> lastAt millis (bildirim kƒ±yasƒ±)
    let __soundEnabled = (localStorage.getItem('ue_msg_sound')==='1');

    // Profil kƒ±sa getirme (ad/ava)
    const _briefCache = new Map();
    async function getUserBrief(uid){
      if(!uid) return { name:'Kullanƒ±cƒ±', avatar:'/assets/img/avatar-default.png' };
      if(_briefCache.has(uid)) return _briefCache.get(uid);
      try{
        const { doc, getDoc } = await api();
        const snap = await getDoc(doc(self.db,'users',uid));
        const d = snap.exists()? (snap.data()||{}) : {};
        const name = [d.name||d.firstName||'', d.surname||d.lastName||''].filter(Boolean).join(' ') || d.displayName || 'Kullanƒ±cƒ±';
        const brief = { name, avatar: d.avatar||d.photoURL||'/assets/img/avatar-default.png', email: d.email||'' };
        _briefCache.set(uid, brief);
        return brief;
      }catch{ return { name:'Kullanƒ±cƒ±', avatar:'/assets/img/avatar-default.png', email:'' }; }
    }

    // ========= Bildirim & Ses =========
    function ensureNotifPermission(){
      if(!('Notification' in self)) return;
      if(Notification.permission==='default'){
        // izin istemeyi butona da baƒüladƒ±k; otomatik tetiklemeyelim
      }
      updateNotifBtn();
    }
    function updateNotifBtn(){
      const lbl = document.getElementById('notifLbl');
      if(!('Notification' in self)){ lbl.textContent = t('notif_blocked'); return; }
      lbl.textContent = Notification.permission==='granted' ? t('notif_granted') : t('notif_enable');
    }
    function requestNotif(){
      if(!('Notification' in self)) return;
      Notification.requestPermission().then(()=> updateNotifBtn()).catch(()=>{});
    }
    function updateSoundBtn(){
      document.getElementById('soundLbl').textContent = __soundEnabled ? t('sound_off') : t('sound_on');
    }
    function toggleSound(){
      __soundEnabled = !__soundEnabled;
      localStorage.setItem('ue_msg_sound', __soundEnabled?'1':'0');
      updateSoundBtn();
      if(__soundEnabled && __ding){
        __ding.currentTime=0; __ding.play().catch(()=>{});
      }
    }
    function playDing(){
      if(!__soundEnabled) return;
      try{ __ding && __ding.play().catch(()=>{}); }catch{}
    }
    async function showNotify({title, body, threadId}){
      try{
        if(!('Notification' in self)) return;
        if(Notification.permission!=='granted') return;
        const icon = '/assets/icons/icon-192.png';
        const n = new Notification(title,{ body, icon, vibrate:[120,60,120] });
        n.onclick = ()=>{ self.focus(); if(threadId) openThread(threadId); };
      }catch{}
    }

    // ========= THREADS render & unread hesap =========
    function computeUnreadCount(rows){
      // Unread: lastAt > seen[me] && lastFrom != me
      let total = 0;
      let latestText = '';
      rows.forEach(r=>{
        const d = r.d || {};
        const seenObj = d.seen || {};
        const seenForMe = seenObj?.[__me.uid];
        const seenMs = seenForMe?.toMillis ? seenForMe.toMillis() : (seenForMe? new Date(seenForMe).getTime():0);
        const lastMs = d.lastAt?.toMillis ? d.lastAt.toMillis() : (d.lastAt? new Date(d.lastAt).getTime():0);
        const fromOther = d.lastFrom && d.lastFrom !== __me.uid;
        if(fromOther && lastMs && lastMs>(seenMs||0)){
          total++;
          if(!latestText) latestText = (d.lastText||'').slice(0,120);
        }
      });
      publishUnread(total, latestText);
      return total;
    }

    function renderThreadsSnapshot(snap){
      const listEl = $('#threads');
      const rows = [];
      snap.forEach(ds=>{
        const d = ds.data()||{};
        if(__hiddenThreads.has(ds.id)) return;
        const arr = d.participants||[];
        const otherUid = arr.find(x=>x!==__me.uid) || '';
        rows.push({ id: ds.id, d, otherUid });
      });

      rows.sort((a,b)=>{
        const ta = a.d.lastAt?.toMillis ? a.d.lastAt.toMillis() : (a.d.lastAt? new Date(a.d.lastAt).getTime():0);
        const tb = b.d.lastAt?.toMillis ? b.d.lastAt.toMillis() : (b.d.lastAt? new Date(b.d.lastAt).getTime():0);
        return (tb||0) - (ta||0);
      });

      const qtxt = ($('#search')?.value||'').trim().toLowerCase();

      listEl.innerHTML = rows.length ? '' : `<div class="empty">${t('list_empty')}</div>`;

      (async ()=>{
        let unreadCount = 0;
        for(const r of rows){
          const other = await getUserBrief(r.otherUid);
          if(qtxt && !(other.name||'').toLowerCase().includes(qtxt) && !(r.d.lastText||'').toLowerCase().includes(qtxt)) continue;

          const t = document.createElement('div');
          t.className='th'; t.dataset.id=r.id;
          t.innerHTML = `
            <div class="ava" style="background-image:url('${other.avatar||'/assets/img/avatar-default.png'}')"></div>
            <div>
              <div class="thTitle">${escapeHtml(other.name||'Kullanƒ±cƒ±')}</div>
              <div class="thSub">${escapeHtml(r.d.lastText||'')}</div>
            </div>
            <div class="thTime">${r.d.lastAt? fmtDate(r.d.lastAt):''}</div>
          `;
          t.onclick = ()=> openThread(r.id, r.otherUid, other);
          listEl.appendChild(t);

          // Yeni mesaj algƒ±la (sesten baƒüƒ±msƒ±z)
          const lastMillis = r.d.lastAt?.toMillis ? r.d.lastAt.toMillis() : (r.d.lastAt? new Date(r.d.lastAt).getTime():0);
          const prev = __lastSeenMap[r.id] || 0;
          if(lastMillis && lastMillis>prev && r.d.lastText && r.d.lastFrom && r.d.lastFrom!==__me.uid){
            playDing();
            showNotify({
              title: t('new_message_title'),
              body: (I18N[lang()].new_message_body||((n,txt)=>`${n}: ${txt}`))(other.name||'', r.d.lastText||''),
              threadId: r.id
            });
          }
          __lastSeenMap[r.id] = lastMillis || prev;
        }
        // Unread sayƒ±sƒ±nƒ± hesapla ve yayƒ±nla
        unreadCount = computeUnreadCount(rows);
      })();
    }

    // ========= Listen Threads (index-safe) =========
    async function listenThreads(){
      if(__threadsUnsub){ __threadsUnsub(); __threadsUnsub=null; }
      const {collection, query, where, orderBy, onSnapshot, getDocs} = await api();
      const baseQ = query(collection(self.db,'messages'), where('participants','array-contains', __me.uid));

      const listEl = $('#threads');
      listEl.innerHTML = `<div class="empty">${t('list_loading')}</div>`;

      try{
        const q = query(baseQ, orderBy('lastAt','desc'));
        __threadsUnsub = onSnapshot(q, (snap)=> renderThreadsSnapshot(snap), (err)=>{
          console.warn('Threads listen error (indexed):', err);
          fallbackNoIndex();
        });
      }catch(err){
        console.warn('Indexed query build failed:', err);
        fallbackNoIndex();
      }
    }

    async function fallbackNoIndex(){
      const {collection, query, where, getDocs} = await api();
      const q = query(collection(self.db,'messages'), where('participants','array-contains', __me.uid));
      const snap = await getDocs(q);
      renderThreadsSnapshot(snap);
    }

    // ========= Chat (right) =========
    async function listenMessages(threadId){
      if(__msgsUnsub){ __msgsUnsub(); __msgsUnsub=null; }
      const { collection, query, orderBy, onSnapshot } = await api();
      const q = query(collection(self.db,'messages', threadId, 'items'), orderBy('createdAt','asc'));
      const chat = $('#chat');
      chat.innerHTML = '';
      __msgsUnsub = onSnapshot(q, (snap)=>{
        chat.innerHTML = '';
        snap.forEach(ds=>{
          const m = ds.data()||{};
          const div = document.createElement('div');
          div.className = 'msg ' + (m.from === __me.uid ? 'me':'other');
          div.textContent = m.text || '';
          chat.appendChild(div);
        });
        chat.scrollTop = chat.scrollHeight;
      }, (err)=>{ console.warn('listenMessages error:', err); });
    }

    async function openThread(threadId, peerUid=null, peerBrief=null){
      __curThreadId = threadId;
      const { doc, updateDoc, serverTimestamp, getDoc } = await api();
      // thread doc
      const tRef = doc(self.db,'messages',threadId);
      try{
        const tSnap = await getDoc(tRef);
        const d = tSnap.exists()? (tSnap.data()||{}) : {};
        const arr = d.participants||[];
        __curPeerUid = peerUid || arr.find(x=>x!==__me.uid) || '';
      }catch{}

      const info = peerBrief || await getUserBrief(__curPeerUid);
      $('#peerAva').style.backgroundImage = `url('${info.avatar||'/assets/img/avatar-default.png'}')`;
      $('#peerName').textContent = info.name || 'Kullanƒ±cƒ±';
      $('#peerInfo').textContent = info.email || __curPeerUid || '‚Äî';
      // Profil a√ßma
      $('#peerAva').onclick = ()=>{ if(__curPeerUid) location.href = '/docs/profile.html?uid='+encodeURIComponent(__curPeerUid); };
      $('#peerName').onclick = ()=>{ if(__curPeerUid) location.href = '/docs/profile.html?uid='+encodeURIComponent(__curPeerUid); };

      // seen damgasƒ±
      try{
        await updateDoc(tRef, { [`seen.${__me.uid}`]: serverTimestamp() });
      }catch(e){/* sessiz */}

      await listenMessages(threadId);
    }

    async function createOrGetThread(peerUid, otherName='', otherAvatar=''){
      const { collection, query, where, getDocs, doc, setDoc, serverTimestamp } = await api();
      // var mƒ±?
      const q = query(collection(self.db,'messages'), where('participants','array-contains', __me.uid));
      const snap = await getDocs(q);
      let found = '';
      snap.forEach(ds=>{
        const arr = (ds.data()?.participants)||[];
        if(arr.includes(peerUid)) found = ds.id;
      });
      if(found) return found;

      // yoksa olu≈ütur
      const participants = [__me.uid, peerUid];
      const ref = doc(self.db, 'messages', crypto.randomUUID ? crypto.randomUUID() : (Date.now().toString(36)+Math.random().toString(36).slice(2,8)));
      await setDoc(ref, { participants, lastText:'', lastAt: serverTimestamp(), otherName, otherAvatar });
      return ref.id;
    }

    async function sendMessage(){
      const text = ($('#msgInput').value||'').trim();
      if(!text || !__curThreadId) return;
      $('#msgInput').value = '';
      try{
        const { collection, addDoc, serverTimestamp, doc, updateDoc } = await api();
        await addDoc(collection(self.db,'messages',__curThreadId,'items'),{
          text, from: __me.uid, createdAt: serverTimestamp()
        });
        await updateDoc(doc(self.db,'messages',__curThreadId),{
          lastText: text, lastAt: serverTimestamp(), lastFrom: __me.uid
        });
      }catch(err){ console.warn('sendMessage error:', err); }
    }

    // ========= ‚ÄúPanelimden kaldƒ±r‚Äù =========
    function hideCurrentThreadForMe(){
      if(!__curThreadId || !__me) return;
      __hiddenThreads.add(__curThreadId);
      setHiddenThreads(__me.uid, __hiddenThreads);
      // saƒü paneli temizle
      $('#peerAva').style.backgroundImage='';
      $('#peerName').textContent=t('pick_someone');
      $('#peerInfo').textContent='‚Äî';
      $('#chat').innerHTML=`<div class="empty">${t('pick_someone')}</div>`;
      __curThreadId=null; __curPeerUid=null;
      listenThreads();
    }

    // ========= Boot =========
    async function boot(){
      // Dil uygula
      document.getElementById('brandTxt').textContent = t('brand');
      document.getElementById('homeLbl').textContent = t('home');
      document.getElementById('notifLbl').textContent = t('notif_enable');
      document.getElementById('soundLbl').textContent = __soundEnabled ? t('sound_off') : t('sound_on');
      const sEl = document.getElementById('search'); if(sEl) sEl.placeholder = t('search');

      // Auth
      await new Promise((res)=> self.onAuthStateChanged(self.auth, (u)=>{ __me=u||null; res(); }));
      if(!__me){ location.href='./index.html'; return; }

      // Ses & Bildirim
      __ding = document.getElementById('ding');
      ensureNotifPermission();
      updateSoundBtn();

      // Gizli thread setini y√ºkle
      __hiddenThreads = getHiddenThreads(__me.uid);

      // UI hooks
      const btnHome = document.getElementById('btnHome');
      if(btnHome){ btnHome.addEventListener('click',(e)=>{ e.preventDefault(); location.href='./home.html'; },{passive:true}); }
      const btnSend = document.getElementById('btnSend');
      const msgInput = document.getElementById('msgInput');
      const btnHideThread = document.getElementById('btnHideThread');
      const search = document.getElementById('search');
      const btnNotif = document.getElementById('btnNotif');
      const btnSound = document.getElementById('btnSound');

      if (btnSend) btnSend.addEventListener('click', sendMessage);
      if (msgInput) msgInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ sendMessage(); } });
      if (btnHideThread) btnHideThread.addEventListener('click', hideCurrentThreadForMe);
      if (search) search.addEventListener('input', ()=> listenThreads());
      if (btnNotif) btnNotif.addEventListener('click', requestNotif);
      if (btnSound) btnSound.addEventListener('click', toggleSound);

      // URL‚Äôden otomatik ba≈ülatma (orders/profile y√∂nlendirmesiyle gelebilir)
      const urlPeer = qs('peer');
      if(urlPeer){
        const name = qs('name') ? decodeURIComponent(qs('name')) : '';
        const ava  = qs('ava') || '';
        try{
          const tid = await createOrGetThread(urlPeer, name, ava);
          openThread(tid, urlPeer);
        }catch{}
        history.replaceState({}, document.title, location.pathname);
      }

      // Thread‚Äôleri dinle (sayfa g√∂r√ºnmez olsa bile √ßalƒ±≈üƒ±r)
      listenThreads();

      // Sayfa g√∂r√ºn√ºrl√ºƒü√º deƒüi≈üse de (arka sekme) √ßalƒ±≈ümaya devam
      document.addEventListener('visibilitychange', ()=>{ /* Firestore listener zaten aktif; ekstra i≈ülem gerekmiyor */ });
    }

    (function init(){
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', boot);
      } else {
        boot();
      }
    })();
  </script>
</body>
</html>
