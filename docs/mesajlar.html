<!DOCTYPE html>
<html lang="tr" dir="ltr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title data-i18n="title">Mesajlar ‚Ä¢ √úreten Eller</title>
  <link rel="icon" href="/assets/icons/favicon.png" />
  <style>
    :root{ --bg1:#0b1220; --bg2:#0a0f1c; --ink:#e5e7eb; --muted:#9ca3af; --accent:#22d3ee; --brd:#1f2937; --card:#0e172a; --card2:#0b1326; }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:radial-gradient(1200px 600px at 20% -10%,#10213f22,transparent),linear-gradient(180deg,var(--bg1),var(--bg2));color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,'Noto Sans',sans-serif;max-width:100%;overflow-x:hidden}
    a{color:inherit;text-decoration:none}

    .wrap{max-width:1280px;margin:0 auto;padding:1rem}
    .top{display:flex;align-items:center;gap:.75rem;flex-wrap:wrap}
    .logo{display:flex;align-items:center;gap:.5rem;font-weight:900}
    .logo img{width:32px;height:32px}
    .spacer{flex:1}
    .btn{display:inline-flex;align-items:center;gap:.4rem;padding:.55rem .85rem;border:1px solid var(--brd);border-radius:12px;background:#0b1220;color:var(--ink);font-weight:800;cursor:pointer}
    .btn.primary{background:linear-gradient(180deg,#10b981,#128473);border-color:#0e766e}
    .btn.warn{background:linear-gradient(180deg,#f59e0b,#7a5408);border-color:#7a5408}
    .btn.danger{background:linear-gradient(180deg,#ef4444,#7a1b1b);border-color:#7a1b1b}
    .btn.ghost{background:transparent}
    .mini{color:var(--muted)}

    .layout{display:grid;grid-template-columns:360px 1fr;gap:1rem}
    @media(max-width:920px){ .layout{grid-template-columns:1fr} .right{order:2} }

    .left{border:1px solid var(--brd);border-radius:16px;background:linear-gradient(145deg,var(--card),var(--card2));display:flex;flex-direction:column;min-height:70vh}
    .leftHead{display:flex;gap:.5rem;align-items:center;justify-content:space-between;padding:.6rem;border-bottom:1px solid var(--brd)}
    .search{flex:1;background:#0a0f1c;border:1px solid var(--brd);color:var(--ink);border-radius:10px;padding:.5rem}
    .threadList{overflow:auto}
    .th{display:grid;grid-template-columns:24px 42px 1fr auto;gap:.6rem;padding:.6rem;border-bottom:1px solid var(--brd);cursor:pointer}
    .th:hover{background:#0b1220}
    .th .ava{width:42px;height:42px;border-radius:50%;background:#111827;border:1px solid var(--brd);background-size:cover;background-position:center}
    .th .ttl{font-weight:800}
    .th .last{color:#cbd5e1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:320px}
    .th .meta{display:flex;gap:.5rem;align-items:center}
    .th input[type="checkbox"]{width:18px;height:18px}

    .right{border:1px solid var(--brd);border-radius:16px;background:linear-gradient(145deg,var(--card),var(--card2));display:flex;flex-direction:column;min-height:70vh}
    .chatHead{display:flex;align-items:center;justify-content:space-between;padding:.6rem;border-bottom:1px solid var(--brd)}
    .chatTitle{display:flex;align-items:center;gap:.6rem}
    .chatBody{flex:1;overflow:auto;padding:.8rem;display:flex;flex-direction:column;gap:.5rem}
    .msg{max-width:70%;padding:.55rem .7rem;border:1px solid var(--brd);border-radius:14px}
    .mine{align-self:flex-end;background:#0c1426}
    .theirs{align-self:flex-start;background:#0b1220}
    .msgRow{display:flex;gap:.4rem;align-items:center}
    .msg .tools{opacity:.7}
    .msg .tools button{border:0;background:transparent;color:#94a3b8;cursor:pointer}
    .msg .tools button:hover{color:#fff}

    .chatSend{display:flex;gap:.5rem;padding:.6rem;border-top:1px solid var(--brd)}
    .inp{flex:1;background:#0a0f1c;border:1px solid var(--brd);color:var(--ink);border-radius:10px;padding:.6rem}

    .notice{border:1px dashed var(--brd);border-radius:14px;padding:.7rem .8rem;background:#0c1426;margin:.8rem}
    .toast{position:fixed;left:50%;bottom:80px;transform:translateX(-50%);background:#0b1220;border:1px solid var(--brd);padding:.5rem .75rem;border-radius:10px;font-weight:800;z-index:1200;display:none}
  </style>
  <script type="module" src="./firebase-init.js"></script>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="logo">
        <img src="./√ºreteneller.png" alt="logo" />
        <span data-i18n="brand">√úreten Eller</span>
      </div>
      <div class="spacer"></div>
      <button class="btn ghost" id="btnBack" type="button">‚Üê <span data-i18n="back">Profile D√∂n</span></button>
    </div>

    <div class="layout">
      <aside class="left">
        <div class="leftHead">
          <input id="q" class="search" placeholder="Ara‚Ä¶" />
          <button class="btn danger" id="btnBulkDelete" type="button" title="Se√ßili Sil">üóëÔ∏è <span data-i18n="bulk_delete">Se√ßili Sil</span></button>
        </div>
        <div id="threadList" class="threadList" role="listbox" aria-label="Sohbetler"></div>
      </aside>

      <section class="right">
        <header class="chatHead">
          <div class="chatTitle">
            <div id="chatAva" class="ava" style="width:36px;height:36px;border-radius:50%;background:#111827;border:1px solid var(--brd)"></div>
            <div>
              <div id="chatName" class="ttl">‚Äî</div>
              <div id="chatSub" class="mini">‚Äî</div>
            </div>
          </div>
          <div class="row">
            <button class="btn warn" id="btnDeleteThread" type="button">üóëÔ∏è <span data-i18n="delete_thread">Sohbeti Sil</span></button>
          </div>
        </header>
        <div id="chatBody" class="chatBody" aria-live="polite"></div>
        <div class="chatSend">
          <input id="msgInput" class="inp" placeholder="Mesaj yaz‚Ä¶" />
          <button class="btn primary" id="btnSend" type="button" data-i18n="send">G√∂nder</button>
        </div>
      </section>
    </div>

    <div id="emptyBox" class="notice mini" style="display:none">Hen√ºz mesaj yok.</div>
  </div>

  <div id="toast" class="toast" role="status"></div>

  <script>
    // ==== I18N: TR / DE / EN / AR ====
    const I18N={
      tr:{title:'Mesajlar ‚Ä¢ √úreten Eller',brand:'√úreten Eller',back:'Profile D√∂n',bulk_delete:'Se√ßili Sil',delete_thread:'Sohbeti Sil',confirm_delete_many:'Se√ßili sohbetler silinsin mi? (Kalƒ±cƒ±)',confirm_delete_one:'Bu sohbet silinsin mi? (Kalƒ±cƒ±)',confirm_delete_msg:'Bu mesaj silinsin mi? (Kalƒ±cƒ±)',search:'Ara‚Ä¶',none:'Hen√ºz mesaj yok.',send:'G√∂nder',order:'#Sipari≈ü '},
      de:{title:'Nachrichten ‚Ä¢ Ureten Eller',brand:'Ureten Eller',back:'Zur√ºck zum Profil',bulk_delete:'Ausgew√§hlte l√∂schen',delete_thread:'Chat l√∂schen',confirm_delete_many:'Ausgew√§hlte Chats dauerhaft l√∂schen?',confirm_delete_one:'Diesen Chat dauerhaft l√∂schen?',confirm_delete_msg:'Diese Nachricht l√∂schen?',search:'Suchen‚Ä¶',none:'Noch keine Nachrichten.',send:'Senden',order:'#Bestellung '},
      en:{title:'Messages ‚Ä¢ Ureten Eller',brand:'Ureten Eller',back:'Back to Profile',bulk_delete:'Delete Selected',delete_thread:'Delete Chat',confirm_delete_many:'Delete selected chats permanently?',confirm_delete_one:'Delete this chat permanently?',confirm_delete_msg:'Delete this message?',search:'Search‚Ä¶',none:'No messages yet.',send:'Send',order:'#Order '},
      ar:{title:'ÿßŸÑÿ±ÿ≥ÿßÿ¶ŸÑ ‚Ä¢ Ureten Eller',brand:'Ureten Eller',back:'ÿßŸÑÿπŸàÿØÿ© ŸÑŸÑŸÖŸÑŸÅ',bulk_delete:'ÿ≠ÿ∞ŸÅ ÿßŸÑŸÖÿ≠ÿØÿØ',delete_thread:'ÿ≠ÿ∞ŸÅ ÿßŸÑŸÖÿ≠ÿßÿØÿ´ÿ©',confirm_delete_many:'ÿ≠ÿ∞ŸÅ ÿßŸÑŸÖÿ≠ÿßÿØÿ´ÿßÿ™ ÿßŸÑŸÖÿ≠ÿØÿØÿ© ŸÜŸáÿßÿ¶ŸäŸãÿßÿü',confirm_delete_one:'ÿ≠ÿ∞ŸÅ Ÿáÿ∞Ÿá ÿßŸÑŸÖÿ≠ÿßÿØÿ´ÿ© ŸÜŸáÿßÿ¶ŸäŸãÿßÿü',confirm_delete_msg:'ÿ≠ÿ∞ŸÅ Ÿáÿ∞Ÿá ÿßŸÑÿ±ÿ≥ÿßŸÑÿ©ÿü',search:'ÿßÿ®ÿ≠ÿ´‚Ä¶',none:'ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ±ÿ≥ÿßÿ¶ŸÑ ÿ®ÿπÿØ.',send:'ÿ•ÿ±ÿ≥ÿßŸÑ',order:'ÿ±ŸÇŸÖ ÿßŸÑÿ∑ŸÑÿ® #'}
    };
    const LANG_KEY='ue_lang_v1';
    function pickLang(){ try{ const saved=localStorage.getItem(LANG_KEY); if(saved&&I18N[saved]) return saved; const nav=(navigator.language||'tr').slice(0,2); return I18N[nav]?nav:'tr'; }catch{ return 'tr'; } }
    function t(k){ const d=I18N[pickLang()]||I18N.tr; return d[k]||k; }
    function applyI18n(){
      document.title=t('title');
      document.querySelectorAll('[data-i18n]').forEach(n=>{const k=n.getAttribute('data-i18n'); n.textContent=t(k);});
      const q=document.getElementById('q'); if(q) q.placeholder=t('search');
      const mi=document.getElementById('msgInput'); if(mi) mi.placeholder=t('send');
      document.getElementById('emptyBox').textContent=t('none');
    }

    // ==== Utils ====
    const $=(s)=>document.querySelector(s);
    const qs=(s)=>new URLSearchParams(location.search).get(s)||'';
    function toast(msg){ const el=$('#toast'); el.textContent=msg; el.style.display='block'; clearTimeout(window.__to); window.__to=setTimeout(()=>el.style.display='none',1600); }
    function escapeHtml(s){ return (s||'').replace(/[&<>"']/g,(c)=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c])); }
    function formatDate(ts){ try{ if(!ts) return '‚Äî'; const d=ts.toDate?ts.toDate():new Date(ts); return d.toLocaleString(pickLang()==='tr'?'tr-TR':undefined); }catch{ return '‚Äî'; } }
    function threadIdFromPair(a,b){ return [a,b].sort().join('__'); }

    // ==== State ====
    let __uid=null;
    let __threads=[]; let __filtered=[]; let __sel=new Set();
    let __unsubThreads=null; let __unsubItems=null; let __currentThread=null;

    // ==== UI ====
    function ui(){
      $('#btnBack').onclick=()=>{ history.length>1?history.back():location.href='./profile.html'; };
      $('#btnBulkDelete').onclick=bulkDelete;
      $('#q').oninput=filterList;
      $('#btnSend').onclick=sendMessage;
      $('#msgInput').addEventListener('keydown',(e)=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendMessage(); }});
      $('#btnDeleteThread').onclick=()=>{ if(!__currentThread) return; confirm(t('confirm_delete_one')) && deleteThreadHard(__currentThread.id); };
    }

    function filterList(){ const q=($('#q').value||'').toLowerCase(); if(!q){ __filtered=[...__threads]; } else { __filtered=__threads.filter(x=> (x.otherName||'').toLowerCase().includes(q) || (x.lastText||'').toLowerCase().includes(q) ); } renderThreadList(); }

    function renderThreadList(){
      const host=$('#threadList'); host.innerHTML='';
      $('#emptyBox').style.display = __filtered.length===0 ? 'block' : 'none';
      __filtered.forEach(t=>{
        const row=document.createElement('div'); row.className='th'; row.setAttribute('role','option'); row.dataset.id=t.id;
        row.innerHTML=`
          <input type="checkbox" ${__sel.has(t.id)?'checked':''} data-act="sel" aria-label="select" />
          <div class="ava" style="background-image:url('${t.otherAvatar||'/assets/img/avatar-default.png'}')"></div>
          <div style="min-width:0">
            <div class="ttl" title="${escapeHtml(t.otherName||'')}">${escapeHtml(t.otherName||'‚Äî')}</div>
            <div class="last">${escapeHtml(t.lastText||'')}</div>
          </div>
          <div class="meta">
            <button class="btn ghost" data-act="open" title="A√ß">‚û§</button>
          </div>`;
        row.querySelector('[data-act="sel"]').addEventListener('change',(e)=>{ if(e.target.checked){ __sel.add(t.id);} else { __sel.delete(t.id);} });
        row.querySelector('[data-act="open"]').addEventListener('click',()=>openThread(t.id));
        row.addEventListener('click',(e)=>{ if(e.target.closest('[data-act]')||e.target.type==='checkbox') return; openThread(t.id); });
        host.appendChild(row);
      });
    }

    async function bulkDelete(){
      if(__sel.size===0) return;
      if(!confirm(t('confirm_delete_many'))) return;
      const ids=[...__sel];
      for(const id of ids){ await deleteThreadHard(id); }
      __sel.clear(); renderThreadList();
      toast('‚úì');
    }

    async function deleteThreadHard(threadId){
      try{
        if(__unsubItems){ try{__unsubItems();}catch{} __unsubItems=null; }
        const {collection,doc,getDocs,deleteDoc,query,orderBy,limit,startAfter} = await import('https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js');
        const root=doc(window.__fb.db,'messages',threadId);
        const itemsCol=collection(window.__fb.db,'messages',threadId,'items');
        let last=null; const CHUNK=400;
        while(true){
          let q=query(itemsCol, orderBy('createdAt','asc'), last? startAfter(last): undefined, limit(CHUNK));
          const snap=await getDocs(q);
          if(snap.empty) break;
          for(const ds of snap.docs){ await deleteDoc(ds.ref); }
          if(snap.size<CHUNK) break;
          last=snap.docs[snap.docs.length-1];
        }
        await deleteDoc(root);
        if(__currentThread && __currentThread.id===threadId){ __currentThread=null; $('#chatBody').innerHTML=''; $('#chatName').textContent='‚Äî'; $('#chatSub').textContent='‚Äî'; }
      }catch(e){ console.warn('deleteThreadHard',e); toast('Silinemedi'); }
    }

    async function openThread(id){
      try{
        if(__unsubItems){ try{__unsubItems();}catch{} __unsubItems=null; }
        const {doc,getDoc,collection,query,orderBy,onSnapshot} = await import('https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js');
        const ref=doc(window.__fb.db,'messages',id); const snap=await getDoc(ref);
        if(!snap.exists()) { toast('Sohbet bulunamadƒ±'); return; }
        const d=snap.data()||{}; __currentThread={id, ...d};

        const { otherName, otherAvatar } = await resolveOtherFromDoc(id, d);
        $('#chatName').textContent=otherName||'‚Äî';
        $('#chatSub').textContent=d.orderId ? (t('order') + d.orderId) : '‚Äî';
        $('#chatAva').style.backgroundImage=`url('${otherAvatar||'/assets/img/avatar-default.png'}')`;

        const listCol=collection(window.__fb.db,'messages',id,'items');
        __unsubItems=onSnapshot(query(listCol, orderBy('createdAt','asc')),(qsnap)=>{
          const box=$('#chatBody'); box.innerHTML='';
          qsnap.forEach(ds=>{ const m={id:ds.id, ...(ds.data()||{})}; box.appendChild(msgBubble(m)); });
          box.scrollTop=box.scrollHeight;
        },(err)=>{ console.warn('items onSnapshot',err); toast('Mesajlar okunamadƒ±'); });
      }catch(e){ console.warn('openThread',e); toast('A√ßƒ±lamadƒ±'); }
    }

    function msgBubble(m){
      const mine = m.from===__uid;
      const div=document.createElement('div');
      div.className='msg '+(mine?'mine':'theirs');
      div.innerHTML=`<div class="msgRow"><div style="flex:1;white-space:pre-wrap">${escapeHtml(m.text||'')}</div>${mine?'<div class="tools"><button data-act="delmsg" title="Sil">üóëÔ∏è</button></div>':''}</div><div class="mini" style="opacity:.7;margin-top:.2rem">${formatDate(m.createdAt)}</div>`;
      const delBtn=div.querySelector('[data-act="delmsg"]'); if(delBtn){ delBtn.addEventListener('click',()=>{ if(confirm(t('confirm_delete_msg'))) deleteMessage(m); }); }
      return div;
    }

    async function deleteMessage(m){
      try{
        const {doc,deleteDoc} = await import('https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js');
        const ref=doc(window.__fb.db,'messages',__currentThread.id,'items',m.id);
        await deleteDoc(ref); toast('‚úì');
      }catch(e){ console.warn('deleteMessage',e); toast('Hata'); }
    }

    // === Thread yoksa olu≈ütur + g√∂nder ===
    async function ensureThread(meUid, peerUid, meta={}){
      const { doc, getDoc, setDoc, updateDoc, serverTimestamp } =
        await import('https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js');
      const tid = threadIdFromPair(meUid, peerUid);
      const ref = doc(window.__fb.db, 'messages', tid);
      const snap = await getDoc(ref);
      const base = {
        participants: [meUid, peerUid],
        lastText: meta.lastText || '',
        lastAt: serverTimestamp(),
        otherName: meta.otherName || '',
        otherAvatar: meta.otherAvatar || '',
        orderId: meta.orderId || null
      };
      if (!snap.exists()){
        await setDoc(ref, base);     // kurallardaki allowed fields ile birebir
      } else {
        await updateDoc(ref, {       // sadece g√ºvenli meta g√ºncelle
          otherName: base.otherName, otherAvatar: base.otherAvatar, orderId: base.orderId
        });
      }
      return { id: tid, ref };
    }

    async function sendMessage(){
      try{
        const input=$('#msgInput');
        const text=(input.value||'').trim(); if(!text) return;

        // thread hazƒ±r deƒüilse, query‚Äôden peer‚Äôi al ve olu≈ütur
        if(!__currentThread){
          const peerUid = qs('peer');
          if(!peerUid){ toast('Sohbet se√ßin'); return; }
          const meta = { otherName: qs('name')||'', otherAvatar: qs('ava')||'', orderId: qs('order')||null, lastText:text };
          const t = await ensureThread(__uid, peerUid, meta);
          await openThread(t.id);
        }

        // mesajƒ± alt koleksiyona ekle (yalnƒ±zca text, from, createdAt!)
        const {collection,addDoc,serverTimestamp,doc,updateDoc} = await import('https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js');
        await addDoc(collection(window.__fb.db,'messages',__currentThread.id,'items'),{ text, from:__uid, createdAt:serverTimestamp() });
        await updateDoc(doc(window.__fb.db,'messages',__currentThread.id),{ lastText:text, lastAt:serverTimestamp() });
        input.value='';
        const box=$('#chatBody'); box.scrollTop=box.scrollHeight;
      }catch(e){
        console.warn('sendMessage',e);
        toast(e && e.message && /insufficient permissions/i.test(e.message) ? 'ƒ∞zin reddedildi (kurallar): Oturum veya katƒ±lƒ±mcƒ± deƒüil.' : 'Mesaj g√∂nderilemedi');
      }
    }

    // === orders.html‚Äôden gelindiyse otomatik a√ß ===
    async function openOrCreateThreadFromQuery(){
      const peerUid = qs('peer');
      if(!peerUid){ return; }
      const meta = { otherName: decodeURIComponent(qs('name')||''), otherAvatar: qs('ava')||'', orderId: qs('order')||null };
      const t = await ensureThread(__uid, peerUid, meta);
      await openThread(t.id);
      $('#msgInput').focus();
    }

    // ==== SOL Lƒ∞STE ‚Äî ki≈üiler kesin g√∂r√ºns√ºn ====
    async function resolveOtherFromDoc(docId, docData){
      const parts = (docId||'').split('__');
      const otherUid = parts.find(p=>p && p!==__uid) || '';
      let otherName = docData.otherName || '';
      let otherAvatar = docData.otherAvatar || '';
      if(!otherName || !otherAvatar){
        try{
          const { getDoc, doc } = await import('https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js');
          if(otherUid){
            const snap = await getDoc(doc(window.__fb.db,'users',otherUid));
            if(snap.exists()){
              const u=snap.data()||{};
              otherName = otherName || u.name || u.displayName || 'Kullanƒ±cƒ±';
              otherAvatar = otherAvatar || u.avatar || u.photoURL || '/assets/img/avatar-default.png';
            }
          }
        }catch{}
      }
      return { otherUid, otherName, otherAvatar };
    }

    async function watchThreads(uid){
      try{
        if(__unsubThreads){ try{__unsubThreads();}catch{} __unsubThreads=null; }
        const {collection,query,where,onSnapshot,orderBy} = await import('https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js');
        const q=query(
          collection(window.__fb.db,'messages'),
          where('participants','array-contains',uid),
          // lastAt'a g√∂re sƒ±ralama istemiyoruz; client-side sort var.
        );
        __unsubThreads=onSnapshot(q, async (snap)=>{
          const tmp=[];
          for (const ds of snap.docs){
            const d=ds.data()||{};
            const { otherName, otherAvatar } = await resolveOtherFromDoc(ds.id, d);
            tmp.push({ id:ds.id, otherName, otherAvatar, lastText:d.lastText||'', lastAt:d.lastAt||null });
          }
          tmp.sort((a,b)=>{
            const ta = a.lastAt?.toMillis ? a.lastAt.toMillis() : (a.lastAt? new Date(a.lastAt).getTime():0);
            const tb = b.lastAt?.toMillis ? b.lastAt.toMillis() : (b.lastAt? new Date(b.lastAt).getTime():0);
            return (tb||0)-(ta||0);
          });
          __threads = tmp;
          __filtered=[...__threads]; renderThreadList();

          if(!qs('peer') && !__currentThread && __threads[0]) openThread(__threads[0].id);
        },(err)=>{ console.warn('threads onSnapshot',err); toast('Sohbetler okunamadƒ±'); });
      }catch(e){ console.warn('watchThreads',e); toast('Liste a√ßƒ±lamadƒ±'); }
    }

    // ==== Boot ====
    function boot(){ applyI18n(); ui(); }
    (function init(){
      if(document.readyState==='loading'){ document.addEventListener('DOMContentLoaded', boot); } else { boot(); }
      (function waitForFirebase(){
        if(!window.__fb){ setTimeout(waitForFirebase,50); return; }
        const {auth,onAuthStateChanged} = window.__fb;
        onAuthStateChanged(auth, async (u)=>{
          if(!u){ location.href='./index.html'; return; }
          __uid=u.uid;
          await watchThreads(__uid);
          await openOrCreateThreadFromQuery();
        });
      })();
    })();
  </script>
</body>
</html>
