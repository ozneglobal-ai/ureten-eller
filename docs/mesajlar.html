<!DOCTYPE html>
<html lang="tr" dir="ltr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title data-i18n="title">Mesajlar ‚Ä¢ √úreten Eller</title>
  <link rel="icon" href="/assets/icons/favicon.png" />
  <style>
    :root{ --bg1:#0b1220; --bg2:#0a0f1c; --ink:#e5e7eb; --muted:#9ca3af; --accent:#22d3ee; --brd:#1f2937; --card:#0e172a; --card2:#0b1326; }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:radial-gradient(1200px 600px at 20% -10%,#10213f22,transparent),linear-gradient(180deg,var(--bg1),var(--bg2));color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,'Noto Sans',sans-serif;max-width:100%;overflow-x:hidden}
    a{color:inherit;text-decoration:none}

    .wrap{max-width:1280px;margin:0 auto;padding:1rem}
    .top{display:flex;align-items:center;gap:.75rem;flex-wrap:wrap}
    .logo{display:flex;align-items:center;gap:.5rem;font-weight:900}
    .logo img{width:32px;height:32px}
    .spacer{flex:1}
    .btn{display:inline-flex;align-items:center;gap:.4rem;padding:.55rem .85rem;border:1px solid var(--brd);border-radius:12px;background:#0b1220;color:var(--ink);font-weight:800;cursor:pointer}
    .btn.primary{background:linear-gradient(180deg,#10b981,#128473);border-color:#0e766e}
    .btn.warn{background:linear-gradient(180deg,#f59e0b,#7a5408);border-color:#7a5408}
    .btn.danger{background:linear-gradient(180deg,#ef4444,#7a1b1b);border-color:#7a1b1b}
    .btn.ghost{background:transparent}
    .mini{color:var(--muted)}

    .layout{display:grid;grid-template-columns:360px 1fr;gap:1rem}
    @media(max-width:920px){ .layout{grid-template-columns:1fr} .right{order:2} }

    .left{border:1px solid var(--brd);border-radius:16px;background:linear-gradient(145deg,var(--card),var(--card2));display:flex;flex-direction:column;min-height:70vh}
    .leftHead{display:flex;gap:.5rem;align-items:center;justify-content:space-between;padding:.6rem;border-bottom:1px solid var(--brd)}
    .search{flex:1;background:#0a0f1c;border:1px solid var(--brd);color:var(--ink);border-radius:10px;padding:.5rem}
    .threadList{overflow:auto}
    .th{display:grid;grid-template-columns:auto 1fr auto;gap:.6rem;padding:.6rem;border-bottom:1px solid var(--brd);cursor:pointer}
    .th:hover{background:#0b1220}
    .th .ava{width:42px;height:42px;border-radius:50%;background:#111827;border:1px solid var(--brd);background-size:cover;background-position:center}
    .th .ttl{font-weight:800}
    .th .last{color:#cbd5e1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:320px}
    .th .meta{display:flex;gap:.5rem;align-items:center}
    .th input[type="checkbox"]{width:18px;height:18px}

    .right{border:1px solid var(--brd);border-radius:16px;background:linear-gradient(145deg,var(--card),var(--card2));display:flex;flex-direction:column;min-height:70vh}
    .chatHead{display:flex;align-items:center;justify-content:space-between;padding:.6rem;border-bottom:1px solid var(--brd)}
    .chatTitle{display:flex;align-items:center;gap:.6rem}
    .chatBody{flex:1;overflow:auto;padding:.8rem;display:flex;flex-direction:column;gap:.5rem}
    .msg{max-width:70%;padding:.55rem .7rem;border:1px solid var(--brd);border-radius:14px}
    .mine{align-self:flex-end;background:#0c1426}
    .theirs{align-self:flex-start;background:#0b1220}
    .msgRow{display:flex;gap:.4rem;align-items:center}
    .msg .tools{opacity:.7}
    .msg .tools button{border:0;background:transparent;color:#94a3b8;cursor:pointer}
    .msg .tools button:hover{color:#fff}

    .chatSend{display:flex;gap:.5rem;padding:.6rem;border-top:1px solid var(--brd)}
    .inp{flex:1;background:#0a0f1c;border:1px solid var(--brd);color:var(--ink);border-radius:10px;padding:.6rem}

    .notice{border:1px dashed var(--brd);border-radius:14px;padding:.7rem .8rem;background:#0c1426;margin:.8rem}
    .toast{position:fixed;left:50%;bottom:80px;transform:translateX(-50%);background:#0b1220;border:1px solid var(--brd);padding:.5rem .75rem;border-radius:10px;font-weight:800;z-index:1200;display:none}
  </style>
  <!-- docs/ altƒ±nda √ßalƒ±≈ütƒ±ƒüƒ± i√ßin baƒüƒ±l yol -->
  <script type="module" src="./firebase-init.js"></script>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="logo">
        <img src="./√ºreteneller.png" alt="logo" />
        <span data-i18n="brand">√úreten Eller</span>
      </div>
      <div class="spacer"></div>
      <button class="btn ghost" id="btnBack" type="button">‚Üê <span data-i18n="back">Profile D√∂n</span></button>
    </div>

    <div class="layout">
      <aside class="left">
        <div class="leftHead">
          <input id="q" class="search" placeholder="Ara‚Ä¶" />
          <input id="selectAll" type="checkbox" title="T√ºm√ºn√º se√ß" />
          <button class="btn danger" id="btnBulkDelete" type="button" title="Se√ßili Sil">üóëÔ∏è <span data-i18n="bulk_delete">Se√ßili Sil</span></button>
        </div>
        <div id="threadList" class="threadList" role="listbox" aria-label="Sohbetler"></div>
      </aside>

      <section class="right">
        <header class="chatHead">
          <div class="chatTitle">
            <div id="chatAva" class="ava" style="width:36px;height:36px;border-radius:50%;background:#111827;border:1px solid var(--brd)"></div>
            <div>
              <div id="chatName" class="ttl">‚Äî</div>
              <div id="chatSub" class="mini">‚Äî</div>
            </div>
          </div>
          <div class="row">
            <button class="btn warn" id="btnDeleteThread" type="button">üóëÔ∏è <span data-i18n="delete_thread">Sohbeti Sil</span></button>
          </div>
        </header>
        <div id="chatBody" class="chatBody"></div>
        <div class="chatSend">
          <input id="msgInput" class="inp" placeholder="Mesaj yaz‚Ä¶" />
          <button class="btn primary" id="btnSend" type="button">G√∂nder</button>
        </div>
      </section>
    </div>

    <div id="emptyBox" class="notice mini" style="display:none">Hen√ºz mesaj yok.</div>
  </div>

  <div id="toast" class="toast" role="status"></div>

  <script>
    // ===== I18N =====
    const I18N={
      tr:{title:'Mesajlar ‚Ä¢ √úreten Eller',brand:'√úreten Eller',back:'Profile D√∂n',bulk_delete:'Se√ßili Sil',delete_thread:'Sohbeti Sil',confirm_delete_many:'Se√ßili sohbetler tamamen silinsin mi? (Kar≈üƒ± tarafta da yok olacak)',confirm_delete_one:'Bu sohbet tamamen silinsin mi? (Kar≈üƒ± tarafta da yok olacak)',confirm_delete_msg:'Bu mesaj silinsin mi? (Kalƒ±cƒ±)',search:'Ara‚Ä¶',none:'Hen√ºz mesaj yok.',send:'G√∂nder'},
      en:{title:'Messages ‚Ä¢ Ureten Eller',brand:'Ureten Eller',back:'Back to Profile',bulk_delete:'Delete Selected',delete_thread:'Delete Chat',confirm_delete_many:'Delete selected chats permanently for both sides?',confirm_delete_one:'Delete this chat permanently for both sides?',confirm_delete_msg:'Delete this message permanently?',search:'Search‚Ä¶',none:'No messages yet.',send:'Send'}
    };
    const LANG_KEY='ue_lang_v1';
    function getLang(){ try{return localStorage.getItem(LANG_KEY)||'tr';}catch{return 'tr';} }
    function t(k){ const d=I18N[getLang()]||I18N.tr; return d[k]||k; }
    function applyI18n(){ document.title=t('title'); document.querySelectorAll('[data-i18n]').forEach(n=>{const k=n.getAttribute('data-i18n'); n.textContent=t(k);}); const q=document.getElementById('q'); if(q) q.placeholder=t('search'); const mi=document.getElementById('msgInput'); if(mi) mi.placeholder=t('send'); document.getElementById('emptyBox').textContent=t('none'); }

    const $=(s)=>document.querySelector(s);
    function toast(msg){ const el=$('#toast'); el.textContent=msg; el.style.display='block'; clearTimeout(window.__to); window.__to=setTimeout(()=>el.style.display='none',1500); }

    let __uid=null; let __threads=[]; let __filtered=[]; let __sel=new Set(); let __unsubThreads=null; let __unsubItems=null; let __currentThread=null;

    // ===== Utils =====
    function threadIdFromPair(a,b){ return [a,b].sort().join('__'); }
    function escapeHtml(s){ return (s||'').replace(/[&<>"']/g,(c)=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c])); }
    function formatDate(ts){ try{ if(!ts) return '‚Äî'; const d=ts.toDate?ts.toDate():new Date(ts); return d.toLocaleString('tr-TR'); }catch{ return '‚Äî'; } }
    function getParam(name){ const u=new URL(location.href); return u.searchParams.get(name); }

    // ===== UI =====
    function ui(){
      $('#btnBack').onclick=()=>{ history.length>1?history.back():location.href='./profile.html'; };
      $('#btnBulkDelete').onclick=bulkDelete;
      $('#selectAll').onchange=(e)=>{ if(e.target.checked){ __filtered.forEach(t=>__sel.add(t.id)); } else { __sel.clear(); } renderThreadList(); };
      $('#q').oninput=filterList;
      $('#btnSend').onclick=sendMessage;
      $('#btnDeleteThread').onclick=()=>{ if(!__currentThread) return; confirm(t('confirm_delete_one')) && deleteThreadHard(__currentThread.id); };
    }

    function filterList(){ const q=($('#q').value||'').toLowerCase(); if(!q){ __filtered=[...__threads]; } else { __filtered=__threads.filter(x=> (x.otherName||'').toLowerCase().includes(q) || (x.lastText||'').toLowerCase().includes(q) ); } renderThreadList(); }

    function renderThreadList(){
      const host=$('#threadList'); host.innerHTML='';
      if(__filtered.length===0){ $('#emptyBox').style.display='block'; } else { $('#emptyBox').style.display='none'; }
      __filtered.forEach(t=>{
        const row=document.createElement('div'); row.className='th'; row.setAttribute('role','option'); row.dataset.id=t.id;
        row.innerHTML=`
          <input type="checkbox" ${__sel.has(t.id)?'checked':''} data-act="sel" aria-label="select" />
          <div class="ava" style="background-image:url('${t.otherAvatar||'/assets/img/avatar-default.png'}')"></div>
          <div style="min-width:0">
            <div class="ttl" title="${escapeHtml(t.otherName||'')}">${escapeHtml(t.otherName||'‚Äî')}</div>
            <div class="last">${escapeHtml(t.lastText||'')}</div>
          </div>
          <div class="meta">
            <button class="btn ghost" data-act="open" title="A√ß">‚û§</button>
            <button class="btn ghost" data-act="delete" title="Sil">üóëÔ∏è</button>
          </div>`;
        row.querySelector('[data-act="sel"]').addEventListener('change',(e)=>{ if(e.target.checked){ __sel.add(t.id);} else { __sel.delete(t.id);} });
        row.querySelector('[data-act="open"]').addEventListener('click',()=>openThread(t.id));
        row.querySelector('[data-act="delete"]').addEventListener('click',()=>{ confirm(t('confirm_delete_one')) && deleteThreadHard(t.id); });
        row.addEventListener('click',(e)=>{ if(e.target.closest('[data-act]')||e.target.type==='checkbox') return; openThread(t.id); });
        host.appendChild(row);
      });
    }

    async function bulkDelete(){ if(__sel.size===0) return; if(!confirm(t('confirm_delete_many'))) return; const ids=[...__sel]; for(const id of ids){ await deleteThreadHard(id); } __sel.clear(); $('#selectAll').checked=false; }

    async function deleteThreadHard(threadId){
      try{
        if(__unsubItems){ try{__unsubItems();}catch{} __unsubItems=null; }
        const {collection,doc,getDocs,deleteDoc,query,orderBy,limit,startAfter} = await import('https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js');
        const root=doc(window.__fb.db,'messages',threadId);
        // Sil: items alt koleksiyonu par√ßa par√ßa
        const itemsCol=collection(window.__fb.db,'messages',threadId,'items');
        let last=null; const CHUNK=400;
        while(true){
          let q=query(itemsCol, orderBy('createdAt','asc'), last? startAfter(last): undefined, limit(CHUNK));
          const snap=await getDocs(q);
          if(snap.empty) break;
          const batchOps=[]; let i=0;
          for(const ds of snap.docs){ batchOps.push(deleteDoc(ds.ref)); i++; last=ds; }
          for(const op of batchOps){ await op; }
          if(i<CHUNK) break;
        }
        await deleteDoc(root);
        toast('‚úì');
        if(__currentThread && __currentThread.id===threadId){ __currentThread=null; $('#chatBody').innerHTML=''; $('#chatName').textContent='‚Äî'; $('#chatSub').textContent='‚Äî'; }
      }catch(e){ console.warn('deleteThreadHard',e); toast('Hata'); }
    }

    async function openThread(id){
      try{
        if(__unsubItems){ try{__unsubItems();}catch{} __unsubItems=null; }
        const {doc,getDoc,collection,query,orderBy,onSnapshot} = await import('https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js');
        const ref=doc(window.__fb.db,'messages',id); const snap=await getDoc(ref); if(!snap.exists()) { toast('Sohbet bulunamadƒ±'); return; }
        const d=snap.data()||{}; __currentThread={id, ...d};
        $('#chatName').textContent=d.otherName||'Sohbet';
        $('#chatSub').textContent=d.orderId? ('Sipari≈ü #'+d.orderId) : '';
        $('#chatAva').style.backgroundImage=`url('${d.otherAvatar||'/assets/img/avatar-default.png'}')`;

        const listCol=collection(window.__fb.db,'messages',id,'items');
        __unsubItems=onSnapshot(query(listCol, orderBy('createdAt','asc')),(qs)=>{
          const box=$('#chatBody'); box.innerHTML=''; qs.forEach(ds=>{ const m={id:ds.id, ...(ds.data()||{})}; box.appendChild(msgBubble(m)); }); box.scrollTop=box.scrollHeight; });
      }catch(e){ console.warn('openThread',e); }
    }

    function msgBubble(m){
      const mine = m.from===__uid;
      const div=document.createElement('div');
      div.className='msg '+(mine?'mine':'theirs');
      div.innerHTML=`<div class="msgRow"><div style="flex:1;white-space:pre-wrap">${escapeHtml(m.text||'')}</div><div class="tools">${mine?'<button data-act="delmsg" title="Sil">üóëÔ∏è</button>':''}</div></div><div class="mini" style="opacity:.7;margin-top:.2rem">${formatDate(m.createdAt)}</div>`;
      const delBtn=div.querySelector('[data-act="delmsg"]'); if(delBtn){ delBtn.addEventListener('click',()=>{ if(confirm(t('confirm_delete_msg'))) deleteMessage(m); }); }
      return div;
    }

    async function deleteMessage(m){
      try{
        const {doc,deleteDoc} = await import('https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js');
        const ref=doc(window.__fb.db,'messages',__currentThread.id,'items',m.id);
        await deleteDoc(ref); toast('‚úì');
      }catch(e){ console.warn('deleteMessage',e); toast('Hata'); }
    }

    // ===== Thread olu≈ütur / garantile =====
    async function ensureThread(buyerUid, sellerUid, meta={}){
      const { doc, getDoc, setDoc, serverTimestamp } =
        await import('https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js');
      const tid = threadIdFromPair(buyerUid, sellerUid);
      const ref = doc(window.__fb.db, 'messages', tid);
      const snap = await getDoc(ref);
      if (!snap.exists()){
        await setDoc(ref, {
          participants: [buyerUid, sellerUid],
          lastText: meta.lastText || '',
          lastAt: serverTimestamp(),
          otherName: meta.otherName || '',
          otherAvatar: meta.otherAvatar || '',
          orderId: meta.orderId || null
        });
      }
      return { id: tid, ref };
    }

    // ===== Mesaj g√∂nder =====
    async function sendMessage(){
      try{
        const text=($('#msgInput').value||'').trim(); if(!text) return;
        if (!__currentThread){
          // ƒ∞lk kez gelmi≈ü olabilir ‚Üí URL ile peer bilgisi ta≈üƒ±ndƒ±ysa thread a√ß
          const peerUid = getParam('peer');
          if(peerUid){
            const meta = { lastText: text, otherName: getParam('name')||'', otherAvatar: getParam('ava')||'', orderId: getParam('order')||null };
            const t = await ensureThread(__uid, peerUid, meta);
            __currentThread = { id: t.id };
          } else {
            toast('Kar≈üƒ± taraf bulunamadƒ±'); return;
          }
        }
        const { collection, addDoc, serverTimestamp, doc, updateDoc } =
          await import('https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js');
        await addDoc(collection(window.__fb.db,'messages',__currentThread.id,'items'),{ createdAt:serverTimestamp(), from:__uid, text });
        await updateDoc(doc(window.__fb.db,'messages',__currentThread.id),{ lastText:text, lastAt:serverTimestamp() });
        $('#msgInput').value='';
      }catch(e){ console.warn('sendMessage',e); }
    }

    // ===== Sohbet listesi (indekssiz) =====
    async function watchThreads(uid){
      try{
        if(__unsubThreads){ try{__unsubThreads();}catch{} __unsubThreads=null; }
        const {collection,query,where,onSnapshot} = await import('https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js');
        const q=query(collection(window.__fb.db,'messages'), where('participants','array-contains',uid));
        __unsubThreads=onSnapshot(q,(snap)=>{
          __threads=[]; snap.forEach(ds=>{ const d=ds.data()||{}; __threads.push({ id:ds.id, otherName:d.otherName||'', otherAvatar:d.otherAvatar||'', lastText:d.lastText||'', lastAt:d.lastAt||null }); });
          // istemci tarafƒ± sƒ±rala (lastAt desc)
          __threads.sort((a,b)=>{ const ta=a.lastAt?.toMillis? a.lastAt.toMillis():(new Date(a.lastAt||0)).getTime(); const tb=b.lastAt?.toMillis? b.lastAt.toMillis():(new Date(b.lastAt||0)).getTime(); return (tb||0)-(ta||0); });
          __filtered=[...__threads]; renderThreadList();
          if(!__currentThread && __threads[0]) openThread(__threads[0].id);
        },(err)=>{ console.warn('threads onSnapshot',err); });
      }catch(e){ console.warn('watchThreads',e); }
    }

    // ===== URL ile otomatik thread a√ß (√∂rn. ilan sayfasƒ±ndan geldi) =====
    async function openOrCreateThreadFromQuery(){
      const peerUid = getParam('peer');
      if(!peerUid) return; // doƒürudan sayfaya geldiyse pas
      const meta = { otherName: getParam('name')||'', otherAvatar: getParam('ava')||'', orderId: getParam('order')||null };
      const t = await ensureThread(__uid, peerUid, meta);
      await openThread(t.id);
    }

    function boot(){ applyI18n(); ui(); }

    (function init(){
      if(document.readyState==='loading'){ document.addEventListener('DOMContentLoaded', boot); } else { boot(); }
      (function waitForFirebase(){
        if(!window.__fb){ setTimeout(waitForFirebase,50); return; }
        const {auth,onAuthStateChanged} = window.__fb;
        onAuthStateChanged(auth, async (u)=>{
          if(!u){ location.href='./index.html'; return; }
          __uid=u.uid;
          await watchThreads(__uid);
          await openOrCreateThreadFromQuery();
        });
      })();
    })();
  </script>
</body>
</html>
