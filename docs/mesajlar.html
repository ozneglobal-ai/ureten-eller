<!DOCTYPE html>
<html lang="tr" dir="ltr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mesajlar ‚Ä¢ √úreten Eller</title>
  <link rel="icon" href="./assets/icons/favicon.png" />
  <style>
    :root{ --bg1:#0b1220; --bg2:#0a0f1c; --ink:#e5e7eb; --muted:#9ca3af; --accent:#22d3ee; --ok:#10b981; --warn:#f59e0b; --err:#ef4444; --brd:#1f2937; --card:#0e172a; --card2:#0b1326 }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:linear-gradient(180deg,var(--bg1),var(--bg2));color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,'Noto Sans',sans-serif;max-width:100%;overflow:hidden}

    .page{height:100vh;display:grid;grid-template-columns:320px 1fr;gap:10px;padding:10px}
    @media(max-width:900px){ .page{grid-template-columns:1fr} }

    .panel{border:1px solid var(--brd);border-radius:14px;background:linear-gradient(145deg,var(--card),var(--card2));overflow:hidden;position:relative}

    /* Sol: thread list */
    .left{display:flex;flex-direction:column}
    .topbar{position:sticky;top:0;z-index:10;display:flex;align-items:center;gap:8px;padding:10px;border-bottom:1px solid var(--brd);background:linear-gradient(145deg,var(--card),var(--card2))}
    .logo{display:flex;align-items:center;gap:.5rem;font-weight:900}
    .logo img{width:24px;height:24px}
    .spacer{flex:1}
    .btn{display:inline-flex;align-items:center;gap:.45rem;padding:.5rem .8rem;border:1px solid var(--brd);border-radius:10px;background:#0b1220;color:var(--ink);font-weight:800;cursor:pointer;white-space:nowrap}
    .btn.ghost{background:transparent}
    .btn.accent{background:linear-gradient(180deg,#22d3ee,#0ea5b3);color:#042026;border-color:#0ea5b3}
    .btn.primary{background:linear-gradient(180deg,#10b981,#128473);border-color:#0e766e}
    .btn.danger{background:linear-gradient(180deg,#ef4444,#7a1b1b);border-color:#7a1b1b;color:#fff}

    .actions{display:flex;gap:6px;flex-wrap:wrap}
    .search{padding:8px 10px;border-bottom:1px solid var(--brd)}
    .search input{width:100%;border:1px solid var(--brd);border-radius:10px;background:#0b1326;color:var(--ink);padding:10px}

    #threads{overflow:auto;flex:1}
    .empty{padding:12px;color:var(--muted);text-align:center}
    .th{display:grid;grid-template-columns:44px 1fr auto;gap:8px;padding:10px;border-bottom:1px solid var(--brd);cursor:pointer}
    .th:hover{background:rgba(255,255,255,.03)}
    .ava{width:44px;height:44px;border-radius:10px;border:1px solid var(--brd);background:#111827 center/cover no-repeat}
    .thTitle{font-weight:800}
    .thSub{color:var(--muted);font-size:.92rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:220px}
    .thTime{color:var(--muted);font-size:.8rem;min-width:80px;text-align:right}

    /* Saƒü: chat */
    .right{display:grid;grid-template-rows:auto 1fr auto}
    .chatTop{display:flex;align-items:center;gap:10px;padding:10px;border-bottom:1px solid var(--brd)}
    .chatTop .name{font-weight:900;cursor:pointer}
    .chatTop .mini{color:var(--muted);font-size:.9rem}
    .chatBody{overflow:auto;padding:12px;display:flex;flex-direction:column;gap:8px}
    .msg{max-width:70%;padding:10px 12px;border:1px solid var(--brd);border-radius:12px;background:#0b1326;white-space:pre-wrap}
    .me{align-self:flex-end;background:#0e2233}
    .other{align-self:flex-start}
    .chatInput{display:flex;gap:8px;padding:10px;border-top:1px solid var(--brd)}
    .chatInput input{flex:1;border:1px solid var(--brd);border-radius:10px;background:#0b1326;color:var(--ink);padding:10px}
    .chatInput button{border:1px solid var(--brd);border-radius:10px;background:var(--accent);color:#03222a;font-weight:900;padding:10px 14px;cursor:pointer}

    .pill{display:inline-flex;align-items:center;gap:.35rem;padding:.25rem .6rem;border:1px solid var(--brd);border-radius:999px}
    .pill.badge{background:#0b1326}
  </style>

  <!-- K√ñKTEKƒ∞ init (mutlaka k√∂k) -->
  <script type="module" src="/firebase-init.js"></script>
</head>
<body>
  <div class="page">
    <!-- LEFT: THREADS -->
    <div class="panel left">
      <div class="topbar">
        <div class="logo">
          <img src="./√ºreteneller.png" alt="logo" />
          <span>√úreten Eller</span>
        </div>
        <div class="spacer"></div>
        <div class="actions">
          <button class="btn ghost" id="btnHome" type="button">üè† Ana sayfa</button>
          <button class="btn accent" id="btnNotif" type="button">üîî <span id="notifLbl">Bildirimleri A√ß</span></button>
          <button class="btn primary" id="btnSound" type="button">üîä <span id="soundLbl">Sesi A√ß</span></button>
        </div>
      </div>

      <div class="search">
        <input id="search" placeholder="Ki≈üi veya mesaj ara" />
      </div>

      <div id="threads">
        <div class="empty">Konu≈üma yok.</div>
      </div>
    </div>

    <!-- RIGHT: CHAT -->
    <div class="panel right">
      <div class="chatTop">
        <div id="peerAva" class="ava"></div>
        <div style="flex:1">
          <div class="name" id="peerName" title="Profili a√ß">Ki≈üi se√ßin</div>
          <div class="mini" id="peerInfo">‚Äî</div>
        </div>
        <div class="pill badge" id="unreadBadge" title="Okunmamƒ±≈ü mesaj">0</div>
        <button class="btn danger" id="btnDeleteThread" title="Konu≈ümayƒ± kalƒ±cƒ± sil (mesajlar dahil)">üóë Konu≈ümayƒ± Sil</button>
      </div>

      <div id="chat" class="chatBody" aria-live="polite">
        <div class="empty">Soldan bir konu≈üma se√ßin.</div>
      </div>

      <div class="chatInput">
        <input id="msgInput" placeholder="Mesaj yazƒ±n‚Ä¶" />
        <button id="btnSend">G√∂nder</button>
      </div>
    </div>
  </div>

  <audio id="ding" preload="auto" src="./notify.wav"></audio>

  <script>
    // ========= Utilities =========
    const $ = (s)=> document.querySelector(s);
    const qs = (k)=> new URLSearchParams(location.search).get(k)||'';
    function fmtDate(ts){
      try{ const d = ts?.toDate ? ts.toDate() : (ts? new Date(ts): null); return d? d.toLocaleString('tr-TR'):''; }catch{ return ''; }
    }
    function escapeHtml(x){ return (x||'').replace(/[<>&]/g, s=>({ '<':'&lt;','>':'&gt;','&':'&amp;' }[s])); }

    // Firebase helpers (dinamik import)
    async function api(){
      const mod = await import('https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js');
      return mod;
    }

    let __me=null;
    let __threadsUnsub=null;
    let __msgsUnsub=null;
    let __curThreadId=null;
    let __curPeerUid=null;
    let __ding = null;
    let __lastSeenMap = {}; // threadId -> lastAt millis (ses/rozet kontrol√º)

    // Profil kƒ±sa getirme (ad/ava)
    const _briefCache = new Map();
    async function getUserBrief(uid){
      if(!uid) return { name:'Kullanƒ±cƒ±', avatar:'/assets/img/avatar-default.png' };
      if(_briefCache.has(uid)) return _briefCache.get(uid);
      try{
        const { doc, getDoc } = await api();
        const snap = await getDoc(doc(self.db,'users',uid));
        const d = snap.exists()? (snap.data()||{}) : {};
        const name = [d.name||d.firstName||'', d.surname||d.lastName||''].filter(Boolean).join(' ') || d.displayName || 'Kullanƒ±cƒ±';
        const brief = { name, avatar: d.avatar||d.photoURL||'/assets/img/avatar-default.png' };
        _briefCache.set(uid, brief);
        return brief;
      }catch{ return { name:'Kullanƒ±cƒ±', avatar:'/assets/img/avatar-default.png' }; }
    }

    // ========= Threads render =========
    function renderThreadsSnapshotLike(snap){
      const listEl = $('#threads');
      const rows = [];
      snap.forEach(ds=>{
        const d = ds.data()||{};
        const arr = d.participants||[];
        const otherUid = arr.find(x=>x!==__me.uid) || '';
        rows.push({ id: ds.id, d, otherUid });
      });

      // Client-side sƒ±ralama (lastAt desc) ‚Äî index gerektirmez
      rows.sort((a,b)=>{
        const ta = a.d.lastAt?.toMillis ? a.d.lastAt.toMillis() : (a.d.lastAt? new Date(a.d.lastAt).getTime():0);
        const tb = b.d.lastAt?.toMillis ? b.d.lastAt.toMillis() : (b.d.lastAt? new Date(b.d.lastAt).getTime():0);
        return (tb||0) - (ta||0);
      });

      const qtxt = ($('#search')?.value||'').trim().toLowerCase();
      listEl.innerHTML = rows.length ? '' : '<div class="empty">Konu≈üma yok.</div>';

      (async ()=>{
        for(const r of rows){
          const other = await getUserBrief(r.otherUid);
          if(qtxt && !(other.name||'').toLowerCase().includes(qtxt) && !(r.d.lastText||'').toLowerCase().includes(qtxt)) continue;

          const t = document.createElement('div');
          t.className='th'; t.dataset.id=r.id;
          t.innerHTML = `
            <div class="ava" style="background-image:url('${other.avatar||'/assets/img/avatar-default.png'}')"></div>
            <div>
              <div class="thTitle">${escapeHtml(other.name||'Kullanƒ±cƒ±')}</div>
              <div class="thSub">${escapeHtml(r.d.lastText||'')}</div>
            </div>
            <div class="thTime">${r.d.lastAt? fmtDate(r.d.lastAt):''}</div>
          `;
          t.onclick = ()=> openThread(r.id, r.otherUid, other);
          listEl.appendChild(t);

          // yeni mesaj sesi (benden deƒüilse)
          const lastMillis = r.d.lastAt?.toMillis ? r.d.lastAt.toMillis() : (r.d.lastAt? new Date(r.d.lastAt).getTime():0);
          const prev = __lastSeenMap[r.id] || 0;
          if(lastMillis && lastMillis > prev && r.d.lastText && r.d.lastFrom && r.d.lastFrom !== __me.uid){
            try{ __ding && __ding.play().catch(()=>{}); }catch{}
          }
          __lastSeenMap[r.id] = lastMillis || prev;
        }
      })();
    }

    // ========= LISTEN THREADS (orderBy YOK ‚Üí index gerekmez) =========
    async function listenThreads(){
      if(__threadsUnsub){ __threadsUnsub(); __threadsUnsub=null; }
      const {collection, query, where, onSnapshot, getDocs} = await api();
      const baseQ = query(collection(self.db,'messages'), where('participants','array-contains', __me.uid));

      const listEl = $('#threads');
      listEl.innerHTML = '<div class="empty">Y√ºkleniyor‚Ä¶</div>';

      try{
        __threadsUnsub = onSnapshot(baseQ, (snap)=> renderThreadsSnapshotLike(snap), async (err)=>{
          console.warn('Threads listen error:', err);
          const snap2 = await getDocs(baseQ);
          renderThreadsSnapshotLike(snap2);
        });
      }catch(err){
        console.warn('Threads bind failed:', err);
        const snap2 = await getDocs(baseQ);
        renderThreadsSnapshotLike(snap2);
      }
    }

    // ========= Chat (right) =========
    async function listenMessages(threadId){
      if(__msgsUnsub){ __msgsUnsub(); __msgsUnsub=null; }
      const { collection, query, orderBy, onSnapshot } = await api();
      // Tek alan orderBy (createdAt) ‚Üí otomatik tekil indeks yeter
      const q = query(collection(self.db,'messages', threadId, 'items'), orderBy('createdAt','asc'));
      const chat = $('#chat');
      chat.innerHTML = '';
      __msgsUnsub = onSnapshot(q, (snap)=>{
        chat.innerHTML = '';
        snap.forEach(ds=>{
          const m = ds.data()||{};
          const div = document.createElement('div');
          div.className = 'msg ' + (m.from === __me.uid ? 'me':'other');
          div.textContent = m.text || '';
          chat.appendChild(div);
        });
        chat.scrollTop = chat.scrollHeight;
      }, (err)=>{ console.warn('listenMessages error:', err); });
    }

    async function openThread(threadId, peerUid, peerBrief=null){
      __curThreadId = threadId;
      __curPeerUid  = peerUid;
      const info = peerBrief || await getUserBrief(peerUid);
      $('#peerAva').style.backgroundImage = `url('${info.avatar||'/assets/img/avatar-default.png'}')`;
      $('#peerName').textContent = info.name || 'Kullanƒ±cƒ±';
      $('#peerInfo').textContent = peerUid;
      $('#peerName').onclick = ()=> { location.href = `/docs/profile.html?uid=${encodeURIComponent(peerUid)}`; };

      // seen damgasƒ±
      try{
        const { doc, updateDoc, serverTimestamp } = await api();
        const ref = doc(self.db,'messages',threadId);
        await updateDoc(ref, { [`seen.${__me.uid}`]: serverTimestamp() });
      }catch(e){/* sessiz */ }

      await listenMessages(threadId);
    }

    async function createOrGetThread(peerUid, otherName='', otherAvatar=''){
      const { collection, query, where, getDocs, doc, setDoc, serverTimestamp } = await api();
      // √∂nce var mƒ±?
      const q = query(collection(self.db,'messages'), where('participants','array-contains', __me.uid));
      const snap = await getDocs(q);
      let found = '';
      snap.forEach(ds=>{
        const arr = (ds.data()?.participants)||[];
        if(arr.includes(peerUid)) found = ds.id;
      });
      if(found) return found;

      // yoksa olu≈ütur
      const participants = [__me.uid, peerUid];
      const ref = doc(self.db, 'messages', crypto.randomUUID ? crypto.randomUUID() : (Date.now().toString(36)+Math.random().toString(36).slice(2,8)));
      await setDoc(ref, {
        participants, lastText:'', lastAt: serverTimestamp(),
        otherName: otherName || '', otherAvatar: otherAvatar || ''
      });
      return ref.id;
    }

    async function sendMessage(){
      const text = ($('#msgInput').value||'').trim();
      if(!text || !__curThreadId) return;
      $('#msgInput').value = '';
      try{
        const { collection, addDoc, serverTimestamp, doc, updateDoc } = await api();
        await addDoc(collection(self.db,'messages',__curThreadId,'items'),{
          text, from: __me.uid, createdAt: serverTimestamp()
        });
        // thread son √∂zet
        await updateDoc(doc(self.db,'messages',__curThreadId),{
          lastText: text, lastAt: serverTimestamp(), lastFrom: __me.uid
        });
      }catch(err){ console.warn('sendMessage error:', err); }
    }

    // ========= KALICI Sƒ∞L (konu≈üma + alt mesajlar) =========
    async function deleteCurrentThread(){
      if(!__curThreadId || !__me) return;
      if(!confirm('Bu konu≈ümayƒ± kalƒ±cƒ± olarak silmek istiyor musunuz?')) return;
      try{
        const { collection, getDocs, doc, deleteDoc } = await api();
        // alt mesajlarƒ± sil
        const itemsSnap = await getDocs(collection(self.db,'messages',__curThreadId,'items'));
        const deletes = [];
        itemsSnap.forEach(m => deletes.push(deleteDoc(doc(self.db,'messages',__curThreadId,'items', m.id))));
        await Promise.allSettled(deletes);
        // ana belgeyi sil
        await deleteDoc(doc(self.db,'messages',__curThreadId));
        // UI temizle
        __curThreadId = null; __curPeerUid = null;
        $('#peerAva').style.backgroundImage=''; $('#peerName').textContent='Ki≈üi se√ßin'; $('#peerInfo').textContent='‚Äî';
        $('#chat').innerHTML='<div class="empty">Soldan bir konu≈üma se√ßin.</div>';
        // listeyi yenile
        listenThreads();
      }catch(e){
        console.warn('delete thread fail:', e);
        alert('Silme sƒ±rasƒ±nda hata olu≈ütu.');
      }
    }

    // ========= Bildirim / Ses butonlarƒ± =========
    function ensureNotificationPermission(){
      if(!('Notification' in window)) { alert('Tarayƒ±cƒ±nƒ±z bildirimleri desteklemiyor.'); return; }
      if(Notification.permission === 'granted'){
        $('#notifLbl').textContent = 'Bildirimler aktif';
        return;
      }
      Notification.requestPermission().then(p=>{
        $('#notifLbl').textContent = (p==='granted')? 'Bildirimler aktif' : (p==='denied' ? 'Bildirim engelli' : 'Bildirimleri A√ß');
      }).catch(()=>{});
    }

    function unlockSound(){
      try{
        const a = __ding;
        if(!a) return;
        a.muted = true;
        a.play().then(()=>{ a.pause(); a.currentTime=0; a.muted=false; }).catch(()=>{});
      }catch{}
    }

    // ========= Boot =========
    async function boot(){
      // Auth bekle
      await new Promise((res)=> self.onAuthStateChanged(self.auth, (u)=>{ __me=u||null; res(); }));
      if(!__me){ window.location.href = '/login.html'; return; }

      // Ses
      __ding = document.getElementById('ding');

      // UI hooks
      $('#btnSend').addEventListener('click', sendMessage);
      $('#msgInput').addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ sendMessage(); } });
      $('#btnDeleteThread').addEventListener('click', deleteCurrentThread);
      $('#btnHome').addEventListener('click', (e)=>{ e.preventDefault(); location.href='/home.html'; }); // K√ñK
      $('#btnNotif').addEventListener('click', ensureNotificationPermission);
      $('#btnSound').addEventListener('click', unlockSound);
      $('#search').addEventListener('input', ()=> listenThreads()); // filtre i√ßin yeniden render

      // URL‚Äôden otomatik ba≈ülatma (seller sayfasƒ±ndan gelir)
      const urlPeer = qs('peer');
      if(urlPeer){
        const name = qs('name') ? decodeURIComponent(qs('name')) : '';
        const ava  = qs('ava') || '';
        try{
          const tid = await createOrGetThread(urlPeer, name, ava);
          openThread(tid, urlPeer);
        }catch{ /* sessiz */ }
        // query‚Äôi temizle
        history.replaceState({}, document.title, location.pathname);
      }

      // threads dinle
      listenThreads();

      // bildirim etiketi
      if('Notification' in window){
        $('#notifLbl').textContent = Notification.permission==='granted' ? 'Bildirimler aktif'
                                 : (Notification.permission==='denied' ? 'Bildirim engelli' : 'Bildirimleri A√ß');
      }
    }

    (function init(){
      if(document.readyState==='loading'){
        document.addEventListener('DOMContentLoaded', boot);
      } else { boot(); }
    })();
  </script>
</body>
</html>
