<!DOCTYPE html>
<html lang="tr" dir="ltr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Satƒ±cƒ± ‚Ä¢ √úreten Eller</title>
  <link rel="icon" href="./assets/icons/favicon.png" />
  <style>
    :root{ --bg1:#0b1220; --bg2:#0a0f1c; --ink:#e5e7eb; --muted:#9ca3af; --accent:#22d3ee; --ok:#10b981; --warn:#f59e0b; --err:#ef4444; --brd:#1f2937; --card:#0e172a; --card2:#0b1326 }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:radial-gradient(1200px 600px at 20% -10%,#10213f22,transparent),linear-gradient(180deg,var(--bg1),var(--bg2));color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,'Noto Sans',sans-serif;max-width:100%;overflow-x:hidden}
    a{color:inherit;text-decoration:none}

    .wrap{max-width:1150px;margin:0 auto;padding:1rem}
    .top{display:flex;align-items:center;gap:.75rem;flex-wrap:wrap}
    .logo{display:flex;align-items:center;gap:.5rem;font-weight:900}
    .logo img{width:32px;height:32px}
    .spacer{flex:1}
    .btn{display:inline-flex;align-items:center;gap:.45rem;padding:.55rem .9rem;border:1px solid var(--brd);border-radius:12px;background:#0b1220;color:var(--ink);font-weight:800;cursor:pointer}
    .btn.primary{background:linear-gradient(180deg,#10b981,#128473);border-color:#0e766e}
    .btn.warn{background:linear-gradient(180deg,#f59e0b,#7a5408);border-color:#7a5408}
    .btn.danger{background:linear-gradient(180deg,#ef4444,#7a1b1b);border-color:#7a1b1b}
    .btn.ghost{background:transparent}
    .mini{color:var(--muted)}
    .pill{display:inline-flex;align-items:center;gap:.35rem;padding:.25rem .6rem;border:1px solid var(--brd);border-radius:999px}

    /* Profil */
    .profile{margin-top:1rem;display:grid;grid-template-columns:160px 1fr;gap:16px;border:1px solid var(--brd);border-radius:16px;background:linear-gradient(145deg,var(--card),var(--card2));padding:12px}
    .ava{width:160px;height:160px;border-radius:16px;border:1px solid var(--brd);background:#111827;background-size:cover;background-position:center}
    .h1{font-size:1.35rem;font-weight:900;display:flex;align-items:center;gap:.5rem}
    .verBadge{display:inline-flex;align-items:center;gap:.35rem;background:#0b1326;border:1px solid #0e766e;color:#a7f3d0;padding:.15rem .5rem;border-radius:999px;font-weight:800}

    .bio{margin-top:6px;white-space:pre-wrap}

    .row{display:flex;flex-wrap:wrap;gap:.5rem;align-items:center;margin-top:6px}
    .star{font-size:22px;line-height:1;cursor:pointer;opacity:.65;user-select:none}
    .star.active{opacity:1}
    .stats{margin-left:.25rem}

    /* ƒ∞lanlar */
    h2{margin:14px 2px 6px}
    .grid{margin-top:10px;display:grid;grid-template-columns:repeat(auto-fill,minmax(230px,1fr));gap:12px}
    .card{border:1px solid var(--brd);border-radius:14px;background:#0b1326;overflow:hidden;cursor:pointer}
    .card .img{width:100%;aspect-ratio:1/1;border-bottom:1px solid var(--brd);background:#111827;background-size:cover;background-position:center}
    .card .body{padding:10px}
    .price{font-weight:900}

    /* Detay √ßekmecesi */
    .drawer{position:fixed;inset:0;display:none;background:#00000080;z-index:1500}
    .drawerInner{position:absolute;right:0;top:0;bottom:0;width:min(680px,100%);background:linear-gradient(145deg,var(--card),var(--card2));border-left:1px solid var(--brd);padding:12px 14px;overflow:auto}
    .drawer .cover{width:100%;aspect-ratio:16/10;border-radius:12px;border:1px solid var(--brd);background:#111827 center/cover no-repeat}
    .thumbs{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .thumbs .t{width:88px;height:88px;border-radius:10px;border:1px solid var(--brd);background:#111827 center/cover no-repeat;cursor:pointer}
    .kv{display:grid;grid-template-columns:140px 1fr;gap:6px;align-items:center;margin-top:6px}
    .closeX{position:absolute;right:12px;top:10px;background:#fff;color:#0b1220;border:none;width:32px;height:32px;border-radius:999px;font-size:18px;line-height:32px;text-align:center;cursor:pointer}

    .toast{position:fixed;left:50%;bottom:80px;transform:translateX(-50%);background:#0b1220;border:1px solid var(--brd);padding:.5rem .75rem;border-radius:10px;font-weight:800;z-index:1600;display:none}
  </style>
  <script type="module" src="./firebase-init.js"></script>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="logo">
        <img src="./√ºreteneller.png" alt="logo" />
        <span>√úreten Eller</span>
      </div>
      <div class="spacer"></div>
      <button class="btn ghost" id="btnBack" type="button">‚Üê Geri</button>
    </div>

    <section class="profile">
      <div id="avatar" class="ava"></div>
      <div>
        <div class="h1">
          <span id="fullName">‚Äî</span>
          <span id="verifiedBadge" class="verBadge" style="display:none">‚úî Onaylƒ± Satƒ±cƒ±</span>
        </div>
        <div class="row mini" style="gap:.6rem;margin-top:.25rem">
          <span id="city" class="pill">‚Äî</span>
          <span id="phone" class="pill">‚Äî</span>
        </div>
        <div class="bio mini" id="bio">‚Äî</div>

        <div class="row" style="gap:.6rem">
          <button id="btnMessage" class="btn warn">üí¨ Mesaj</button>
          <button id="btnLike" class="btn primary">‚ù§ Beƒüen</button>
          <div class="pill" id="ratingBox" aria-label="Puan ver">
            <span class="star" data-s="1">‚òÖ</span>
            <span class="star" data-s="2">‚òÖ</span>
            <span class="star" data-s="3">‚òÖ</span>
            <span class="star" data-s="4">‚òÖ</span>
            <span class="star" data-s="5">‚òÖ</span>
          </div>
          <span class="mini stats" id="stats">‚Äî beƒüeni ‚Ä¢ ‚Äî/5</span>
        </div>
      </div>
    </section>

    <h2>ƒ∞lanlar</h2>
    <section id="listings" class="grid"></section>
  </div>

  <!-- ƒ∞LAN DETAY √áEKMECESƒ∞ -->
  <div id="drawer" class="drawer" role="dialog" aria-modal="true">
    <div class="drawerInner">
      <button class="closeX" id="closeDrawer" aria-label="Kapat">√ó</button>
      <div id="dCover" class="cover"></div>
      <div class="thumbs" id="dThumbs"></div>
      <h3 id="dTitle" style="margin:10px 2px 4px">‚Äî</h3>
      <div class="mini" id="dSub" style="margin-bottom:6px">‚Äî</div>
      <div class="kv"><div class="mini">Fiyat</div><div id="dPrice">‚Äî</div></div>
      <div class="kv"><div class="mini">Stok</div><div id="dStock">‚Äî</div></div>
      <div class="kv"><div class="mini">Konum</div><div id="dLoc">‚Äî</div></div>
      <div class="kv"><div class="mini">Tarih</div><div id="dDate">‚Äî</div></div>
      <div class="kv" style="grid-template-columns:1fr">
        <div class="mini" style="margin-top:4px">A√ßƒ±klama</div>
        <div id="dDesc" style="white-space:pre-wrap"></div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast" role="status"></div>

  <script>
    const $=(s)=>document.querySelector(s);
    const qs=(k)=>new URLSearchParams(location.search).get(k)||'';
    function toast(msg){ const el=$('#toast'); el.textContent=msg; el.style.display='block'; clearTimeout(window.__to); window.__to=setTimeout(()=>el.style.display='none',1600); }
    function fmtTRY(x){ try{ return new Intl.NumberFormat('tr-TR',{style:'currency',currency:'TRY',maximumFractionDigits:0}).format(x||0); }catch{ return (x||0)+' TL'; } }
    function fmtDate(ts){ try{ if(!ts) return '‚Äî'; const d=ts.toDate?ts.toDate():new Date(ts); return d.toLocaleString('tr-TR'); }catch{ return '‚Äî'; } }
    function maskPhone(p){ if(!p) return '‚Äî'; const d=(p+'').replace(/\D/g,''); if(d.length<7) return p; return d.slice(0,3)+' *** **'+d.slice(-2); }
    function fillStars(avg){ const stars=[...document.querySelectorAll('#ratingBox .star')]; stars.forEach((s,i)=>{ s.classList.toggle('active', i < Math.round(avg||0)); }); }

    let __viewer=null;
    let __sellerId = qs('uid') || qs('seller') || '';
    if(!__sellerId){
      try{ __sellerId = (window.auth && window.auth.currentUser && window.auth.currentUser.uid) || ''; }catch{}
    }

    $('#btnBack').onclick=()=>{ history.length>1?history.back():location.href='./home.html'; };

    // ---------- SELLER Y√úKLE ----------
    async function loadSeller(){
      const { doc, getDoc } = await import('https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js');
      const ref = doc(window.__fb.db,'users',__sellerId);
      const snap = await getDoc(ref);
      if(!snap.exists()){ toast('Satƒ±cƒ± bulunamadƒ±'); return; }
      const u = snap.data()||{};

      // Ad Soyad
      const full = [
        (u.name || u.firstName || '').trim(),
        (u.surname || u.lastName || '').trim()
      ].filter(Boolean).join(' ') || (u.displayName || '‚Äî');

      $('#fullName').textContent = full;
      $('#avatar').style.backgroundImage = `url('${u.avatar||u.photoURL||'/assets/img/avatar-default.png'}')`;
      $('#city').textContent = u.province || u.city || u.sehir || '≈ûehir yok';
      $('#phone').textContent = maskPhone(u.phone || u.tel || u.phoneNumber);
      $('#bio').textContent = (u.bio || '').trim() || '‚Äî';

      // Onaylƒ± rozet
      const verified = !!(u.isVerified || u.verified || u.verifiedSeller);
      $('#verifiedBadge').style.display = verified ? 'inline-flex' : 'none';

      $('#btnMessage').onclick = ()=>{
        const p = new URLSearchParams({ peer: __sellerId, name: encodeURIComponent(full), ava: u.avatar||u.photoURL||'', order: '' });
        location.href = './mesajlar.html?'+p.toString();
      }
    }

    // ---------- Lƒ∞KE & RATING ----------
    async function refreshStats(){
      const { collection, query, where, getDocs } = await import('https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js');
      // Likes
      const likeQ = query(collection(window.__fb.db,'likes'), where('sellerId','==',__sellerId));
      const likeSnap = await getDocs(likeQ); const likeCount = likeSnap.size;
      // Ratings
      const rateQ = query(collection(window.__fb.db,'ratings'), where('sellerId','==',__sellerId));
      const rateSnap = await getDocs(rateQ);
      let sum=0, cnt=0; rateSnap.forEach(d=>{ const v=(d.data().stars||0); if(v>0){ sum+=v; cnt++; }});
      const avg = cnt? (sum/cnt) : 0;
      $('#stats').textContent = `${likeCount} beƒüeni ‚Ä¢ ${(avg?avg.toFixed(1):'‚Äî')}/5`;
      fillStars(avg);
      return { likeCount, avg };
    }

    async function ensureViewer(){ return new Promise((res)=>{ const { auth, onAuthStateChanged } = window.__fb; onAuthStateChanged(auth, (u)=>{ __viewer=u||null; res(u); }); }); }

    async function likeOnce(){
      if(!__viewer){ toast('Giri≈ü yapƒ±n'); return; }
      if(__viewer.uid===__sellerId){ toast('Kendi profilinizi beƒüenemezsiniz'); return; }
      const { doc, runTransaction, serverTimestamp, getDoc } = await import('https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js');
      const likeId = `${__sellerId}__${__viewer.uid}`;
      const ref = doc(window.__fb.db,'likes',likeId);
      try{
        // zaten beƒüenmi≈ü mi?
        const has = await getDoc(ref);
        if(has.exists()){ $('#btnLike').disabled=true; toast('Zaten beƒüendiniz'); return; }
        await runTransaction(window.__fb.db, async (tx)=>{
          const cur = await tx.get(ref);
          if(cur.exists()){ throw new Error('already'); }
          tx.set(ref, { sellerId:__sellerId, userId:__viewer.uid, createdAt:serverTimestamp() });
        });
        $('#btnLike').disabled = true;
        toast('‚ù§ Beƒüenildi');
        await refreshStats();
      }catch(e){ if(e && e.message==='already'){ $('#btnLike').disabled=true; toast('Zaten beƒüendiniz'); } else { console.warn(e); toast('Hata'); } }
    }

    function initStars(){
      const stars=[...document.querySelectorAll('#ratingBox .star')];
      stars.forEach(s=>{
        s.addEventListener('mouseenter',()=>{ const n=Number(s.dataset.s||0); stars.forEach((x,i)=>x.classList.toggle('active', i<n)); });
        s.addEventListener('mouseleave',()=>{ refreshStats(); });
        s.addEventListener('click', async ()=>{
          if(!__viewer){ toast('Giri≈ü yapƒ±n'); return; }
          if(__viewer.uid===__sellerId){ toast('Kendi profilinizi puanlayamazsƒ±nƒ±z'); return; }
          const n=Number(s.dataset.s||0);
          const ok=confirm(`${n} yƒ±ldƒ±z vermek istediƒüinize emin misiniz? Bu i≈ülem geri alƒ±namaz.`);
          if(!ok) return;
          const { doc, runTransaction, serverTimestamp, getDoc } = await import('https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js');
          const rid = `${__sellerId}__${__viewer.uid}`;
          const ref = doc(window.__fb.db,'ratings',rid);
          const exists = await getDoc(ref);
          if(exists.exists()){ toast('Daha √∂nce puan verdiniz'); return; }
          try{
            await runTransaction(window.__fb.db, async (tx)=>{
              const cur = await tx.get(ref);
              if(cur.exists()){ throw new Error('rated'); }
              tx.set(ref,{ sellerId:__sellerId, userId:__viewer.uid, stars:n, createdAt:serverTimestamp() });
            });
            toast('‚≠ê Puanlandƒ±');
            await refreshStats();
          }catch(e){ if(e && e.message==='rated'){ toast('Daha √∂nce puan verdiniz'); } else { console.warn(e); toast('Hata'); } }
        });
      });
    }

    async function precheckButtons(){
      if(!__viewer){ return; }
      const { doc, getDoc } = await import('https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js');
      const lid = `${__sellerId}__${__viewer.uid}`;
      const likeRef = doc(window.__fb.db,'likes',lid); const likeSnap = await getDoc(likeRef);
      if(likeSnap.exists()){ $('#btnLike').disabled = true; }
      const rateRef = doc(window.__fb.db,'ratings',lid); const rateSnap = await getDoc(rateRef);
      if(rateSnap.exists()){ fillStars((rateSnap.data()||{}).stars||0); }
    }

    // ---------- Lƒ∞STƒ∞NGS ----------
    async function loadListings(){
      const { collection, query, where, getDocs } = await import('https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js');
      const q = query(collection(window.__fb.db,'listings'), where('userId','==',__sellerId));
      const snap = await getDocs(q);
      const host = $('#listings'); host.innerHTML='';
      const arr = [];
      snap.forEach(ds=>{ const d = ds.data()||{}; arr.push({id:ds.id, d}); });
      arr.sort((a,b)=>{
        const ta = a.d.createdAt?.toMillis ? a.d.createdAt.toMillis() : (a.d.createdAt? new Date(a.d.createdAt).getTime():0);
        const tb = b.d.createdAt?.toMillis ? b.d.createdAt.toMillis() : (b.d.createdAt? new Date(b.d.createdAt).getTime():0);
        return (tb||0)-(ta||0);
      });
      arr.forEach(({id,d})=>{
        const card = document.createElement('div'); card.className='card'; card.setAttribute('role','button'); card.tabIndex=0;
        card.innerHTML = `
          <div class="img" style="background-image:url('${d.coverUrl||'/assets/img/avatar-default.png'}')"></div>
          <div class="body">
            <div style="font-weight:800;min-height:42px">${(d.title||'‚Äî')}</div>
            <div class="row" style="justify-content:space-between"><span class="mini">${d.province||''}</span><span class="price">${fmtTRY(d.price||0)}</span></div>
          </div>`;
        card.addEventListener('click', ()=> openDrawer(id, d));
        card.addEventListener('keydown', (ev)=>{ if(ev.key==='Enter') openDrawer(id,d); });
        host.appendChild(card);
      });
    }

    // ---------- DETAY √áEKMECESƒ∞ ----------
    const drawer = $('#drawer'), dCover=$('#dCover'), dThumbs=$('#dThumbs');
    const dTitle=$('#dTitle'), dSub=$('#dSub'), dPrice=$('#dPrice'), dStock=$('#dStock'), dLoc=$('#dLoc'), dDate=$('#dDate'), dDesc=$('#dDesc');
    $('#closeDrawer').onclick = ()=> drawer.style.display='none';
    drawer.addEventListener('click', (e)=>{ if(e.target===drawer) drawer.style.display='none'; });

    function openDrawer(id, d){
      dCover.style.backgroundImage = `url('${d.coverUrl||'/assets/img/avatar-default.png'}')`;
      dThumbs.innerHTML='';
      (d.photos||[]).forEach(url=>{
        const t=document.createElement('div'); t.className='t'; t.style.backgroundImage=`url('${url}')`;
        t.onclick=()=>{ dCover.style.backgroundImage=`url('${url}')`; };
        dThumbs.appendChild(t);
      });
      dTitle.textContent = d.title || '‚Äî';
      dSub.textContent   = `${d.category||''}${d.subcategory?(' ‚Ä¢ '+d.subcategory):''}`;
      dPrice.textContent = fmtTRY(d.price||0);
      dStock.textContent = (d.stock==='yok'?'Yok':'Var');
      dLoc.textContent   = `${d.province||''}${d.district?(' / '+d.district):''}`;
      dDate.textContent  = fmtDate(d.createdAt);
      dDesc.textContent  = d.description || '‚Äî';
      drawer.style.display='block';
    }

    // ---------- BOOT ----------
    async function boot(){
      if(!__sellerId){ toast('Satƒ±cƒ± ID yok'); return; }
      $('#btnLike').addEventListener('click', likeOnce);
      initStars();
      await ensureViewer();
      await loadSeller();
      await refreshStats();
      await precheckButtons();
      await loadListings();
    }

    (function init(){
      if(document.readyState==='loading'){ document.addEventListener('DOMContentLoaded', boot); } else { boot(); }
    })();
  </script>
</body>
</html>
