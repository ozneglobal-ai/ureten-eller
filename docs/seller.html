<!DOCTYPE html>
<html lang="tr" dir="ltr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Satıcı • Üreten Eller</title>
  <link rel="icon" href="/assets/icons/favicon.png" />
  <style>
    :root{
      --bg1:#0b1220; --bg2:#0a0f1c; --ink:#e5e7eb; --muted:#9ca3af; --accent:#22d3ee;
      --c1:#10b981; --c2:#f59e0b; --c3:#8b5cf6; --c4:#06b6d4; --c5:#ef4444; --c6:#eab308; --c7:#14b8a6; --c8:#f97316; --c9:#a855f7; --c10:#3b82f6;
      --brd:#1f2937; --card:#0e172a; --card2:#0b1326;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:radial-gradient(1200px 600px at 20% -10%,#10213f22,transparent),linear-gradient(180deg,var(--bg1),var(--bg2));color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,'Noto Sans',sans-serif;max-width:100%;overflow-x:hidden}
    a{color:inherit;text-decoration:none}
    .wrap{max-width:1280px;margin:0 auto;padding:1rem 1rem 4.5rem}

    .top{display:flex;align-items:center;gap:.75rem;flex-wrap:wrap}
    .logo{display:flex;align-items:center;gap:.5rem;font-weight:900;letter-spacing:.2px}
    .logo img{width:32px;height:32px}
    .spacer{flex:1}

    .btn{display:inline-flex;align-items:center;gap:.4rem;padding:.55rem .9rem;border:1px solid var(--brd);border-radius:12px;background:#0b1220;color:var(--ink);font-weight:800;cursor:pointer}
    .btn.ghost{background:transparent}

    .head{display:flex;align-items:center;justify-content:space-between;margin:1rem 0 .6rem}
    .head h2{margin:0;font-size:clamp(18px,2.2vw,24px)}
    .mini{color:var(--muted)}

    .page{display:grid;gap:1rem}
    @media(min-width:1080px){.page{grid-template-columns:2fr 1fr}}

    .card{position:relative;border:1px solid var(--brd);border-radius:16px;background:linear-gradient(145deg,var(--card),var(--card2));overflow:hidden;transition:box-shadow .25s,transform .15s}
    .card:hover{transform:translateY(-2px);box-shadow:0 0 0 1px var(--glow,#22d3ee),0 0 26px var(--glow,#22d3ee)}
    .thumb{aspect-ratio:1.2/1;background:#0f172a;display:block;background-size:cover;background-position:center}
    .meta{padding:.6rem .7rem 2.1rem}
    .title{font-weight:900}
    .badge{display:inline-flex;align-items:center;gap:.3rem;padding:.22rem .5rem;border-radius:999px;border:1px solid var(--brd);font-size:.78rem}
    .badge.star{background:linear-gradient(90deg,#f59e0b,#ef4444,#8b5cf6,#06b6d4);background-size:300% 100%;animation:shine 6s linear infinite;color:#0b1220;box-shadow:0 0 0 1px #ffffff1a,0 0 24px #06b6d470}
    @keyframes shine{0%{background-position:0 0}100%{background-position:300% 0}}

    .grid{display:grid;gap:.85rem;grid-template-columns:repeat(1,minmax(0,1fr))}
    @media(min-width:720px){.grid{grid-template-columns:repeat(2,1fr)}}
    @media(min-width:1120px){.grid{grid-template-columns:repeat(3,1fr)}}

    .row{display:flex;gap:.5rem;align-items:center;flex-wrap:wrap}
    .kv{display:flex;gap:.5rem;align-items:center}
    .kv label{width:120px;color:var(--muted)}
    .kv strong{font-weight:800}

    .avatarWrap{display:flex;gap:1rem;align-items:flex-start;flex-wrap:wrap}
    .avatar{width:96px;height:96px;border-radius:50%;background:#111827;border:1px solid var(--brd);background-size:cover;background-position:center}
    .bioBox{margin-top:.6rem;border:1px solid var(--brd);border-radius:12px;padding:.6rem;background:linear-gradient(145deg,var(--card),var(--card2))}
    .bioBox .bioTitle{font-weight:800;margin-bottom:.35rem}
    .bioBox .bioText{white-space:pre-wrap;line-height:1.45}

    .toast{position:fixed;left:50%;bottom:72px;transform:translateX(-50%);background:#0b1220;border:1px solid var(--brd);padding:.5rem .75rem;border-radius:10px;font-weight:800;z-index:1200;display:none}
  </style>
  <!-- docs/ altında çalıştığı için bağıl yol -->
  <script type="module" src="./firebase-init.js"></script>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="logo">
        <img src="./üreteneller.png" alt="logo" />
        <span>Üreten Eller</span>
      </div>
      <div class="spacer"></div>
      <button class="btn ghost" onclick="location.href='/docs/home.html'">Ana Sayfa</button>
    </div>

    <section class="head" aria-labelledby="pTitle">
      <h2 id="pTitle">Satıcı Profili</h2>
      <span class="mini" id="pSub">—</span>
    </section>

    <div class="page">
      <main>
        <section aria-labelledby="accTitle">
          <div class="avatarWrap">
            <div>
              <div id="avatar" class="avatar" style="background-image:url('/assets/img/avatar-default.png')"></div>
              <div class="mini" id="uBadges" style="margin-top:.35rem"></div>
              <div class="bioBox">
                <div class="bioTitle">Biyografi</div>
                <div id="uBio" class="bioText">—</div>
              </div>
            </div>
            <div>
              <div class="kv"><label>Ad Soyad</label><strong id="uName">—</strong></div>
              <div class="kv"><label>Şehir</label><strong id="uCity">—</strong></div>
              <div class="kv"><label>Telefon</label><strong id="uPhone">—</strong></div>
            </div>
          </div>
        </section>

        <section style="margin-top:1rem" aria-labelledby="listTitle">
          <div class="head"><h2 id="listTitle">Yayındaki İlanlar</h2><span class="mini" id="listCount"></span></div>
          <div id="listGrid" class="grid"></div>
        </section>
      </main>

      <aside>
        <section aria-labelledby="infoTitle">
          <div class="head"><h2 id="infoTitle">Bilgi</h2></div>
          <div class="card" style="padding:.8rem">
            <div class="row"><span>Doğrulama:</span><strong id="vStatus">—</strong></div>
            <div class="row" style="margin-top:.35rem"><span>Üyelik:</span><strong id="mStatus">—</strong></div>
          </div>
        </section>
      </aside>
    </div>

    <div id="toast" class="toast" role="status"></div>
  </div>

  <script>
  // === Yardımcılar ===
  const $ = (s)=>document.querySelector(s);
  function toast(msg){ const t=$('#toast'); if(!t) return; t.textContent=msg; t.style.display='block'; clearTimeout(window.__t); window.__t=setTimeout(()=>{t.style.display='none'},1800) }
  function fmtPrice(v){ try{ return new Intl.NumberFormat('tr-TR',{style:'currency',currency:'TRY',maximumFractionDigits:0}).format(v||0);}catch{ return (v||0)+' TL'; } }

  // Cloudinary yardımcıları (home.html ile uyumlu)
  const CLOUDINARY_CLOUD = window.CLOUDINARY_CLOUD || 'ozneglobal';
  function isHttpUrl(x){ return /^https?:\/\//i.test(x||''); }
  function isCloudinaryPublicId(x){ if(!x||isHttpUrl(x)) return false; return /[\/_.-]/.test(String(x)); }
  function toCloudinaryURL(publicId, {w, h, crop='fill', fmt='auto', q='auto'} = {}){
    if(!CLOUDINARY_CLOUD || !publicId) return '';
    const tr=[q&&`q_${q}`,fmt&&`f_${fmt}`,w&&`w_${w}`,h&&`h_${h}`,crop&&`c_${crop}`].filter(Boolean).join(',');
    const pid=String(publicId).replace(/^image\/upload\//,'');
    return `https://res.cloudinary.com/${CLOUDINARY_CLOUD}/image/upload/${tr?tr+'/':''}${pid}`;
  }
  async function resolveURL(raw, opts={}){
    if(!raw) return '';
    if(isHttpUrl(raw)) return raw;
    if(isCloudinaryPublicId(raw)) return toCloudinaryURL(raw, opts);
    try{
      if(window.storageRef && window._getDownloadURL){ const r=window.storageRef(raw); return await window._getDownloadURL(r); }
    }catch{}
    return raw;
  }

  function cardHTML(d,id){
    const title = d.title || d.name || 'İlan';
    const badge = (d.showcase===true||d.isShowcase===true||d.vitrin===true) ? '<span class="badge star">⭐ Vitrin</span>' : '';
    return `<a class="card" href="/ilan/${id}" style="--glow:#22d3ee">
      <span class="thumb" id="t-${id}"></span>
      <div class="meta">
        <div class="row" style="justify-content:space-between"><div class="title">${title}</div>${badge}</div>
      </div>
    </a>`;
  }

  function renderListings(arr){
    const grid = $('#listGrid'); if(!grid) return; grid.innerHTML='';
    if(!arr.length){ grid.innerHTML = '<div class="mini">Kayıt yok.</div>'; $('#listCount').textContent=''; return; }
    const frag=document.createDocumentFragment();
    arr.forEach(({id,data})=>{ const wrap=document.createElement('div'); wrap.innerHTML=cardHTML(data,id); frag.appendChild(wrap.firstElementChild); });
    grid.appendChild(frag);
    $('#listCount').textContent = `(${arr.length})`;

    // Kapakları çöz
    (async()=>{
      for(const it of arr){
        const photos=[];
        if(it.data.coverUrl) photos.push(it.data.coverUrl);
        if(it.data.cover) photos.push(it.data.cover);
        if(Array.isArray(it.data.photos)) photos.push(...it.data.photos);
        if(Array.isArray(it.data.images)){
          it.data.images.forEach(x=>{ if(!x) return; if(typeof x==='string') photos.push(x); else if(x.secure_url) photos.push(x.secure_url); else if(x.url) photos.push(x.url); else if(x.public_id) photos.push(x.public_id); });
        }
        const url = await resolveURL(photos[0]||'/assets/icons/ureteneller.png',{w:600,h:450,crop:'fill',fmt:'auto',q:'auto'});
        const el = document.getElementById('t-'+it.id); if(el){ el.classList.add('thumb'); el.style.backgroundImage=`url('${String(url).replace(/"/g,'')}')`; }
      }
    })();
  }

  async function boot(){
    try{
      const params=new URLSearchParams(location.search); const uid=params.get('uid');
      if(!uid){ document.body.innerHTML='<div style="padding:1rem">Satıcı bulunamadı (uid yok).</div>'; return; }

      // Eğer kullanıcı kendi uid'sini açarsa profil sayfasına yönlendir (opsiyonel)
      try{ const me=window.__fb?.auth?.currentUser; if(me && me.uid===uid){ location.replace('/docs/profile.html'); return; } }catch{}

      // Firebase hazır olmasını bekle
      const ensure=()=> new Promise((res)=>{ if(window.__fb?.db) return res(); document.addEventListener('fb-ready',res,{once:true}); });
      await ensure();

      const { doc, getDoc, collection, query, where, getDocs } = await import('https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js');
      const db = window.__fb.db;

      // Kullanıcıyı çek
      let u={};
      try{
        const snap=await getDoc(doc(db,'users',uid));
        if(snap.exists()) u = snap.data()||{};
      }catch(e){ console.warn('user read',e); }

      const name=u.name||u.displayName||'Satıcı';
      const city=u.city||u.district||'—';
      const phone=u.phone||'—'; // İsterseniz gizleyebilirsiniz
      const avatar=u.avatar||u.photoURL||'/assets/img/avatar-default.png';
      const verified = (u.isVerified===true) || (u.verified===true) || (u.role==='verified');
      const premium  = (u.isPremium===true) || (u.premium===true);

      $('#uName').textContent=name;
      $('#uCity').textContent=city;
      $('#uPhone').textContent=phone;
      $('#uBio').textContent=u.bio||'—';
      $('#avatar').style.backgroundImage=`url('${avatar}')`;
      $('#uBadges').innerHTML = `${verified? '✅ Onaylı Satıcı' : '👤 Standart Satıcı'} ${premium? ' • ⭐ Premium' : ''}`;
      $('#vStatus').textContent = verified? 'Onaylı' : 'Standart';
      $('#mStatus').textContent = premium? 'Premium' : 'Standart';
      $('#pSub').textContent = name;

      // İlanları çek (yayında olanlar)
      const baseCol = collection(db,'listings');
      const fields = ['sellerId','userId','ownerId','uid','createdBy'];
      const snaps = await Promise.all(fields.map(f=>getDocs(query(baseCol, where(f,'==', uid))).catch(()=>null)));
      const seen=new Set(); const arr=[];
      const isApproved=(d)=> (d.status==='approved' || d.status==='published' || d.isPublished===true);
      snaps.forEach(snap=>{ if(!snap) return; snap.forEach(ds=>{ if(seen.has(ds.id)) return; seen.add(ds.id); const d=ds.data()||{}; if(isApproved(d)) arr.push({id:ds.id,data:d}); }); });
      // Son yüklenenler önce
      arr.sort((a,b)=>{ const ta=(a.data.createdAt?.toMillis?.()||Date.parse(a.data.createdAt)||0); const tb=(b.data.createdAt?.toMillis?.()||Date.parse(b.data.createdAt)||0); return tb-ta; });
      renderListings(arr);

    }catch(e){ console.error(e); toast('Sayfa yüklenemedi'); }
  }

  if(document.readyState==='loading'){ document.addEventListener('DOMContentLoaded', boot); } else { boot(); }
  </script>
</body>
</html>
