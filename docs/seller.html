<!DOCTYPE html>
<html lang="tr" dir="ltr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Satıcı • Üreten Eller</title>
  <link rel="icon" href="./assets/icons/favicon.png" />
  <style>
    :root{ --bg1:#0b1220; --bg2:#0a0f1c; --ink:#e5e7eb; --muted:#9ca3af; --accent:#22d3ee; --ok:#10b981; --warn:#f59e0b; --err:#ef4444; --brd:#1f2937; --card:#0e172a; --card2:#0b1326 }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:radial-gradient(1200px 600px at 20% -10%,#10213f22,transparent),linear-gradient(180deg,var(--bg1),var(--bg2));color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,'Noto Sans',sans-serif;max-width:100%;overflow-x:hidden}
    a{color:inherit;text-decoration:none}

    .wrap{max-width:1100px;margin:0 auto;padding:1rem}
    .top{display:flex;align-items:center;gap:.75rem;flex-wrap:wrap}
    .logo{display:flex;align-items:center;gap:.5rem;font-weight:900}
    .logo img{width:32px;height:32px}
    .spacer{flex:1}
    .btn{display:inline-flex;align-items:center;gap:.45rem;padding:.55rem .9rem;border:1px solid var(--brd);border-radius:12px;background:#0b1220;color:var(--ink);font-weight:800;cursor:pointer}
    .btn.primary{background:linear-gradient(180deg,#10b981,#128473);border-color:#0e766e}
    .btn.warn{background:linear-gradient(180deg,#f59e0b,#7a5408);border-color:#7a5408}
    .btn.danger{background:linear-gradient(180deg,#ef4444,#7a1b1b);border-color:#7a1b1b}
    .btn.ghost{background:transparent}
    .mini{color:var(--muted)}

    .profile{margin-top:1rem;display:grid;grid-template-columns:160px 1fr;gap:16px;border:1px solid var(--brd);border-radius:16px;background:linear-gradient(145deg,var(--card),var(--card2));padding:12px}
    .ava{width:160px;height:160px;border-radius:16px;border:1px solid var(--brd);background:#111827;background-size:cover;background-position:center}
    .h1{font-size:1.35rem;font-weight:900}
    .row{display:flex;flex-wrap:wrap;gap:.5rem;align-items:center}
    .pill{display:inline-flex;align-items:center;gap:.35rem;padding:.25rem .6rem;border:1px solid var(--brd);border-radius:999px}
    .star{font-size:22px;line-height:1;cursor:pointer;opacity:.8}
    .star.active{opacity:1}

    .grid{margin-top:14px;display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px}
    .card{border:1px solid var(--brd);border-radius:14px;background:#0b1326;overflow:hidden}
    .card .img{width:100%;aspect-ratio:1/1;border-bottom:1px solid var(--brd);background:#111827;background-size:cover;background-position:center}
    .card .body{padding:10px}
    .price{font-weight:900}

    .toast{position:fixed;left:50%;bottom:80px;transform:translateX(-50%);background:#0b1220;border:1px solid var(--brd);padding:.5rem .75rem;border-radius:10px;font-weight:800;z-index:1200;display:none}
  </style>
  <script type="module" src="./firebase-init.js"></script>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="logo">
        <img src="./üreteneller.png" alt="logo" />
        <span>Üreten Eller</span>
      </div>
      <div class="spacer"></div>
      <button class="btn ghost" id="btnBack" type="button">← Geri</button>
    </div>

    <section class="profile">
      <div id="avatar" class="ava"></div>
      <div>
        <div class="h1"><span id="fullName">—</span></div>
        <div class="row mini" style="gap:.6rem;margin:.25rem 0 6px">
          <span id="city" class="pill">—</span>
          <span id="phone" class="pill">—</span>
        </div>
        <div class="row" style="gap:.6rem">
          <button id="btnMessage" class="btn warn">💬 Mesaj</button>
          <button id="btnLike" class="btn primary">❤ Beğen</button>
          <div class="pill" id="ratingBox" aria-label="Puan ver">
            <span class="star" data-s="1">★</span>
            <span class="star" data-s="2">★</span>
            <span class="star" data-s="3">★</span>
            <span class="star" data-s="4">★</span>
            <span class="star" data-s="5">★</span>
          </div>
          <span class="mini" id="stats">— beğeni • —/5</span>
        </div>
      </div>
    </section>

    <h2 style="margin:14px 2px 6px">İlanlar</h2>
    <section id="listings" class="grid"></section>
  </div>

  <div id="toast" class="toast" role="status"></div>

  <script>
    const $=(s)=>document.querySelector(s);
    const qs=(k)=>new URLSearchParams(location.search).get(k)||'';
    function toast(msg){ const el=$('#toast'); el.textContent=msg; el.style.display='block'; clearTimeout(window.__to); window.__to=setTimeout(()=>el.style.display='none',1600); }
    function fmtTRY(x){ try{ return new Intl.NumberFormat('tr-TR',{style:'currency',currency:'TRY',maximumFractionDigits:0}).format(x||0); }catch{ return (x||0)+' TL'; } }

    let __viewer=null; // oturumdaki kullanıcı
    let __sellerId = qs('uid') || qs('seller') || '';
    if(!__sellerId){ // profilimse parametre yoksa girişte kendi sayfam
      try{ __sellerId = (window.auth && window.auth.currentUser && window.auth.currentUser.uid) || ''; }catch{}
    }

    $('#btnBack').onclick=()=>{ history.length>1?history.back():location.href='./home.html'; };

    function maskPhone(p){ if(!p) return '—'; const d=(p+'').replace(/\D/g,''); if(d.length<7) return p; return d.slice(0,3)+' *** **'+d.slice(-2); }

    function fillStars(avg){ const stars=[...document.querySelectorAll('#ratingBox .star')]; stars.forEach((s,i)=>{ s.classList.toggle('active', i < Math.round(avg||0)); }); }

    async function loadSeller(){
      const { doc, getDoc } = await import('https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js');
      const ref = doc(window.__fb.db,'users',__sellerId);
      const snap = await getDoc(ref);
      if(!snap.exists()){ toast('Satıcı bulunamadı'); return; }
      const u = snap.data()||{};
      $('#avatar').style.backgroundImage = `url('${u.avatar||u.photoURL||'/assets/img/avatar-default.png'}')`;
      $('#fullName').textContent = (u.name||'') + (u.surname?(' '+u.surname): (u.lastName?(' '+u.lastName):''));
      $('#city').textContent = u.city || u.sehir || 'Şehir yok';
      $('#phone').textContent = maskPhone(u.phone || u.tel || u.phoneNumber);
      $('#btnMessage').onclick = ()=>{
        const p = new URLSearchParams({ peer: __sellerId, name: u.name||u.displayName||'Satıcı', ava: u.avatar||u.photoURL||'', order: '' });
        location.href = './mesajlar.html?'+p.toString();
      }
    }

    async function loadListings(){
      const { collection, query, where, getDocs } = await import('https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js');
      const q = query(collection(window.__fb.db,'listings'), where('userId','==',__sellerId));
      const snap = await getDocs(q);
      const host = $('#listings'); host.innerHTML='';
      const arr = [];
      snap.forEach(ds=>{ const d = ds.data()||{}; arr.push({id:ds.id, d}); });
      arr.sort((a,b)=>{
        const ta = a.d.createdAt?.toMillis ? a.d.createdAt.toMillis() : (a.d.createdAt? new Date(a.d.createdAt).getTime():0);
        const tb = b.d.createdAt?.toMillis ? b.d.createdAt.toMillis() : (b.d.createdAt? new Date(b.d.createdAt).getTime():0);
        return (tb||0)-(ta||0);
      });
      arr.forEach(({id,d})=>{
        const card = document.createElement('a'); card.className='card'; card.href = `./home.html#listing-${id}`; card.setAttribute('aria-label', d.title||'İlan');
        card.innerHTML = `
          <div class="img" style="background-image:url('${d.coverUrl||'/assets/img/avatar-default.png'}')"></div>
          <div class="body">
            <div style=\"font-weight:800;min-height:40px\">${(d.title||'—')}</div>
            <div class=\"row\" style=\"justify-content:space-between\"><span class=\"mini\">${d.province||''}</span><span class=\"price\">${fmtTRY(d.price||0)}</span></div>
          </div>`;
        host.appendChild(card);
      });
    }

    async function refreshStats(){
      const { collection, query, where, getDocs } = await import('https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js');
      // Likes
      const likeQ = query(collection(window.__fb.db,'likes'), where('sellerId','==',__sellerId));
      const likeSnap = await getDocs(likeQ); const likeCount = likeSnap.size;
      // Ratings
      const rateQ = query(collection(window.__fb.db,'ratings'), where('sellerId','==',__sellerId));
      const rateSnap = await getDocs(rateQ);
      let sum=0, cnt=0; rateSnap.forEach(d=>{ const v=(d.data().stars||0); if(v>0){ sum+=v; cnt++; }});
      const avg = cnt? (sum/cnt) : 0;
      $('#stats').textContent = `${likeCount} beğeni • ${(avg?avg.toFixed(1):'—')}/5`;
      fillStars(avg);
      return { likeCount, avg };
    }

    async function ensureViewer(){ return new Promise((res)=>{
      const { auth, onAuthStateChanged } = window.__fb; onAuthStateChanged(auth, (u)=>{ __viewer=u||null; res(u); });
    }); }

    async function likeOnce(){
      if(!__viewer){ toast('Giriş yapın'); return; }
      if(__viewer.uid===__sellerId){ toast('Kendi profilinizi beğenemezsiniz'); return; }
      const { doc, runTransaction, serverTimestamp } = await import('https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js');
      const likeId = `${__sellerId}__${__viewer.uid}`;
      const ref = doc(window.__fb.db,'likes',likeId);
      try{
        await runTransaction(window.__fb.db, async (tx)=>{
          const cur = await tx.get(ref);
          if(cur.exists()){ throw new Error('already'); }
          tx.set(ref, { sellerId:__sellerId, userId:__viewer.uid, createdAt:serverTimestamp() });
        });
        toast('❤ Beğenildi');
        $('#btnLike').disabled = true;
        await refreshStats();
      }catch(e){ if(e && e.message==='already'){ toast('Zaten beğendiniz'); $('#btnLike').disabled=true; } else { console.warn(e); toast('Hata'); } }
    }

    function initStars(){
      const stars=[...document.querySelectorAll('#ratingBox .star')];
      stars.forEach(s=>{
        s.addEventListener('mouseenter',()=>{ const n=Number(s.dataset.s||0); stars.forEach((x,i)=>x.classList.toggle('active', i<n)); });
        s.addEventListener('mouseleave',()=>{ refreshStats(); });
        s.addEventListener('click', async ()=>{
          if(!__viewer){ toast('Giriş yapın'); return; }
          if(__viewer.uid===__sellerId){ toast('Kendi profilinizi puanlayamazsınız'); return; }
          const n=Number(s.dataset.s||0);
          const ok=confirm(`${n} yıldız vermek istediğinize emin misiniz? Bu işlem geri alınamaz.`);
          if(!ok) return;
          const { doc, runTransaction, serverTimestamp } = await import('https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js');
          const rid = `${__sellerId}__${__viewer.uid}`;
          const ref = doc(window.__fb.db,'ratings',rid);
          try{
            await runTransaction(window.__fb.db, async (tx)=>{
              const cur = await tx.get(ref);
              if(cur.exists()){ throw new Error('rated'); }
              tx.set(ref,{ sellerId:__sellerId, userId:__viewer.uid, stars:n, createdAt:serverTimestamp() });
            });
            toast('⭐ Puanlandı');
            await refreshStats();
          }catch(e){ if(e && e.message==='rated'){ toast('Daha önce puan verdiniz'); } else { console.warn(e); toast('Hata'); } }
        });
      });
    }

    async function precheckButtons(){
      if(!__viewer){ return; }
      const { doc, getDoc } = await import('https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js');
      const lid = `${__sellerId}__${__viewer.uid}`;
      const likeRef = doc(window.__fb.db,'likes',lid); const likeSnap = await getDoc(likeRef);
      if(likeSnap.exists()){ $('#btnLike').disabled = true; }
      const rateRef = doc(window.__fb.db,'ratings',lid); const rateSnap = await getDoc(rateRef);
      if(rateSnap.exists()){ fillStars((rateSnap.data()||{}).stars||0); }
    }

    async function boot(){
      if(!__sellerId){ toast('Satıcı ID yok'); return; }
      $('#btnLike').addEventListener('click', likeOnce);
      initStars();
      await ensureViewer();
      await loadSeller();
      await loadListings();
      await refreshStats();
      await precheckButtons();
    }

    (function init(){
      if(document.readyState==='loading'){ document.addEventListener('DOMContentLoaded', boot); } else { boot(); }
    })();
  </script>
</body>
</html>
