<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Ödeme</title>
  <style>
    body{font-family:system-ui,Arial;margin:20px}
    .err{background:#fee2e2;color:#7f1d1d;padding:12px;border-radius:8px;border:1px solid #fecaca}
  </style>
</head>
<body>
  <h2>Ödeme</h2>
  <p id="sum"></p>
  <div id="iframe-container">Yükleniyor…</div>

  <script>
  // URL: /odeme/paytr.html?oid=PREM-xxx&amount=1999&email=mail@ornek.com
  const p = new URLSearchParams(location.search);
  const oid    = p.get('oid')    || ("TEST_"+Date.now());
  const amount = parseInt(p.get('amount')||"0",10) || 100; // kuruş değil TL ise çevirmeyelim
  const email  = p.get('email')  || "test@ureteneller.com";

  // PayTR amount kuruş ister -> 1999 TL ise 199900 kuruş yap
  const amountKurush = amount >= 1000 ? amount*100 : amount*100; // sen zaten 1999 gönderiyorsun -> 199900

  document.getElementById('sum').textContent =
    "Sipariş: " + oid + " • Tutar: " + (amountKurush/100) + " TL • E-posta: " + email;

  const TOKEN_ENDPOINT = "/api/token.php"; // aynı domain

  async function startPayment(){
    try{
      const res = await fetch(TOKEN_ENDPOINT, {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({
          merchant_oid: oid,
          email: email,
          payment_amount: amountKurush, // kuruş
          user_name: "Müşteri",
          user_address: "Adres",
          user_phone: "000",
          test_mode: 1
        })
      });

      const data = await res.json();

      if (data.status === "success" && data.token) {
        document.getElementById("iframe-container").innerHTML =
          `<iframe src="https://www.paytr.com/odeme/guvenli/${data.token}"
            frameborder="0" scrolling="no" style="width:100%;height:700px;border:none"></iframe>`;
      } else {
        document.getElementById("iframe-container").innerHTML =
          "<div class='err'>Hata: " + (data.reason || "Bilinmeyen hata") + "</div>";
      }
    } catch (e) {
      document.getElementById("iframe-container").innerHTML =
        "<div class='err'>İstek başarısız: " + e.message + "</div>";
    }
  }
  startPayment();
  </script>
</body>
</html>
